@page
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Identity
@using StandoffPortfolioTracker.AdminPanel.Areas.Identity.Pages.Account.Manage
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model ExternalLoginsModel
@{
    ViewData["Title"] = "Привязка соцсетей";
    Layout = "/Areas/Identity/Pages/_AuthLayout.cshtml"; // 👈 Подключаем шаблон
}

<div class="auth-header">
    <div class="auth-icon-wrapper">
        <i class="bi bi-link-45deg"></i>
    </div>
    <h1 class="auth-title">Привязка</h1>
    <p class="auth-subtitle">Управление входом через соцсети</p>
</div>

<div class="auth-body">

    @if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        var isError = Model.StatusMessage.StartsWith("Ошибка");
        <div class="alert @(isError ? "alert-danger" : "alert-success") d-flex align-items-center mb-4 rounded-3 small border-0 shadow-sm" role="alert">
            <i class="bi @(isError ? "bi-exclamation-triangle-fill" : "bi-check-circle-fill") me-2 fs-5"></i>
            <div>@Model.StatusMessage</div>
        </div>
    }

    @if (Model.CurrentLogins?.Count > 0)
    {
        <h6 class="fw-bold mb-3 ps-1 small text-uppercase text-muted" style="letter-spacing: 1px;">Подключено</h6>
        <div class="d-grid gap-2 mb-4">
            @foreach (var login in Model.CurrentLogins)
            {
                <div class="p-3 border rounded-4 d-flex align-items-center justify-content-between" style="background: #f8fafc; border-color: #e2e8f0;">
                    <div class="d-flex align-items-center gap-3">
                        @if (login.LoginProvider == "Google")
                        {
                            <i class="bi bi-google text-danger fs-4"></i>
                        }
                        else
                        {
                            <i class="bi bi-shield-lock-fill text-secondary fs-4"></i>
                        }

                        <div>
                            <div class="fw-bold text-dark">@login.ProviderDisplayName</div>
                            <small class="text-success fw-bold" style="font-size: 0.75rem;">● Активен</small>
                        </div>
                    </div>

                    @if (Model.ShowRemoveButton)
                    {
                        <form id="remove-login-@login.LoginProvider" asp-page-handler="RemoveLogin" method="post">
                            <input type="hidden" name="loginProvider" value="@login.LoginProvider" />
                            <input type="hidden" name="providerKey" value="@login.ProviderKey" />
                            <button type="submit" class="btn btn-sm btn-white border text-danger rounded-pill px-3 fw-bold shadow-sm" title="Отвязать">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    }
                    else
                    {
                        <span class="badge bg-secondary opacity-50 rounded-pill">Основной</span>
                    }
                </div>
            }
        </div>
    }

    @if (Model.CurrentLogins?.Count > 0 && Model.OtherLogins?.Count > 0)
    {
        <div class="auth-divider">Добавить</div>
    }

    @if (Model.OtherLogins?.Count > 0)
    {
        <form id="link-login-form" asp-page-handler="LinkLogin" method="post" class="form-horizontal">
            <div id="socialLoginList">
                @foreach (var provider in Model.OtherLogins)
                {
                    <button type="submit" class="btn-google mb-3 w-100 shadow-sm" name="provider" value="@provider.Name">
                        @if (provider.Name == "Google")
                        {
                            <i class="bi bi-google text-danger fs-5"></i>
                        }
                        else
                        {
                            <i class="bi bi-box-arrow-in-right text-primary fs-5"></i>
                        }
                        <span>Подключить @provider.DisplayName</span>
                    </button>
                }
            </div>
        </form>
    }

    <div class="text-center mt-4">
        <a href="/settings" class="auth-link small text-decoration-none">
            <i class="bi bi-arrow-left me-1"></i> Вернуться в настройки
        </a>
    </div>
</div>