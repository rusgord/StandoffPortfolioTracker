@page "/profile/{UserId}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using StandoffPortfolioTracker.Core.Entities
@using StandoffPortfolioTracker.Core.Enums
@using StandoffPortfolioTracker.AdminPanel.Services
@using System.Security.Claims
@using Microsoft.Extensions.DependencyInjection
@inject IServiceScopeFactory ScopeFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@rendermode InteractiveServer

<style>
    /* === ОБЩИЕ СТИЛИ === */
    .profile-container {
        max-width: 1100px;
        margin: 0 auto;
    }

    .text-gold {
        color: #FFD700 !important;
        font-weight: 800;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* === ШАПКА === */
    .profile-cover {
        height: 160px;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        border-radius: 16px 16px 0 0;
        position: relative;
    }

    .profile-avatar-wrapper {
        position: absolute;
        bottom: -50px;
        left: 40px;
        padding: 4px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        background-color: #f8f9fa;
    }

    .profile-info-bar {
        padding: 60px 40px 25px 40px;
        background: white;
        border-radius: 0 0 16px 16px;
        margin-bottom: 25px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.03);
    }

    /* === КАРТОЧКИ СТАТИСТИКИ (ПОЛУМЕСЯЦ) === */
    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        border: 1px solid #f1f5f9;
        height: 100%;
        position: relative;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.06);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 60%;
            border-radius: 0 8px 8px 0;
            background-color: var(--accent-color, #cbd5e1);
        }

    .card-gold {
        --accent-color: #FFD700;
    }

    .card-green {
        --accent-color: #10b981;
    }

    .stat-label {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #64748b;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 800;
        color: #0f172a;
        line-height: 1.1;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .bg-icon-gold {
        background: rgba(255, 215, 0, 0.15);
        color: #b49600;
    }

    .bg-icon-green {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }

    /* === ТОП АКТИВЫ (ITEM CARDS) === */
    .item-card {
        background: white;
        border-radius: 12px;
        padding: 12px;
        border: 1px solid #f1f5f9;
        position: relative;
        overflow: hidden;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    }

        .item-card:hover {
            border-color: #e2e8f0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

    /* Полоска редкости */
    .rarity-strip {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
    }

    .rarity-common {
        background-color: #b0c3d9;
    }

    .rarity-uncommon {
        background-color: #5e98d9;
    }

    .rarity-rare {
        background-color: #4b69ff;
    }

    .rarity-epic {
        background-color: #8847ff;
    }

    .rarity-legendary {
        background-color: #d32ce6;
    }

    .rarity-arcane {
        background-color: #eb4b4b;
    }

    .rarity-unknown {
        background-color: #cbd5e1;
    }

    .item-img-box {
        width: 55px;
        height: 55px;
        background: #f8fafc;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
        position: relative;
    }

        .item-img-box img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

    .item-info {
        flex-grow: 1;
        min-width: 0;
        line-height: 1.2;
    }

    .weapon-name {
        font-size: 0.7rem;
        color: #94a3b8;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .skin-name {
        font-weight: 700;
        color: #334155;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Бейдж StatTrak */
    .st-badge {
        font-size: 0.6rem;
        background: linear-gradient(45deg, #FF8008, #FFC837);
        color: white;
        padding: 1px 4px;
        border-radius: 4px;
        margin-left: 6px;
        font-weight: 800;
        letter-spacing: 0.5px;
        vertical-align: middle;
        box-shadow: 0 2px 4px rgba(255, 165, 0, 0.3);
    }

    .item-values {
        text-align: right;
        flex-shrink: 0;
        margin-left: 10px;
    }

    .item-price {
        font-weight: 800;
        font-size: 1rem;
        color: #0f172a;
    }

    /* ROI (Прибыль) */
    .item-roi {
        font-size: 0.7rem;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
    }

    .roi-plus {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .roi-minus {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
</style>

<div class="container-fluid profile-container">
    @if (isLoading)
    {
        <div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>
    }
    else if (targetUser == null)
    {
        <div class="alert alert-danger shadow-sm border-0 rounded-3">🚫 Пользователь не найден.</div>
    }
    else if (!targetUser.IsProfilePublic && !IsOwner)
    {
        <div class="text-center mt-5 py-5 bg-white rounded-4 shadow-sm">
            <i class="bi bi-lock-fill display-1 text-muted opacity-25"></i>
            <h3 class="mt-3 text-secondary">Этот профиль скрыт</h3>
        </div>
    }
    else
    {
        <div>
            <div class="profile-cover">
                <div class="profile-avatar-wrapper">
                    <img src="@(string.IsNullOrEmpty(targetUser.AvatarUrl) ? "/images/default-avatar.png" : targetUser.AvatarUrl)" class="profile-avatar" />
                </div>
            </div>

            <div class="profile-info-bar d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div style="padding-left: 10px;">
                    <h2 class="fw-bold mb-1 text-dark d-flex align-items-center gap-2">
                        @(string.IsNullOrEmpty(targetUser.DisplayName) ? targetUser.UserName : targetUser.DisplayName)
                        @if (userRoles.Contains("Admin"))
                        {
                            <i class="bi bi-patch-check-fill text-primary fs-5" title="Admin"></i>
                        }
                    </h2>
                    @if (IsOwner)
                    {
                        <div class="text-muted small mb-2">@targetUser.UserName</div>
                    }
                    <div class="d-flex gap-4 text-secondary small mt-2">
                        <span><i class="bi bi-calendar3 me-1"></i> На проекте с @targetUser.JoinDate.ToShortDateString()</span>
                    </div>
                </div>
                @if (IsOwner)
                {
                    <a href="settings" class="btn btn-outline-primary px-4 rounded-pill fw-bold"><i class="bi bi-gear-fill me-1"></i> Настройки</a>
                }
            </div>
        </div>

        <div class="row g-4 mb-5">
            @if (targetUser.ShowPortfolioValue || IsOwner)
            {
                <div class="col-md-6">
                    <div class="stat-card card-gold">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="stat-label">Стоимость Портфеля</div>
                                <div class="stat-value">
                                    @portfolioValue.ToString("N0") <span class="text-gold">G</span>
                                </div>
                            </div>
                            <div class="stat-icon bg-icon-gold"><i class="bi bi-wallet2"></i></div>
                        </div>
                        @if (targetUser.PortfolioGoal > 0)
                        {
                            <div class="mt-4">
                                <div class="d-flex justify-content-between small mb-1 fw-bold text-secondary">
                                    <span>Цель: @targetUser.PortfolioGoal.ToString("N0") <span class="text-gold">G</span></span>
                                    <span>@((portfolioValue / targetUser.PortfolioGoal * 100).ToString("N0"))%</span>
                                </div>
                                <div class="progress bg-light" style="height: 6px;">
                                    <div class="progress-bar bg-warning" style="width: @(Math.Min(100, (portfolioValue/targetUser.PortfolioGoal)*100))%"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (targetUser.ShowTopItems || IsOwner)
            {
                <div class="col-md-6">
                    <div class="stat-card card-green">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="stat-label">Лучший Актив</div>
                                @if (topItems.Any())
                                {
                                    var best = topItems.First();
                                    <div class="stat-value">@best.CurrentValue.ToString("N0") <span class="text-gold">G</span></div>
                                    <div class="small text-muted mt-1 text-truncate fw-bold">@best.SkinName</div>
                                }
                                else
                                {
                                    <div class="stat-value text-muted">-</div>
                                }
                            </div>
                            <div class="stat-icon bg-icon-green"><i class="bi bi-trophy"></i></div>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (targetUser.ShowTopItems || IsOwner)
        {
            <div class="mb-3 d-flex align-items-center gap-2">
                <i class="bi bi-star-fill text-warning"></i>
                <h5 class="fw-bold text-dark m-0">Топ Активы</h5>
            </div>

            <div class="row g-3">
                @if (topItems.Any())
                {
                    @foreach (var item in topItems)
                    {
                        <div class="col-lg-4 col-md-6">
                            <div class="item-card">
                                <div class="rarity-strip @GetRarityClass(item.Rarity)"></div>

                                <div class="item-img-box position-relative">
                                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                                    {
                                        <img src="@item.ImageUrl" />
                                    }

                                    @if (item.IsStatTrack)
                                    {
                                        <span class="position-absolute top-0 end-0 badge bg-warning text-dark border border-light rounded-pill m-1 py-0 px-1"
                                              style="font-size: 0.6rem; font-weight: 800; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                            ST
                                        </span>
                                    }
                                </div>

                                <div class="item-info overflow-hidden">
                                    <div class="item-name text-uppercase text-muted" style="font-size: 0.7rem; letter-spacing: 0.5px;">
                                        @item.Name
                                    </div>

                                    <div class="fw-bold text-dark text-truncate" style="font-size: 0.95rem;" title="@item.SkinName">
                                        @(string.IsNullOrEmpty(item.SkinName) ? item.Name : item.SkinName)
                                    </div>

                                    <div class="mt-1">
                                        @if (item.RoiPercent >= 0)
                                        {
                                            <span class="item-roi roi-plus">
                                                <i class="bi bi-graph-up-arrow me-1"></i>+@item.RoiPercent.ToString("N1")%
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="item-roi roi-minus">
                                                <i class="bi bi-graph-down-arrow me-1"></i>@item.RoiPercent.ToString("N1")%
                                            </span>
                                        }
                                    </div>
                                </div>

                                <div class="item-values">
                                    <div class="item-price">@item.CurrentValue.ToString("N0") <span class="text-gold" style="font-size:0.8em">G</span></div>
                                    <div class="text-muted small" style="font-size: 0.7rem;">Total</div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 text-center py-5 text-muted bg-light rounded-4">
                        Инвентарь пуст.
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    [Parameter] public string UserId { get; set; }

    private ApplicationUser? targetUser;
    private bool isLoading = true;
    private bool IsOwner = false;
    private IList<string> userRoles = new List<string>();
    private decimal portfolioValue;

    // DTO с разделением названия
    class TopItemDto
    {
        public string Name { get; set; }
        public string SkinName { get; set; } // <--- Добавили
        public bool IsStatTrack { get; set; } // <--- Добавили
        public string ImageUrl { get; set; }
        public decimal CurrentValue { get; set; }
        public decimal Invested { get; set; }
        public ItemRarity Rarity { get; set; }
        public decimal RoiPercent => Invested > 0 ? ((CurrentValue - Invested) / Invested) * 100 : 0;
    }

    private List<TopItemDto> topItems = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        IsOwner = (currentUserId == UserId);

        using (var scope = ScopeFactory.CreateScope())
        {
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>();
            var portfolioService = scope.ServiceProvider.GetRequiredService<PortfolioService>();

            targetUser = await userManager.FindByIdAsync(UserId);

            if (targetUser != null)
            {
                userRoles = await userManager.GetRolesAsync(targetUser);
                if (targetUser.IsProfilePublic || IsOwner)
                {
                    await LoadStatsInternal(portfolioService);
                }
            }
        }
        isLoading = false;
    }

    private async Task LoadStatsInternal(PortfolioService portfolioService)
    {
        var portfolios = await portfolioService.GetPortfoliosByUserAsync(UserId);

        if (portfolios.Any())
        {
            var allItems = new List<InventoryItem>();
            foreach (var p in portfolios)
            {
                var items = await portfolioService.GetInventoryAsync(p.Id);
                allItems.AddRange(items);
            }

            portfolioValue = allItems.Sum(i => (i.ItemBase?.CurrentMarketPrice ?? 0) * 0.8m * i.Quantity);

            topItems = allItems.Where(i => i.ItemBase != null)
            .GroupBy(i => i.ItemBase)
            .Select(g => new TopItemDto
                {
                    Name = g.Key.Name,
                    SkinName = g.Key.SkinName,     // <--- Заполняем
                    IsStatTrack = g.Key.IsStatTrack, // <--- Заполняем
                    ImageUrl = g.Key.ImageUrl,
                    Rarity = g.Key.Rarity,
                    CurrentValue = g.Sum(x => (x.ItemBase.CurrentMarketPrice * 0.8m) * x.Quantity),
                    Invested = g.Sum(x => x.PurchasePrice * x.Quantity)
                })
            .OrderByDescending(x => x.CurrentValue)
            .Take(6)
            .ToList();
            }
    }

    private string GetRarityClass(ItemRarity rarity)
    {
        return rarity switch
        {
            ItemRarity.Common => "rarity-common",
            ItemRarity.Uncommon => "rarity-uncommon",
            ItemRarity.Rare => "rarity-rare",
            ItemRarity.Epic => "rarity-epic",
            ItemRarity.Legendary => "rarity-legendary",
            ItemRarity.Arcane => "rarity-arcane",
            _ => "rarity-unknown"
        };
    }
}