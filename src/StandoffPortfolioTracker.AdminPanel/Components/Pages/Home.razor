@page "/"
@using StandoffPortfolioTracker.Core.Entities
@using StandoffPortfolioTracker.AdminPanel.Services
@using Microsoft.EntityFrameworkCore
@inject PortfolioService PortfolioService
@inject IDbContextFactory<StandoffPortfolioTracker.Infrastructure.AppDbContext> DbFactory
@rendermode InteractiveServer

<PageTitle>Главная | Standoff Tracker</PageTitle>

<div class="container-fluid p-0">
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="h3 mb-0 text-gray-800">📊 Дашборд Инвестора</h1>
            <p class="text-muted small mb-0">Обзор основного портфеля</p>
        </div>
        <div class="col-auto">
            <a href="portfolio" class="btn btn-sm btn-primary shadow-sm">
                ➕ Перейти в портфель
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2 border-primary border-3 border-top-0 border-bottom-0 border-end-0">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Вложено средств</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@totalInvested.ToString("N0") G</div>
                        </div>
                        <div class="col-auto"><span class="fs-2">💰</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100 py-2 border-info border-3 border-top-0 border-bottom-0 border-end-0">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Стоимость (чистыми)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@currentValue.ToString("N0") G</div>
                        </div>
                        <div class="col-auto"><span class="fs-2">🏦</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100 py-2 @(totalProfit >= 0 ? "border-success" : "border-danger") border-3 border-top-0 border-bottom-0 border-end-0">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold @(totalProfit >= 0 ? "text-success" : "text-danger") text-uppercase mb-1">Чистый Профит</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@(totalProfit > 0 ? "+" : "")@totalProfit.ToString("N0") G</div>
                        </div>
                        <div class="col-auto"><span class="fs-2">📈</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100 py-2 border-warning border-3 border-top-0 border-bottom-0 border-end-0">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">ROI (Окупаемость)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@roi.ToString("N1")%</div>
                        </div>
                        <div class="col-auto"><span class="fs-2">🚀</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">📉 Динамика стоимости портфеля (30 дней)</h6>
                </div>
                <div class="card-body">
                    @if (chartData.Any())
                    {
                        <ApexChart TItem="PortfolioHistoryPoint"
                                   Title=""
                                   Options="chartOptions"
                                   Height="350">

                            <ApexPointSeries TItem="PortfolioHistoryPoint"
                                             Items="chartData"
                                             Name="Стоимость (G)"
                                             SeriesType="SeriesType.Area"
                                             XValue="@(e => e.Date.ToString("dd.MM"))"
                                             YValue="@(e => (decimal)e.Value)" />
                        </ApexChart>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            Недостаточно исторических данных для построения графика.
                            <br />
                            <small>Обновите цены несколько раз в разные дни, чтобы появилась история.</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">💎 Лучшие активы (Топ 3)</h6>
                </div>
                <div class="card-body">
                    @if (topItems.Any())
                    {
                        @foreach (var item in topItems)
                        {
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="d-flex align-items-center gap-3">
                                    <div style="width: 50px; height: 50px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px solid #dee2e6;">
                                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                                        {
                                            <img src="@item.ImageUrl" style="max-width: 100%; max-height: 100%;" referrerpolicy="no-referrer" />
                                        }
                                        else
                                        {
                                            <span>?</span>
                                        }
                                    </div>
                                    <div>
                                        <div class="fw-bold">
                                            @if (item.IsStatTrack)
                                            {
                                                <span class="badge bg-warning text-dark me-1" style="font-size: 0.6em;">ST</span>
                                            }
                                            @if (item.IsPattern)
                                            {
                                                <span class="badge bg-info text-white me-1" style="font-size: 0.6em;">P</span>
                                            }
                                            @item.Name
                                        </div>
                                        <div class="text-muted small">@item.Skin</div>
                                        <div class="small text-success fw-bold">Профит: +@item.Profit.ToString("N0") G</div>
                                    </div>
                                </div>
                                <span class="badge bg-success rounded-pill fs-6">+@item.Roi.ToString("N0")%</span>
                            </div>
                            @if (item != topItems.Last())
                            {
                                <hr class="my-1" />
                            }
                        }
                    }
                    else
                    {
                        <p class="text-muted">Нет данных</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-danger">🔻 Худшие активы (Топ 3)</h6>
                </div>
                <div class="card-body">
                    @if (worstItems.Any())
                    {
                        @foreach (var item in worstItems)
                        {
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="d-flex align-items-center gap-3">
                                    <div style="width: 50px; height: 50px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px solid #dee2e6;">
                                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                                        {
                                            <img src="@item.ImageUrl" style="max-width: 100%; max-height: 100%;" referrerpolicy="no-referrer" />
                                        }
                                        else
                                        {
                                            <span>?</span>
                                        }
                                    </div>
                                    <div>
                                        <div class="fw-bold">
                                            @if (item.IsStatTrack)
                                            {
                                                <span class="badge bg-warning text-dark me-1" style="font-size: 0.6em;">ST</span>
                                            }
                                            @if (item.IsPattern)
                                            {
                                                <span class="badge bg-info text-white me-1" style="font-size: 0.6em;">P</span>
                                            }
                                            @item.Name
                                        </div>
                                        <div class="text-muted small">@item.Skin</div>
                                        <div class="small text-danger fw-bold">Убыток: @item.Profit.ToString("N0") G</div>
                                    </div>
                                </div>
                                <span class="badge bg-danger rounded-pill fs-6">@item.Roi.ToString("N0")%</span>
                            </div>
                            @if (item != worstItems.Last())
                            {
                                <hr class="my-1" />
                            }
                        }
                    }
                    else
                    {
                        <p class="text-muted">Нет убыточных позиций! 🎉</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Данные для карточек
    private decimal totalInvested = 0;
    private decimal currentValue = 0;
    private decimal totalProfit = 0;
    private decimal roi = 0;

    // Класс для списков
    class AssetStat
    {
        public string Name { get; set; }
        public string Skin { get; set; }
        public string ImageUrl { get; set; }
        public decimal Profit { get; set; }
        public decimal Roi { get; set; }

        // 👇 Добавлены новые поля
        public bool IsStatTrack { get; set; }
        public bool IsPattern { get; set; }
    }

    private List<AssetStat> topItems = new();
    private List<AssetStat> worstItems = new();

    // Данные для графика
    public class PortfolioHistoryPoint { public DateTime Date { get; set; } public decimal Value { get; set; } }
    private List<PortfolioHistoryPoint> chartData = new();
    private ApexChartOptions<PortfolioHistoryPoint> chartOptions = new();

    protected override async Task OnInitializedAsync()
    {
        SetupChart();

        var inventory = await PortfolioService.GetInventoryAsync(1); // TODO: Сделать выбор портфеля

        if (inventory.Any())
        {
            // === РАСЧЕТ КАРТОЧЕК ===
            totalInvested = inventory.Sum(i => i.PurchasePrice * i.Quantity);
            currentValue = inventory.Sum(i => (i.ItemBase?.CurrentMarketPrice ?? 0) * 0.8m * i.Quantity);
            totalProfit = currentValue - totalInvested;
            roi = totalInvested > 0 ? (totalProfit / totalInvested) * 100 : 0;

            // === РАСЧЕТ СПИСКОВ ===
            var stats = inventory.Select(i =>
            {
                var itemInvest = i.PurchasePrice * i.Quantity;
                var itemValue = (i.ItemBase?.CurrentMarketPrice ?? 0) * 0.8m * i.Quantity;
                var itemProfit = itemValue - itemInvest;
                var itemRoi = itemInvest > 0 ? (itemProfit / itemInvest) * 100 : 0;

                return new AssetStat
                    {
                        Name = i.ItemBase?.Name ?? "?",
                        Skin = i.ItemBase?.SkinName ?? "",
                        ImageUrl = i.ItemBase?.ImageUrl,
                        Profit = itemProfit,
                        Roi = itemRoi,

                    // 👇 Заполняем данные о ST/Pattern
                        IsStatTrack = i.ItemBase?.IsStatTrack ?? false,
                        IsPattern = i.ItemBase?.IsPattern ?? false
                    };
            }).ToList();

            topItems = stats.OrderByDescending(s => s.Profit).Take(3).ToList();
            worstItems = stats.Where(s => s.Profit < 0).OrderBy(s => s.Profit).Take(3).ToList();

            await LoadChartData(inventory);
        }
    }

    private void SetupChart()
    {
        chartOptions = new ApexChartOptions<PortfolioHistoryPoint>
            {
                Chart = new Chart
                {
                    Toolbar = new Toolbar { Show = false },
                    Zoom = new Zoom { Enabled = false }
                },
                Colors = new List<string> { "#4e73df" },
                Stroke = new Stroke { Curve = Curve.Smooth, Width = 3 },
                DataLabels = new DataLabels { Enabled = false },
                Yaxis = new List<YAxis>
            {
                new YAxis
                {
                    Labels = new YAxisLabels
                    {
                        Formatter = @"function (value) { return value.toFixed(0) + ' G'; }"
                    }
                }
            },
                Tooltip = new Tooltip { X = new TooltipX { Format = "dd MMM yyyy" } }
            };
    }

    private async Task LoadChartData(List<InventoryItem> inventory)
    {
        using var context = await DbFactory.CreateDbContextAsync();

        var itemIds = inventory.Select(i => i.ItemBaseId).Distinct().ToList();

        var history = await context.MarketHistory
            .Where(h => itemIds.Contains(h.ItemBaseId) && h.RecordedAt >= DateTime.UtcNow.AddDays(-30))
            .ToListAsync();

        if (!history.Any()) return;

        var dates = history.Select(h => h.RecordedAt.Date).Distinct().OrderBy(d => d).ToList();

        chartData = new List<PortfolioHistoryPoint>();

        foreach (var date in dates)
        {
            decimal dailyTotalValue = 0;

            foreach (var invItem in inventory)
            {
                var priceRecord = history
                    .Where(h => h.ItemBaseId == invItem.ItemBaseId && h.RecordedAt.Date == date)
                    .OrderByDescending(h => h.RecordedAt)
                    .FirstOrDefault();

                if (priceRecord != null)
                {
                    dailyTotalValue += (priceRecord.Price * 0.8m * invItem.Quantity);
                }
            }

            if (dailyTotalValue > 0)
            {
                chartData.Add(new PortfolioHistoryPoint { Date = date, Value = dailyTotalValue });
            }
        }
    }
}