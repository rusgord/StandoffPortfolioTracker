@page "/news"
@using StandoffPortfolioTracker.Core.Entities
@using StandoffPortfolioTracker.AdminPanel.Services
@inject NewsService NewsService
@inject NavigationManager Nav
@rendermode InteractiveServer

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold mb-0">📰 Новости</h1>
            <p class="text-muted">Всё о Standoff 2 и обновлениях трекера</p>
        </div>

        <AuthorizeView Roles="Admin">
            <button class="btn btn-dark btn-sm rounded-pill px-3" @onclick='() => Nav.NavigateTo("/admin/news/create")'>
                + Написать статью
            </button>
        </AuthorizeView>
    </div>

    <div class="d-flex gap-2 mb-4 overflow-auto pb-2">
        <button class="btn btn-sm rounded-pill @(selectedCat == null ? "btn-primary" : "btn-light border")"
                @onclick="() => Filter(null)">
            Все
        </button>
        @foreach (var cat in Enum.GetValues(typeof(NewsCategory)).Cast<NewsCategory>())
        {
            <button class="btn btn-sm rounded-pill @(selectedCat == cat ? "btn-primary" : "btn-light border")"
                    @onclick="() => Filter(cat)">
                @GetCategoryName(cat)
            </button>
        }
    </div>

    <div class="row g-4">
        @foreach (var item in filteredNews)
        {
            <div class="col-md-6 col-lg-4">
                <a href="/news/@item.Slug" class="text-decoration-none text-dark">
                    <div class="card h-100 border-0 shadow-sm news-card">
                        <div class="card-img-top position-relative" style="height: 200px; overflow: hidden; border-radius: 12px 12px 0 0;">
                            @if (!string.IsNullOrEmpty(item.CoverImageUrl))
                            {
                                <img src="@item.CoverImageUrl" class="w-100 h-100 object-fit-cover zoom-effect" />
                            }
                            else
                            {
                                <div class="w-100 h-100 bg-secondary d-flex align-items-center justify-content-center text-white">
                                    <i class="bi bi-newspaper fs-1 opacity-50"></i>
                                </div>
                            }
                            <span class="badge bg-dark position-absolute top-0 end-0 m-3">@GetCategoryName(item.Category)</span>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <small class="text-muted mb-2">@item.CreatedAt.ToString("dd MMMM yyyy")</small>
                            <h5 class="card-title fw-bold mb-2">@item.Title</h5>
                            <p class="card-text text-secondary small line-clamp-3">@item.ShortDescription</p>

                            <div class="mt-auto pt-3 text-primary fw-bold small">
                                Читать далее <i class="bi bi-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        }
    </div>
</div>

<style>
    .news-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 12px;
    }

        .news-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .zoom-effect {
        transition: transform 0.3s;
    }

    .news-card:hover .zoom-effect {
        transform: scale(1.05);
    }
</style>

@code {
    private List<NewsPost> allNews = new();
    private List<NewsPost> filteredNews = new();
    private NewsCategory? selectedCat = null;

    protected override async Task OnInitializedAsync()
    {
        allNews = await NewsService.GetAllNewsAsync(onlyPublished: false); // Админ видит все, юзеры фильтруются в сервисе
        filteredNews = allNews;
    }

    private void Filter(NewsCategory? cat)
    {
        selectedCat = cat;
        filteredNews = cat == null ? allNews : allNews.Where(x => x.Category == cat).ToList();
    }

    private string GetCategoryName(NewsCategory c) => c switch
    {
        NewsCategory.SiteNews => "Сайт",
        NewsCategory.GameUpdate => "Обновление",
        NewsCategory.Collection => "Коллекции",
        NewsCategory.Event => "События",
        NewsCategory.MarketAnalytics => "Аналитика",
        _ => c.ToString()
    };
}