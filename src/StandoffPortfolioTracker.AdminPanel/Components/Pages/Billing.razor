@page "/billing"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using StandoffPortfolioTracker.Core.Entities
@using StandoffPortfolioTracker.Core.Enums
@using StandoffPortfolioTracker.AdminPanel.Services
@using System.Security.Claims
@using Microsoft.Extensions.DependencyInjection
@using System.Text.Json
@using StandoffPortfolioTracker.Infrastructure
@inject IServiceScopeFactory ScopeFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject ToastService ToastService
@inject GlobalNotificationService GlobalNotifier
@attribute [Authorize]
@rendermode InteractiveServer

<div class="container-fluid" style="max-width: 1200px;">

    <div class="row g-4 mb-5">
        <div class="col-lg-4">
            <div class="card border-0 shadow-lg text-white mb-4 overflow-hidden position-relative h-100"
                 style="background: linear-gradient(135deg, #1a1d21 0%, #212529 100%); border-radius: 20px; min-height: 250px;">
                <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(255,193,7,0.2) 0%, rgba(0,0,0,0) 70%); border-radius: 50%;"></div>
                <div style="position: absolute; bottom: -30px; left: -30px; width: 120px; height: 120px; background: radial-gradient(circle, rgba(13,110,253,0.2) 0%, rgba(0,0,0,0) 70%); border-radius: 50%;"></div>

                <div class="card-body p-4 d-flex flex-column justify-content-between position-relative" style="z-index: 1;">
                    <div>
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="text-white-50 text-uppercase ls-1 mb-0"><i class="bi bi-wallet2 me-2"></i>Баланс</h6>
                            <span class="badge bg-white bg-opacity-10 border border-white border-opacity-10 text-white fw-normal" title="Ваш ID">ID: @userId.Substring(0, Math.Min(8, userId.Length))...</span>
                        </div>
                        <div class="mt-3">
                            <h1 class="display-4 fw-bold text-warning mb-0">@userBalance.ToString("N0") <span class="fs-5 text-white-50">G</span></h1>
                            <div class="small text-white-50">≈ @((userBalance * 1).ToString("N2")) RUB</div>
                        </div>
                    </div>
                    <button class="btn btn-warning w-100 fw-bold shadow-sm mt-4" @onclick="ShowPaymentModal">
                        <i class="bi bi-plus-lg me-1"></i> Пополнить счет
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100 bg-white rounded-4 p-4">
                <h5 class="fw-bold text-muted mb-4">Текущая подписка</h5>

                <div class="d-flex align-items-center gap-4 mb-4">
                    <div class="p-3 rounded-circle text-white @GetStatusColorClass(currentSubType) shadow-sm" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi @GetStatusIconClass(currentSubType) fs-2"></i>
                    </div>
                    <div>
                        <h2 class="fw-bold mb-0 text-dark">@currentSubType.ToString().ToUpper()</h2>
                        @if (isPro)
                        {
                            <div class="text-success fw-bold"><i class="bi bi-clock-history me-1"></i> Активна до @proExpiration?.ToString("dd MMMM yyyy")</div>

                            @if (!isAutoRenew)
                            {
                                <div class="text-danger small mt-1"><i class="bi bi-exclamation-circle"></i> Автопродление отключено. Подписка завершится в конце периода.</div>
                            }
                            else
                            {
                                <div class="text-muted small mt-1">Следующее списание произойдет автоматически.</div>
                            }
                        }
                        else
                        {
                            <div class="text-muted">У вас нет активной подписки. Функционал ограничен.</div>
                        }
                    </div>
                </div>

                @if (isPro)
                {
                    <div class="d-flex gap-3 mt-auto align-items-center">
                        <div class="form-check form-switch p-0 d-flex align-items-center gap-2 bg-light px-3 py-2 rounded-pill border">
                            <input class="form-check-input m-0" type="checkbox" role="switch" id="autoRenew" checked="@isAutoRenew" @onchange="InitiateAutoRenewChange" style="cursor: pointer;">
                            <label class="form-check-label small fw-bold text-muted cursor-pointer user-select-none" for="autoRenew">Автопродление</label>
                        </div>

                        @if (isAutoRenew)
                        {
                            <button class="btn btn-link text-danger text-decoration-none small fw-bold" @onclick="InitiateCancelSubscription">Отменить подписку</button>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="row justify-content-center mb-5">
        <div class="col-12 text-center mb-4">
            <h3 class="fw-bold">Выберите уровень доступа</h3>
            <p class="text-muted">Инструменты для эффективного трейдинга</p>
        </div>

        <div class="col-md-5 col-lg-4 mb-4">
            <div class="card h-100 border-0 shadow-sm rounded-4 hover-scale transition overflow-hidden @(currentSubType == SubscriptionType.Lite ? "border border-2 border-info" : "")">
                <div class="card-header bg-white border-0 pt-4 pb-0 text-center">
                    <span class="badge bg-info bg-opacity-10 text-info px-3 py-2 rounded-pill mb-3 fw-bold">НАЧАЛЬНЫЙ</span>
                    <h2 class="fw-bold text-dark">LITE</h2>
                    <div class="display-6 fw-bold text-dark my-2">150 <span class="fs-6 text-muted">G / мес</span></div>
                </div>
                <div class="card-body px-4 py-4 d-flex flex-column">
                    <ul class="list-unstyled d-grid gap-3 mb-4">
                        <li class="d-flex gap-3 align-items-center"><i class="bi bi-check-circle-fill text-info fs-5"></i> <span><strong>3</strong> портфолио</span></li>
                        <li class="d-flex gap-3 align-items-center"><i class="bi bi-check-circle-fill text-info fs-5"></i> <span>До <strong>150</strong> предметов</span></li>
                        <li class="d-flex gap-3 align-items-center"><i class="bi bi-check-circle-fill text-info fs-5"></i> <span>Расширенная аналитика</span></li>
                        <li class="d-flex gap-3 align-items-center"><i class="bi bi-check-circle-fill text-info fs-5"></i> <span>Оповещения об инвентаре</span></li>
                        <li class="d-flex gap-3 align-items-center text-muted opacity-50"><i class="bi bi-x-circle fs-5"></i> <span>Просмотр Рынка</span></li>
                        <li class="d-flex gap-3 align-items-center text-muted opacity-50"><i class="bi bi-x-circle fs-5"></i> <span>Бусты рынка</span></li>
                    </ul>

                    <div class="mt-auto">
                        @if (currentSubType == SubscriptionType.Lite)
                        {
                            <button class="btn btn-info w-100 rounded-pill fw-bold py-2 text-white" @onclick="() => InitiateBuy(30, 150, SubscriptionType.Lite)">
                                Продлить Lite (+30 дн.)
                            </button>
                        }
                        else if (currentSubType == SubscriptionType.Premium)
                        {
                            <button class="btn btn-outline-secondary w-100 rounded-pill fw-bold py-2" disabled title="Понижение уровня невозможно. Отмените Premium и дождитесь его окончания.">
                                Недоступно (Active Premium)
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-outline-info w-100 rounded-pill fw-bold py-2" @onclick="() => InitiateBuy(30, 150, SubscriptionType.Lite)">
                                Выбрать Lite
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-5 col-lg-4 mb-4">
            <div class="card h-100 border-0 shadow rounded-4 hover-scale transition overflow-hidden position-relative scale-up @(currentSubType == SubscriptionType.Premium ? "border border-2 border-warning" : "")">
                <div class="position-absolute top-0 w-100 bg-warning text-dark text-center fw-bold py-1 small shadow-sm" style="z-index: 2;">РЕКОМЕНДУЕМ</div>
                <div class="card-header bg-dark text-white border-0 pt-5 pb-0 text-center position-relative">
                    <h2 class="fw-bold text-warning"><i class="bi bi-stars"></i> PREMIUM</h2>
                    <div class="display-6 fw-bold text-white my-2">250 <span class="fs-6 text-white-50">G / мес</span></div>
                </div>
                <div class="card-body px-4 py-4 bg-dark text-white d-flex flex-column">
                    <ul class="list-unstyled d-grid gap-3 mb-4">
                        <li class="d-flex gap-3 align-items-center"><i class="bi bi-check-circle-fill text-warning fs-5"></i> <span><strong>∞</strong> Портфолио</span></li>
                        <li class="d-flex gap-3 align-items-center"><i class="bi bi-check-circle-fill text-warning fs-5"></i> <span><strong>1000+</strong> предметов</span></li>
                        <li class="d-flex gap-3 align-items-center"><i class="bi bi-check-circle-fill text-warning fs-5"></i> <span>Всё из Lite версии</span></li>
                        <li class="d-flex gap-3 align-items-center"><i class="bi bi-check-circle-fill text-warning fs-5"></i> <span><strong>Полный доступ</strong> к Рынку</span></li>
                        <li class="d-flex gap-3 align-items-center"><i class="bi bi-check-circle-fill text-warning fs-5"></i> <span>Оповещения о <strong>бустах</strong></span></li>
                        <li class="d-flex gap-3 align-items-center"><i class="bi bi-check-circle-fill text-warning fs-5"></i> <span>PRO Кастомизация</span></li>
                    </ul>

                    <div class="d-grid gap-2 mt-auto">
                        @if (currentSubType == SubscriptionType.Premium)
                        {
                            <button class="btn btn-warning text-dark rounded-pill fw-bold py-2" @onclick="() => InitiateBuy(30, 250, SubscriptionType.Premium)">
                                Продлить Premium (+30 дн.)
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-warning text-dark rounded-pill fw-bold py-2" @onclick="() => InitiateBuy(30, 250, SubscriptionType.Premium)">
                                @(currentSubType == SubscriptionType.Lite ? "Улучшить до Premium" : "Купить (1 мес)")
                            </button>
                        }

                        <button class="btn btn-outline-warning rounded-pill fw-bold py-2 position-relative" @onclick="() => InitiateBuy(90, 700, SubscriptionType.Premium)">
                            3 Месяца - 700 G
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">SAVE 50</span>
                        </button>
                        <button class="btn btn-outline-light rounded-pill fw-bold py-2" @onclick="() => InitiateBuy(365, 2400, SubscriptionType.Premium)">1 Год - 2400 G</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <AuthorizeView Roles="Admin">
        <div class="row mb-5">
            <div class="col-12">
                <div class="card border-danger shadow-sm">
                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                        <span class="fw-bold"><i class="bi bi-joystick"></i> Симулятор DonationAlerts (Admin Zone)</span>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">1. Получатель</label>
                                <select class="form-select" @bind="testSelectedUserId" @bind:after="UpdateTestJson">
                                    <option value="">-- Выбрать --</option>
                                    @foreach (var u in allUsers)
                                    {
                                        <option value="@u.Id">@u.Email</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">2. Сумма</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" @bind="testAmount" @bind:after="UpdateTestJson" />
                                    <select class="form-select" @bind="testCurrency" @bind:after="UpdateTestJson" style="max-width: 100px;">
                                        <option value="RUB">RUB</option>
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="KZT">KZT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label small fw-bold">3. JSON Payload</label>
                                <textarea class="form-control font-monospace small" rows="3" @bind="testJsonPayload"></textarea>
                            </div>
                            <div class="col-md-12 text-end">
                                <button class="btn btn-danger fw-bold" @onclick="RunSimulation">
                                    <i class="bi bi-play-fill"></i> Отправить Webhook
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </AuthorizeView>

    <div class="row">
        <div class="col-12">
            <h5 class="text-muted fw-bold mb-3">История операций</h5>
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush rounded-4" style="max-height: 400px; overflow-y: auto;">
                        @if (history.Any())
                        {
                            @foreach (var t in history.Take(10))
                            {
                                <div class="list-group-item border-0 py-3 px-4 d-flex justify-content-between align-items-center hover-bg-light transition">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="rounded-circle p-2 @(t.Amount > 0 ? "bg-success" : "bg-secondary") bg-opacity-10 text-@(t.Amount > 0 ? "success" : "secondary")">
                                            <i class="bi @(t.Amount > 0 ? "bi-arrow-down-left" : "bi-arrow-up-right")"></i>
                                        </div>
                                        <div style="line-height: 1.2;">
                                            <div class="fw-bold text-dark">@t.Description</div>
                                            <div class="text-muted small">@t.Date.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</div>
                                        </div>
                                    </div>
                                    <div class="fw-bold @(t.Amount > 0 ? "text-success" : "text-dark")">
                                        @(t.Amount > 0 ? "+" : "")@t.Amount.ToString("N0") G
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="p-5 text-center text-muted">История операций пуста</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

@* --- МОДАЛЬНОЕ ОКНО ПОДТВЕРЖДЕНИЯ ПОДПИСКИ --- *@
@if (showSubConfirmModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1060;" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-dark border-0 rounded-4 shadow-lg">
                <div class="modal-body p-4 text-center">
                    <div class="mb-3">
                        <i class="bi bi-question-circle-fill text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <h4 class="fw-bold mb-3 text-white">Подтверждение</h4>
                    <p class="text-white-50 mb-4">@subConfirmMessage</p>

                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-outline-light rounded-pill px-4" @onclick="() => showSubConfirmModal = false">Отмена</button>
                        <button class="btn btn-warning rounded-pill px-4 fw-bold" @onclick="ConfirmSubscriptionAction">Подтвердить</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* --- НОВОЕ КРАСИВОЕ МОДАЛЬНОЕ ОКНО ПОПОЛНЕНИЯ --- *@
@if (showPaymentModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 1050;" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-glass border-0 rounded-4 overflow-hidden text-white">

                <div class="modal-header-custom d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="modal-title fw-bold mb-0">
                            @(paymentStep == 1 ? "Пополнение баланса" : "Подтверждение")
                        </h5>
                        <small class="text-white-50">@(paymentStep == 1 ? "Шаг 1 из 2" : "Шаг 2 из 2")</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>

                <div class="modal-body p-4 text-center">

                    @if (paymentStep == 1)
                    {
                        <div class="py-2">
                            <label class="text-white-50 small text-uppercase ls-1 mb-3 fw-bold">Введите сумму (Gold)</label>

                            <div class="input-amount-wrapper d-flex align-items-center mb-4">
                                <input type="number" class="input-huge" placeholder="0"
                                       @bind="topUpAmount" @bind:event="oninput" min="10" />
                                <span class="text-warning fw-bold fs-4 me-3">G</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center bg-white bg-opacity-10 p-3 rounded-3 mb-4">
                                <div class="text-start">
                                    <div class="small text-white-50">К оплате:</div>
                                    <div class="fs-4 fw-bold">@currentCost.ToString("N2") @GetCurrencySymbol(selectedCurrency)</div>
                                </div>
                                <select class="currency-selector form-select form-select-sm w-auto shadow-none focus-none"
                                        @bind="selectedCurrency" @bind:after="UpdateCost">
                                    @foreach (var curr in currencies)
                                    {
                                        <option value="@curr.Key">@curr.Key</option>
                                    }
                                </select>
                            </div>

                            <button class="btn btn-warning w-100 py-3 rounded-3 fw-bold shadow-lg text-dark fs-5"
                                    style="transition: all 0.2s; text-transform: uppercase;"
                                    @onclick="GoToPaymentStep2">
                                Продолжить <i class="bi bi-arrow-right ms-2"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="py-2">
                            <div class="mb-4">
                                <div class="badge bg-warning text-dark px-3 py-2 rounded-pill mb-2">Оплата через DonationAlerts</div>
                                <h2 class="display-5 fw-bold text-white mb-0">@topUpAmount <span class="text-warning">G</span></h2>
                                <div class="small text-white-50">Сумма к оплате: @currentCost.ToString("N2") @GetCurrencySymbol(selectedCurrency)</div>
                            </div>

                            <div class="text-start mb-4">
                                <div class="d-flex align-items-center gap-2 mb-2 text-warning">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                    <span class="fw-bold small text-uppercase">Важно: Укажите ID в сообщении</span>
                                </div>

                                <div class="id-copy-box p-3 d-flex align-items-center justify-content-between gap-3">
                                    <div style="overflow: hidden;">
                                        <div class="text-white-50 small" style="font-size: 10px;">ВАШ УНИКАЛЬНЫЙ ID</div>
                                        <div class="font-monospace fs-5 text-white text-truncate">ID:@userId</div>
                                    </div>
                                    <button class="btn btn-outline-warning btn-sm border-0 rounded-circle"
                                            style="width: 40px; height: 40px; flex-shrink: 0;"
                                            @onclick="CopyIdToClipboard" title="Копировать">
                                        <i class="bi bi-copy fs-5"></i>
                                    </button>
                                </div>
                                <div class="mt-2 small text-white-50" style="font-size: 0.8rem; line-height: 1.4;">
                                    Скопируйте ID выше и вставьте его в поле <strong>"Сообщение"</strong> на странице оплаты, иначе средства не зачислятся автоматически.
                                </div>
                            </div>

                            <div class="d-flex gap-2 mt-4">
                                <button class="btn btn-outline-light w-25 py-2 rounded-3 fw-bold border-opacity-25"
                                        @onclick="() => paymentStep = 1">
                                    <i class="bi bi-arrow-left"></i>
                                </button>
                                <button class="btn btn-success w-75 py-2 rounded-3 fw-bold shadow-lg fs-5"
                                        style="background: linear-gradient(45deg, #198754, #20c997); border: none;"
                                        @onclick="ProceedToDonationAlerts">
                                    Оплатить <i class="bi bi-box-arrow-up-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<style>
    /* Global Helpers */
    .backdrop-blur {
        backdrop-filter: blur(10px);
    }

    .ls-1 {
        letter-spacing: 1px;
    }

    .hover-scale {
        transition: transform 0.2s;
    }

        .hover-scale:hover {
            transform: translateY(-5px);
        }

    .transition {
        transition: all 0.3s ease;
    }

    .hover-bg-light:hover {
        background-color: #f8f9fa;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .scale-up {
        transform: scale(1.02);
        z-index: 10;
    }

        .scale-up:hover {
            transform: scale(1.05);
        }

    /* Styles for Payment Modal (Glassmorphism) */
    .modal-glass {
        background: rgba(33, 37, 41, 0.95); /* Dark background */
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .modal-dark {
        background: #212529;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .modal-header-custom {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding: 1.5rem;
    }

    /* Input Amount Styling */
    .input-amount-wrapper {
        position: relative;
        background: rgba(0,0,0,0.2);
        border-radius: 16px;
        padding: 10px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s;
    }

        .input-amount-wrapper:focus-within {
            border-color: #ffc107;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.2);
        }

    .input-huge {
        background: transparent;
        border: none;
        color: white;
        font-size: 3rem;
        font-weight: 800;
        text-align: center;
        width: 100%;
        outline: none;
    }

        .input-huge::-webkit-outer-spin-button,
        .input-huge::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

    .currency-selector {
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        border-radius: 8px;
        padding: 5px 10px;
        font-weight: bold;
        cursor: pointer;
    }

        .currency-selector option {
            background: #212529;
            color: white;
        }

    /* ID Copy Box */
    .id-copy-box {
        background: linear-gradient(145deg, #2c3035, #212529);
        border: 1px dashed rgba(255, 193, 7, 0.5);
        border-radius: 12px;
        position: relative;
        overflow: hidden;
    }

        .id-copy-box::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #ffc107;
        }
</style>

<script>
    window.copyText = (text) => {
        navigator.clipboard.writeText(text).catch(err => console.error('Error copying text: ', err));
    }
</script>

@code {
    private decimal userBalance;
    private bool isPro;
    private DateTime? proExpiration;
    private SubscriptionType currentSubType = SubscriptionType.None;
    private string userId = "";
    private List<WalletTransaction> history = new();

    private bool isAutoRenew;
    private int topUpAmount = 100;
    private bool showPaymentModal = false;
    private int paymentStep = 1;
    private string selectedCurrency = "RUB";
    private decimal currentCost = 100;

    // --- Subscription Confirmation State ---
    private bool showSubConfirmModal = false;
    private string subConfirmMessage = "";
    private Func<Task> pendingAction;

    // Admin vars
    private List<ApplicationUser> allUsers = new();
    private string testSelectedUserId = "";
    private decimal testAmount = 100;
    private string testCurrency = "RUB";
    private string testJsonPayload = "";

    private Dictionary<string, decimal> currencies = new()
    {
        { "RUB", 1.0m }, { "USD", 0.011m }, { "EUR", 0.010m }, { "UAH", 0.45m }, { "KZT", 5.0m }
    };

    private string GetCurrencySymbol(string code) => code switch
    { "RUB" => "₽", "USD" => "$", "EUR" => "€", "UAH" => "₴", "KZT" => "₸", _ => code };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";
        UpdateCost();
        await LoadData();

        if (authState.User.IsInRole("Admin"))
        {
            await LoadAllUsers();
        }
    }

    private async Task LoadData()
    {
        using (var scope = ScopeFactory.CreateScope())
        {
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>();
            var billingService = scope.ServiceProvider.GetRequiredService<BillingService>();

            var user = await userManager.FindByIdAsync(userId);
            if (user != null)
            {
                userBalance = user.Balance;
                isPro = user.IsPro;
                proExpiration = user.ProExpirationDate;
                currentSubType = user.SubType;
                isAutoRenew = user.IsAutoRenew;
                history = await billingService.GetHistoryAsync(userId);
            }
        }
    }

    // === ЛОГИКА ПОДТВЕРЖДЕНИЯ ДЕЙСТВИЙ ===

    private void InitiateBuy(int days, decimal cost, SubscriptionType type)
    {
        // Логика формирования сообщения
        string actionText = "купить";
        if (currentSubType == type) actionText = "продлить";
        else if (isPro) actionText = "перейти на";

        subConfirmMessage = $"Вы действительно хотите {actionText} подписку {type} на {days} дней за {cost:N0} G?";

        // Если это апгрейд, добавляем предупреждение
        if (isPro && currentSubType != type && type == SubscriptionType.Premium)
        {
            subConfirmMessage += " Ваша текущая подписка Lite будет заменена на Premium с сегодняшнего дня.";
        }

        pendingAction = async () => await ExecuteBuy(days, cost, type);
        showSubConfirmModal = true;
    }

    private void InitiateAutoRenewChange(ChangeEventArgs e)
    {
        // Сразу возвращаем чекбокс назад визуально, пока не подтвердим (или можно просто спросить)
        // Но проще спросить при ОТКЛЮЧЕНИИ. При включении обычно подтверждение не нужно.
        bool newValue = (bool)e.Value!;

        if (!newValue) // Если выключаем - спрашиваем
        {
            subConfirmMessage = "Вы уверены, что хотите отключить автопродление? Вы можете потерять доступ к функциям после окончания срока.";
            pendingAction = async () => await ExecuteAutoRenew(false);
            showSubConfirmModal = true;
            // Визуально держим включенным до подтверждения (можно перерисовать)
        }
        else
        {
            // Включаем сразу
            _ = ExecuteAutoRenew(true);
        }
    }

    private void InitiateCancelSubscription()
    {
        subConfirmMessage = "Вы уверены, что хотите отменить подписку? Автопродление будет отключено.";
        pendingAction = async () => await ExecuteCancel();
        showSubConfirmModal = true;
    }

    private async Task ConfirmSubscriptionAction()
    {
        showSubConfirmModal = false;
        if (pendingAction != null) await pendingAction.Invoke();
    }

    // === ИСПОЛНЕНИЕ ДЕЙСТВИЙ (Backend Calls) ===

    private async Task ExecuteBuy(int days, decimal cost, SubscriptionType type)
    {
        using (var scope = ScopeFactory.CreateScope())
        {
            var billingService = scope.ServiceProvider.GetRequiredService<BillingService>();
            var result = await billingService.BuySubscriptionAsync(userId, days, cost, type);

            if (result.Success)
            {
                GlobalNotifier.NotifyUser(userId, result.Message, ToastLevel.Success);
                await LoadData();
            }
            else
            {
                ToastService.ShowToast(result.Message, ToastLevel.Error);
            }
        }
    }

    private async Task ExecuteAutoRenew(bool active)
    {
        using (var scope = ScopeFactory.CreateScope())
        {
            var service = scope.ServiceProvider.GetRequiredService<BillingService>();
            await service.SetAutoRenewAsync(userId, active);
        }
        isAutoRenew = active; // Обновляем UI
        ToastService.ShowToast($"Автопродление {(active ? "включено" : "выключено")}", ToastLevel.Info);
    }

    private async Task ExecuteCancel()
    {
        await ExecuteAutoRenew(false);
        ToastService.ShowToast("Подписка отменена (не будет продлена)", ToastLevel.Warning);
    }

    // === МОДАЛЬНОЕ ОКНО ПОПОЛНЕНИЯ ===
    private void UpdateCost()
    {
        if (currencies.TryGetValue(selectedCurrency, out decimal rate))
        {
            currentCost = topUpAmount * rate;
        }
    }

    private void ShowPaymentModal()
    {
        if (topUpAmount < 10) return;
        paymentStep = 1;
        showPaymentModal = true;
    }
    private void GoToPaymentStep2() { UpdateCost(); paymentStep = 2; }
    private void CloseModal() { showPaymentModal = false; paymentStep = 1; }
    private async Task CopyIdToClipboard() { await JS.InvokeVoidAsync("copyText", $"ID:{userId}"); }

    private async Task ProceedToDonationAlerts()
    {
        string daNickname = "gordan_playm";
        await CopyIdToClipboard();
        string amountStr = currentCost.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture);
        string url = $"https://www.donationalerts.com/r/{daNickname}?amount={amountStr}&currency={selectedCurrency}&message=ID:{userId}";
        Nav.NavigateTo(url, forceLoad: true);
        showPaymentModal = false;
    }

    // === АДМИНКА ===
    private async Task LoadAllUsers() { using var scope = ScopeFactory.CreateScope(); var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>(); allUsers = userManager.Users.ToList(); }
    private void UpdateTestJson() { int fakeTxId = new Random().Next(100000, 999999); testJsonPayload = $"{{\n    \"id\": {fakeTxId},\n    \"name\": \"Test Simulator\",\n    \"username\": \"Test Simulator\",\n    \"message\": \"Привет! Вот мой ID:{testSelectedUserId}\",\n    \"message_type\": \"text\",\n    \"amount\": {testAmount},\n    \"currency\": \"{testCurrency}\",\n    \"is_shown\": 1,\n    \"created_at\": \"{DateTime.Now:yyyy-MM-dd HH:mm:ss}\",\n    \"shown_at\": null\n}}"; }
    private async Task RunSimulation() { try { if (string.IsNullOrEmpty(testJsonPayload)) { ToastService.ShowToast("JSON пуст!", ToastLevel.Error); return; } using var doc = JsonDocument.Parse(testJsonPayload); var root = doc.RootElement; string msg = root.GetProperty("message").GetString() ?? ""; decimal amount = root.GetProperty("amount").GetDecimal(); string currency = root.GetProperty("currency").GetString() ?? "RUB"; string externalId = root.GetProperty("id").GetInt32().ToString(); string? targetId = FindUserIdInMessage(msg); if (string.IsNullOrEmpty(targetId)) { ToastService.ShowToast("Не удалось найти ID пользователя", ToastLevel.Warning); return; } decimal goldAmount = amount; if (currency == "USD") goldAmount = amount * 90; if (currency == "EUR") goldAmount = amount * 100; if (currency == "KZT") goldAmount = amount * 0.2m; using var scope = ScopeFactory.CreateScope(); var billing = scope.ServiceProvider.GetRequiredService<BillingService>(); var context = scope.ServiceProvider.GetRequiredService<AppDbContext>(); var user = await context.Users.FindAsync(targetId); if (user == null) { ToastService.ShowToast("Пользователь не найден", ToastLevel.Error); return; } await billing.AddBalanceAsync(targetId, goldAmount, $"DonationAlerts ({currency}) ID:{externalId} [SIMULATION]"); GlobalNotifier.NotifyUser(targetId, $"✅ Баланс пополнен: +{goldAmount:N0} G", ToastLevel.Success); ToastService.ShowToast($"Отправлено пользователю {targetId}", ToastLevel.Info); } catch (Exception ex) { ToastService.ShowToast($"Ошибка JSON: {ex.Message}", ToastLevel.Error); } }
    private string? FindUserIdInMessage(string msg) { if (string.IsNullOrWhiteSpace(msg)) return null; var words = msg.Split(new[] { ' ', '\n', ',', ':' }, StringSplitOptions.RemoveEmptyEntries); foreach (var word in words) { if (Guid.TryParse(word, out _)) return word; } return null; }

    // Helpers
    private string GetStatusColorClass(SubscriptionType type) => type switch
    {
        SubscriptionType.Premium => "bg-warning",
        SubscriptionType.Lite => "bg-info",
        _ => "bg-secondary"
    };

    private string GetStatusIconClass(SubscriptionType type) => type switch
    {
        SubscriptionType.Premium => "bi-stars",
        SubscriptionType.Lite => "bi-lightning-fill",
        _ => "bi-person"
    };
}