@page "/market"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using StandoffPortfolioTracker.Core.Entities
@using StandoffPortfolioTracker.Core.Enums
@using StandoffPortfolioTracker.AdminPanel.Services
@using System.Security.Claims
@inject ItemService ItemService
@inject PriceHistoryFileService PriceHistoryService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>–†—ã–Ω–æ–∫ - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</PageTitle>

@if (isLoadingUser)
{
    <div class="d-flex justify-content-center align-items-center vh-100 bg-white">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (!isPremium)
{
    <div class="lock-screen d-flex justify-content-center align-items-center vh-100">
        <div class="lock-card text-center p-5 rounded-5 shadow-lg bg-white position-relative overflow-hidden">
            <div class="icon-wrapper mb-4 text-warning">
                <i class="bi bi-shield-lock-fill" style="font-size: 4rem;"></i>
            </div>
            <h2 class="fw-bold text-dark mb-3">–î–æ—Å—Ç—É–ø –∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –∑–∞–∫—Ä—ã—Ç</h2>
            <p class="text-secondary mb-4 fs-5 mx-auto" style="max-width: 450px;">
                –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω, –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∏ —Ç—Ä–µ–Ω–¥—ã —Ä—ã–Ω–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π <strong class="text-warning text-uppercase">Premium</strong>.
            </p>
            <a href="billing" class="btn btn-warning rounded-pill px-5 py-3 fw-bold fs-5 shadow-sm hover-scale transition text-dark border-0">
                <i class="bi bi-stars me-2"></i> –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø
            </a>
        </div>
    </div>
}
else
{
    <div class="market-layout bg-light" @onclick="CloseAllDropdowns">
        <div class="container-fluid" style="max-width: 1600px;">

            <div class="market-header mb-4 pt-4 px-2 d-flex justify-content-between align-items-end">
                <div>
                    <h2 class="fw-bold text-dark mb-1 d-flex align-items-center gap-2">
                        <span class="bg-indigo text-white p-2 rounded-3 lh-1 shadow-sm"><i class="bi bi-graph-up-arrow"></i></span>
                        –†—ã–Ω–æ–∫
                    </h2>
                    <div class="text-secondary small">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–Ω –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
                </div>
            </div>

            <div class="filters-panel bg-white p-3 rounded-4 mb-4 d-flex flex-wrap gap-3 align-items-center shadow-sm border border-light mx-2">

                <div class="filter-group flex-grow-1" style="min-width: 250px;">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0 text-muted ps-3"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control bg-white border-start-0 text-dark fw-bold shadow-none"
                               placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–∏–Ω–∞..."
                               @bind="searchQuery"
                               @bind:event="oninput"
                               @onkeyup="ResetAndLoad" />
                    </div>
                </div>

                <div class="filter-group position-relative" style="min-width: 240px;">
                    <button class="custom-select-btn d-flex align-items-center justify-content-between w-100"
                            @onclick:stopPropagation @onclick='() => ToggleDropdown("collection")'>
                        <div class="d-flex align-items-center gap-2 overflow-hidden">
                            @if (selectedCollectionId == 0)
                            {
                                <span>üì¶ –í—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                            }
                            else
                            {
                                var col = collections.FirstOrDefault(c => c.Id == selectedCollectionId);
                                if (!string.IsNullOrEmpty(col?.ImageUrl))
                                {

                                    <img src="@col.ImageUrl" class="filter-icon" />
                                }
                                <span class="text-truncate">@col?.Name</span>
                            }
                        </div>
                        <i class="bi bi-chevron-down small text-muted"></i>
                    </button>

                    @if (openDropdown == "collection")
                    {
                        <div class="custom-dropdown-menu shadow-lg">
                            <div class="dropdown-item-custom" @onclick="() => SelectCollection(0)">
                                <span>üì¶</span> –í—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                            </div>
                            <div class="dropdown-divider my-1"></div>
                            @foreach (var col in collections)
                            {
                                <div class="dropdown-item-custom @(selectedCollectionId == col.Id ? "active" : "")"
                                     @onclick="() => SelectCollection(col.Id)">
                                    @if (!string.IsNullOrEmpty(col.ImageUrl))
                                    {
                                        <img src="@col.ImageUrl" class="filter-icon" />
                                    }
                                    else
                                    {

                                        <i class="bi bi-box text-muted"></i>
                                    }
                                    <span>@col.Name</span>
                                </div>
                            }
                        </div>
                    }
                </div>

                <div class="filter-group position-relative" style="min-width: 180px;">
                    <button class="custom-select-btn d-flex align-items-center justify-content-between w-100"
                            @onclick:stopPropagation @onclick='() => ToggleDropdown("rarity")'>
                        @if (!selectedRarity.HasValue)
                        {
                            <span>üíé –õ—é–±–∞—è —Ä–µ–¥–∫–æ—Å—Ç—å</span>
                        }
                        else
                        {
                            <div class="d-flex align-items-center gap-2">
                                <span class="rarity-dot" style="background-color: @GetRarityColor(selectedRarity.Value)"></span>
                                <span style="color: @GetRarityColor(selectedRarity.Value)" class="fw-bold">@selectedRarity.Value</span>
                            </div>
                        }
                        <i class="bi bi-chevron-down small text-muted"></i>
                    </button>

                    @if (openDropdown == "rarity")
                    {
                        <div class="custom-dropdown-menu shadow-lg">
                            <div class="dropdown-item-custom" @onclick="() => SelectRarity(null)">üíé –õ—é–±–∞—è</div>
                            <div class="dropdown-divider my-1"></div>
                            @foreach (var r in Enum.GetValues<ItemRarity>())
                            {
                                <div class="dropdown-item-custom" @onclick="() => SelectRarity(r)">
                                    <span class="rarity-dot" style="background-color: @GetRarityColor(r)"></span>
                                    <span style="color: @GetRarityColor(r)" class="fw-bold">@r</span>
                                </div>
                            }
                        </div>
                    }
                </div>

                <div class="filter-group position-relative" style="min-width: 180px;">
                    <button class="custom-select-btn d-flex align-items-center justify-content-between w-100"
                            @onclick:stopPropagation @onclick='() => ToggleDropdown("type")'>
                        @if (!selectedType.HasValue)
                        {
                            <span>üî´ –õ—é–±–æ–π —Ç–∏–ø</span>
                        }
                        else
                        {

                            <span>@GetItemTypeIcon(selectedType.Value) @selectedType.Value</span>
                        }
                        <i class="bi bi-chevron-down small text-muted"></i>
                    </button>

                    @if (openDropdown == "type")
                    {
                        <div class="custom-dropdown-menu shadow-lg">
                            <div class="dropdown-item-custom" @onclick="() => SelectType(null)">üî´ –õ—é–±–æ–π</div>
                            <div class="dropdown-divider my-1"></div>
                            @foreach (var t in Enum.GetValues<ItemType>())
                            {
                                <div class="dropdown-item-custom" @onclick="() => SelectType(t)">
                                    @GetItemTypeIcon(t) @t
                                </div>
                            }
                        </div>
                    }
                </div>

                <div class="filter-group d-flex gap-2 ms-auto">
                    <input type="checkbox" class="btn-check" id="chkSt" @bind="showStatTrack" @bind:after="ResetAndLoad" autocomplete="off">
                    <label class="btn btn-outline-warning fw-bold btn-sm rounded-pill px-3 shadow-sm border-0" for="chkSt">StatTrak‚Ñ¢</label>

                    <input type="checkbox" class="btn-check" id="chkPat" @bind="showPattern" @bind:after="ResetAndLoad" autocomplete="off">
                    <label class="btn btn-outline-info fw-bold btn-sm rounded-pill px-3 shadow-sm border-0" for="chkPat">
                        <img src="/icons/pattern-icon.png" width="14" class="me-1 opacity-75" /> Pattern
                    </label>
                </div>
            </div>

            <div class="row g-4 px-2">
                <div class="col-lg-8 col-xl-9">
                    @if (items == null)
                    {
                        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
                    }
                    else if (!items.Any())
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-search display-1 opacity-25"></i>
                            <div class="mt-3">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                        </div>
                    }
                    else
                    {
                        <div class="item-grid">
                            @foreach (var item in items)
                            {
                                <div class="market-card @(selectedItem?.Id == item.Id ? "active" : "")"
                                     @onclick="() => SelectItem(item)">

                                    <div class="card-badges">
                                        @if (item.IsStatTrack)
                                        {
                                            <span class="badge-st shadow-sm">ST</span>
                                        }
                                        @if (item.IsPattern)
                                        {
                                            <div class="badge-pattern shadow-sm" title="Pattern">
                                                <img src="/icons/pattern-icon.png" />
                                            </div>
                                        }
                                    </div>

                                    <div class="card-img-container">
                                        <img src="@(item.ImageUrl ?? "/images/no-image.png")" loading="lazy" />
                                    </div>

                                    <div class="card-body p-3 pt-0">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="badge rounded-1 fw-bold text-uppercase px-2 shadow-sm border-0"
                                                  style="background-color: @GetRarityColor(item.Rarity); color: white; font-size: 0.65rem;">
                                                @item.Rarity.ToString().ToUpper()
                                            </span>

                                            @if (!string.IsNullOrEmpty(item.Collection?.ImageUrl))
                                            {
                                                <img src="@item.Collection.ImageUrl" class="collection-icon-xs" title="@item.Collection.Name" />
                                            }
                                        </div>

                                        <div class="fw-bold text-dark text-truncate" style="font-size: 0.9rem;" title="@item.SkinName">
                                            @(string.IsNullOrEmpty(item.SkinName) ? item.Name : item.SkinName)
                                        </div>

                                        <div class="text-secondary small mb-2 text-truncate text-uppercase" style="font-size: 0.7rem;">@item.Name</div>

                                        <div class="fw-bold text-dark" style="font-size: 1.1rem;">
                                            @item.CurrentMarketPrice.ToString("N0") <span class="text-muted small">G</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="d-flex justify-content-center mt-5 mb-5 gap-2">
                            <button class="btn btn-white shadow-sm border rounded-circle" style="width: 40px; height: 40px;" disabled="@(currentPage == 1)" @onclick="PrevPage">
                                <i class="bi bi-chevron-left text-dark"></i>
                            </button>
                            <span class="bg-white px-4 py-2 rounded-pill shadow-sm border fw-bold text-secondary">@currentPage</span>
                            <button class="btn btn-white shadow-sm border rounded-circle" style="width: 40px; height: 40px;" @onclick="NextPage">
                                <i class="bi bi-chevron-right text-dark"></i>
                            </button>
                        </div>
                    }
                </div>

                <div class="col-lg-4 col-xl-3">
                    <div class="detail-panel-sticky">
                        @if (selectedItem != null)
                        {
                            <div class="card border-0 shadow-sm rounded-4 overflow-hidden bg-white">
                                <div class="card-header bg-white border-0 text-center pt-4 pb-0">
                                    <div class="position-relative d-inline-block">
                                        <img src="@selectedItem.ImageUrl" class="detail-img mb-3" />
                                    </div>

                                    <h4 class="fw-bold text-dark mb-0">@selectedItem.SkinName</h4>
                                    <div class="text-secondary small">@selectedItem.Name</div>

                                    <div class="mt-3 d-flex justify-content-center gap-2">
                                        <span class="badge rounded-pill px-3 py-1 shadow-sm border-0"
                                              style="background-color: @GetRarityColor(selectedItem.Rarity); color: white;">
                                            @selectedItem.Rarity
                                        </span>
                                        @if (selectedItem.IsStatTrack)
                                        {
                                            <span class="badge rounded-pill bg-warning text-dark px-3 py-1 shadow-sm">ST</span>
                                        }
                                        @if (selectedItem.IsPattern)
                                        {
                                            <span class="badge rounded-pill bg-light text-dark border d-flex align-items-center gap-1 px-3 py-1 shadow-sm">
                                                <img src="/icons/pattern-icon.png" width="12" /> Pattern
                                            </span>
                                        }
                                    </div>
                                </div>

                                <div class="card-body">
                                    <div class="bg-light rounded-4 p-3 text-center mb-4 mt-3 border border-light">
                                        <div class="small text-muted text-uppercase fw-bold ls-1">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</div>
                                        <div class="display-6 fw-bold text-dark">
                                            @selectedItem.CurrentMarketPrice.ToString("N2") <span class="fs-6 text-muted">G</span>
                                        </div>

                                        @if (dailyChange != 0 || dailyChangePercent != 0)
                                        {
                                            <div class="mt-2 small fw-bold" style="color: @(dailyChange >= 0 ? "#28a745" : "#dc3545");">
                                                <i class="bi @(dailyChange >= 0 ? "bi-arrow-up" : "bi-arrow-down")"></i>
                                                @(dailyChange >= 0 ? "+" : "")@dailyChange.ToString("N2") G 
                                                (@(dailyChangePercent >= 0 ? "+" : "")@dailyChangePercent.ToString("N2")%)
                                            </div>
                                        }
                                    </div>

                                    <div class="chart-wrapper">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <span class="fw-bold text-dark small"><i class="bi bi-activity me-1 text-primary"></i> –î–∏–Ω–∞–º–∏–∫–∞</span>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn @(selectedPeriodDays == 7 ? "btn-primary" : "btn-outline-secondary")" @onclick="() => ChangePeriod(7)">7–¥</button>
                                                <button type="button" class="btn @(selectedPeriodDays == 30 ? "btn-primary" : "btn-outline-secondary")" @onclick="() => ChangePeriod(30)">30–¥</button>
                                                <button type="button" class="btn @(selectedPeriodDays == 90 ? "btn-primary" : "btn-outline-secondary")" @onclick="() => ChangePeriod(90)">90–¥</button>
                                                <button type="button" class="btn @(selectedPeriodDays == 180 ? "btn-primary" : "btn-outline-secondary")" @onclick="() => ChangePeriod(180)">180–¥</button>
                                            </div>
                                        </div>
                                        <div class="chart-box">
                                            @if (isLoadingChart)
                                            {
                                                <div class="chart-loader"><div class="spinner-border text-primary spinner-sm"></div></div>
                                            }
                                            else if (priceHistory?.Any() == true)
                                            {
                                                <canvas id="priceChart"></canvas>
                                            }
                                            else
                                            {
                                                <div class="text-center text-muted py-5 small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="card border-0 shadow-sm rounded-4 p-5 text-center bg-white">
                                <div class="mb-3 text-primary opacity-25"><i class="bi bi-cursor-fill display-4"></i></div>
                                <div class="text-dark fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</div>
                                <div class="text-muted small">—á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≥—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* CSS */
        .bg-indigo {
            background-color: #6366f1;
        }

        .text-indigo {
            color: #6366f1;
        }

        /* Dropdowns */
        .custom-select-btn {
            background: #fff;
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: 600;
            color: #475569;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

            .custom-select-btn:hover {
                border-color: #cbd5e1;
                background: #f8fafc;
            }

        .custom-dropdown-menu {
            position: absolute;
            top: 110%;
            left: 0;
            width: 100%;
            z-index: 1050;
            background: white;
            border-radius: 12px;
            padding: 6px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .dropdown-item-custom {
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #334155;
            transition: all 0.1s;
        }

            .dropdown-item-custom:hover {
                background: #f1f5f9;
                color: #6366f1;
            }

            .dropdown-item-custom.active {
                background: #e0e7ff;
                color: #6366f1;
            }

        .filter-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .rarity-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1) inset;
        }

        /* Grid */
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        /* Item Card */
        .market-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

            .market-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
                border-color: #cbd5e1;
            }

            .market-card.active {
                border-color: #6366f1;
                box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            }

        /* Card Image */
        .card-img-container {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle, #f8fafc 0%, #fff 70%);
            padding: 10px;
        }

            .card-img-container img {
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                transition: transform 0.3s;
                filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05));
            }

        .market-card:hover .card-img-container img {
            transform: scale(1.1);
        }

        /* Badges - –§–∏–∫—Å –Ω–∞–ª–æ–∂–µ–Ω–∏—è */
        .card-badges {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 5;
            display: flex;
            gap: 5px;
            flex-direction: row;
        }

        .badge-st {
            background: linear-gradient(45deg, #f59e0b, #fbbf24);
            color: white;
            font-size: 0.6rem;
            padding: 3px 6px;
            border-radius: 6px;
            font-weight: 800;
            border: 1px solid rgba(255,255,255,0.4);
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        .badge-pattern {
            background: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

            .badge-pattern img {
                width: 14px;
                height: 14px;
            }

        /* Detail Panel */
        .detail-panel-sticky {
            position: sticky;
            top: 90px;
        }

        .detail-img {
            width: 100%;
            height: 180px;
            object-fit: contain;
            filter: drop-shadow(0 10px 25px rgba(0,0,0,0.1));
            transition: transform 0.3s;
        }

            .detail-img:hover {
                transform: scale(1.05);
            }

        .chart-box {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 10px;
            min-height: 250px;
            position: relative;
        }

        .chart-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.8);
            z-index: 5;
            border-radius: 16px;
        }

        .collection-icon-xs {
            width: 16px;
            height: 16px;
            object-fit: contain;
            opacity: 0.7;
        }

        .ls-1 {
            letter-spacing: 0.5px;
        }

        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 4px;
            margin-right: 2px;
        }

        .btn-group-sm .btn-primary {
            background-color: #6366f1;
            border-color: #6366f1;
        }

        .btn-group-sm .btn-outline-secondary {
            color: #6c757d;
            border-color: #dee2e6;
        }

        .btn-group-sm .btn-outline-secondary:hover {
            background-color: #e9ecef;
            border-color: #dee2e6;
        }
    </style>
}

@code {
    private bool isLoadingUser = true;
    private bool isPremium = false;
    private List<ItemBase> items;
    private List<GameCollection> collections = new();
    private ItemBase selectedItem;
    private List<(DateTime Date, decimal Price)> priceHistory;

    // Filters
    private string searchQuery = "";
    private int selectedCollectionId = 0;
    private ItemRarity? selectedRarity;
    private ItemType? selectedType;
    private bool showStatTrack = false;
    private bool showPattern = false;

    private string? openDropdown = null;
    private int currentPage = 1;
    private const int pageSize = 40;
    private bool isLoadingChart = false;

    // Price history period selection
    private int selectedPeriodDays = 90;
    private decimal dailyChange = 0;
    private decimal dailyChangePercent = 0;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        if (user != null) isPremium = user.SubType == SubscriptionType.Premium;
        isLoadingUser = false;
        if (isPremium) { collections = await ItemService.GetCollectionsAsync(); await LoadData(); }
    }

    private async Task LoadData()
    {
        var res = await ItemService.GetItemsFilteredAsync((currentPage - 1) * pageSize, pageSize, searchQuery, selectedType, selectedRarity, selectedCollectionId, showStatTrack, showPattern);
        items = res.Items;
        StateHasChanged();
    }

    private async Task SelectItem(ItemBase item)
    {
        selectedItem = item;
        isLoadingChart = true;
        priceHistory = null;
        dailyChange = 0;
        dailyChangePercent = 0;
        StateHasChanged();

        try
        {
            // Load price history for selected period
            priceHistory = await PriceHistoryService.GetPriceHistoryAsync(item.Id, selectedPeriodDays);

            // Load daily change (24h)
            var (change, changePercent) = await PriceHistoryService.GetDailyChangeAsync(item.Id);
            dailyChange = change;
            dailyChangePercent = changePercent;

            isLoadingChart = false;
            StateHasChanged();

            await Task.Delay(50); // Wait for Canvas
            if (priceHistory?.Any() == true)
            {
                await JS.InvokeVoidAsync("drawPriceChart", 
                    priceHistory.Select(h => h.Date.ToString("yyyy-MM-dd")).ToList(), 
                    priceHistory.Select(h => (double)h.Price).ToList(), 
                    selectedItem.Name,
                    selectedPeriodDays);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chart Error: {ex.Message}");
            isLoadingChart = false;
        }
    }

    private async Task ChangePeriod(int days)
    {
        selectedPeriodDays = days;
        if (selectedItem?.Id > 0)
        {
            await SelectItem(selectedItem);
        }
    }

    private void ToggleDropdown(string name) => openDropdown = openDropdown == name ? null : name;
    private void CloseAllDropdowns() => openDropdown = null;
    private async Task SelectCollection(int id) { selectedCollectionId = id; openDropdown = null; await ResetAndLoad(); }
    private async Task SelectRarity(ItemRarity? r) { selectedRarity = r; openDropdown = null; await ResetAndLoad(); }
    private async Task SelectType(ItemType? t) { selectedType = t; openDropdown = null; await ResetAndLoad(); }
    private async Task ResetAndLoad() { currentPage = 1; await LoadData(); }
    private async Task NextPage() { currentPage++; await LoadData(); }
    private async Task PrevPage() { if (currentPage > 1) { currentPage--; await LoadData(); } }

    private string GetRarityColor(ItemRarity rarity) => rarity switch
    {
        ItemRarity.Common => "#94a3b8", // Grey
        ItemRarity.Uncommon => "#3b82f6", // Blue
        ItemRarity.Rare => "#2563eb", // Dark Blue
        ItemRarity.Epic => "#8b5cf6", // Purple
        ItemRarity.Legendary => "#ec4899", // Pink
        ItemRarity.Arcane => "#ef4444", // Red
        ItemRarity.Nameless => "#eab308", // Gold
        _ => "#cbd5e1"
    };

    private string GetItemTypeIcon(ItemType type) => type switch
    {
        ItemType.Guns => "üî´",
        ItemType.Knife => "üî™",
        ItemType.Glove => "üß§",
        ItemType.Sticker => "üè∑Ô∏è",
        ItemType.Charm => "üßø",
        ItemType.Graffiti => "üé®",
        ItemType.Container => "üì¶",
        ItemType.Grenade => "üí£",
        ItemType.Fragment => "üß©",
        _ => "‚ùì"
    };
}