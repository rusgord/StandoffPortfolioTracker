@page "/settings"
@using Microsoft.AspNetCore.Identity
@using StandoffPortfolioTracker.Core.Entities
@using System.Security.Claims
@using Microsoft.Extensions.DependencyInjection
@inject IServiceScopeFactory ScopeFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager
@inject IWebHostEnvironment Environment
@inject StandoffPortfolioTracker.AdminPanel.Services.ToastService ToastService
@attribute [Authorize]
@rendermode InteractiveServer

<div class="container py-4" style="max-width: 980px;">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h3 class="fw-bold text-dark m-0">⚙️ Настройки</h3>
            <span class="text-muted small">Управление профилем и приватностью</span>
        </div>
        <a href="profile/@currentUser?.Id" class="btn btn-outline-primary rounded-pill btn-sm fw-bold px-3 d-flex align-items-center gap-2 transition hover-shadow">
            <i class="bi bi-eye"></i> <span>Мой профиль</span>
        </a>
    </div>

    <div class="row g-4">
        <div class="col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden sticky-top" style="top: 20px; z-index: 1;">
                <div class="list-group list-group-flush p-2">
                    <button class="list-group-item list-group-item-action border-0 rounded-3 py-3 px-3 mb-1 d-flex align-items-center gap-3 @(activeTab == "general" ? "active-tab" : "text-secondary")"
                            @onclick='() => activeTab = "general"'>
                        <i class="bi bi-person-circle fs-5"></i>
                        <span class="fw-bold">Основное</span>
                    </button>

                    <button class="list-group-item list-group-item-action border-0 rounded-3 py-3 px-3 mb-1 d-flex align-items-center gap-3 @(activeTab == "privacy" ? "active-tab" : "text-secondary")"
                            @onclick='() => activeTab = "privacy"'>
                        <i class="bi bi-shield-check fs-5"></i>
                        <span class="fw-bold">Приватность</span>
                    </button>

                    <button class="list-group-item list-group-item-action border-0 rounded-3 py-3 px-3 d-flex align-items-center gap-3 @(activeTab == "security" ? "active-tab" : "text-secondary")"
                            @onclick='() => activeTab = "security"'>
                        <i class="bi bi-key-fill fs-5"></i>
                        <span class="fw-bold">Безопасность</span>
                    </button>
                </div>

                <div class="bg-light p-3 border-top mt-2">
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.65rem; letter-spacing: 1px;">Публичная ссылка</small>
                    <div class="input-group input-group-sm mt-2">
                        <input type="text" class="form-control border-end-0 bg-white" value="@GetProfileUrl()" readonly style="font-size: 0.8rem; color: #6c757d;" />
                        <button class="btn btn-white border border-start-0 text-primary" onclick="navigator.clipboard.writeText('@GetProfileUrl()')" title="Скопировать">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body p-4 p-lg-5">

                    @if (activeTab == "general")
                    {
                        <h5 class="fw-bold mb-4">👤 Личные данные</h5>

                        <div class="d-flex flex-column flex-md-row align-items-center gap-4 mb-5 p-4 bg-light rounded-4 border border-light">
                            <div class="position-relative">
                                <img src="@(string.IsNullOrEmpty(currentUser?.AvatarUrl) ? "/images/default-avatar.png" : currentUser.AvatarUrl)"
                                     class="rounded-circle shadow-sm object-fit-cover border border-3 border-white"
                                     style="width: 110px; height: 110px;" />

                                <label class="position-absolute bottom-0 end-0 bg-primary text-white shadow rounded-circle d-flex align-items-center justify-content-center cursor-pointer hover-scale"
                                       style="width: 36px; height: 36px; border: 2px solid white;">
                                    <i class="bi bi-camera-fill small"></i>
                                    <InputFile OnChange="HandleFileSelected" style="display:none;" accept=".jpg,.jpeg,.png" />
                                </label>
                            </div>
                            <div class="text-center text-md-start">
                                <h6 class="fw-bold mb-1">Фото профиля</h6>
                                <p class="text-muted small mb-0">Поддерживаются форматы JPG, PNG (макс. 2MB).</p>
                            </div>
                        </div>

                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="displayName" @bind="currentUser.DisplayName" placeholder="Имя" />
                                    <label for="displayName">Отображаемое имя</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control bg-light" id="email" value="@currentUser.UserName" disabled readonly />
                                    <label for="email">Логин (Email)</label>
                                </div>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold small text-muted ms-1">Цель портфолио (Gold)</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text bg-white border-end-0 text-warning"><i class="bi bi-crosshair"></i></span>
                                    <InputNumber class="form-control border-start-0 ps-0" @bind-Value="currentUser.PortfolioGoal" step="0.01" placeholder="0.00" />
                                </div>
                                <div class="form-text ms-1 text-muted small">Укажите сумму, которую вы хотите накопить.</div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-5">
                            <button class="btn btn-primary fw-bold px-4 py-2 rounded-pill shadow-sm transition hover-scale" @onclick="SaveChanges">
                                <i class="bi bi-check-lg me-2"></i> Сохранить изменения
                            </button>
                        </div>
                    }

                    @if (activeTab == "privacy")
                    {
                        <h5 class="fw-bold mb-4">🔒 Приватность</h5>

                        <div class="bg-primary bg-opacity-10 p-4 rounded-4 mb-4 border border-primary border-opacity-10">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="fw-bold mb-1 text-primary"><i class="bi bi-globe me-2"></i> Публичный профиль</h6>
                                    <p class="small text-muted mb-0">Если выключено, ваш профиль будет скрыт от всех.</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input fs-4 shadow-none" type="checkbox" id="publicProfile" @bind="currentUser.IsProfilePublic" style="cursor: pointer;">
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-3">
                            <div class="p-3 border rounded-4 d-flex justify-content-between align-items-center transition hover-bg-light @(!currentUser.IsProfilePublic ? "opacity-50 grayscale" : "")">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="bg-light p-2 rounded-circle text-muted"><i class="bi bi-wallet2"></i></div>
                                    <div>
                                        <span class="fw-bold d-block text-dark">Стоимость портфеля</span>
                                        <small class="text-muted">Показывать общую сумму другим</small>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input fs-5" type="checkbox" @bind="currentUser.ShowPortfolioValue" disabled="@(!currentUser.IsProfilePublic)">
                                </div>
                            </div>

                            <div class="p-3 border rounded-4 d-flex justify-content-between align-items-center transition hover-bg-light @(!currentUser.IsProfilePublic ? "opacity-50 grayscale" : "")">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="bg-light p-2 rounded-circle text-muted"><i class="bi bi-graph-up-arrow"></i></div>
                                    <div>
                                        <span class="fw-bold d-block text-dark">Динамика роста</span>
                                        <small class="text-muted">Показывать процент прибыли/убытка</small>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input fs-5" type="checkbox" @bind="currentUser.ShowGrowth" disabled="@(!currentUser.IsProfilePublic)">
                                </div>
                            </div>

                            <div class="p-3 border rounded-4 d-flex justify-content-between align-items-center transition hover-bg-light @(!currentUser.IsProfilePublic ? "opacity-50 grayscale" : "")">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="bg-light p-2 rounded-circle text-muted"><i class="bi bi-trophy"></i></div>
                                    <div>
                                        <span class="fw-bold d-block text-dark">Топ предметов</span>
                                        <small class="text-muted">Показывать 3 самых дорогих скина</small>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input fs-5" type="checkbox" @bind="currentUser.ShowTopItems" disabled="@(!currentUser.IsProfilePublic)">
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-5">
                            <button class="btn btn-primary fw-bold px-4 py-2 rounded-pill shadow-sm transition hover-scale" @onclick="SaveChanges">
                                Применить настройки
                            </button>
                        </div>
                    }

                    @if (activeTab == "security")
                    {
                        <h5 class="fw-bold mb-4">🔑 Безопасность</h5>

                        <div class="d-grid gap-3">
                            <a href="Identity/Account/Manage/ChangePassword" class="text-decoration-none">
                                <div class="p-3 border rounded-4 d-flex align-items-center justify-content-between hover-shadow transition bg-white">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="bg-primary bg-opacity-10 p-2 rounded-circle text-primary">
                                            <i class="bi bi-shield-lock-fill fs-5"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">Сменить пароль</div>
                                            <small class="text-muted">Рекомендуем менять каждые 3 месяца</small>
                                        </div>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                </div>
                            </a>

                            <a href="Identity/Account/Manage/ExternalLogins" class="text-decoration-none">
                                <div class="p-3 border rounded-4 d-flex align-items-center justify-content-between hover-shadow transition bg-white">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="bg-danger bg-opacity-10 p-2 rounded-circle text-danger">
                                            <i class="bi bi-google fs-5"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">Социальные сети</div>
                                            <small class="text-muted">Управление входом через Google</small>
                                        </div>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                </div>
                            </a>
                        </div>
                    }

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Активный таб: синий фон, белый текст */
    .active-tab {
        background-color: #0d6efd !important;
        color: white !important;
        box-shadow: 0 4px 10px rgba(13, 110, 253, 0.2);
    }

    /* Эффект при наведении на карточки */
    .hover-shadow:hover {
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.08) !important;
        transform: translateY(-2px);
    }

    .hover-bg-light:hover {
        background-color: #f8f9fa;
    }

    /* Плавные переходы */
    .transition {
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .cursor-pointer {
        cursor: pointer;
    }

    /* Увеличение кнопки при наведении */
    .hover-scale:hover {
        transform: scale(1.05);
        transition: transform 0.2s;
    }

    .object-fit-cover {
        object-fit: cover;
    }

    /* Отключение цвета для неактивных настроек */
    .grayscale {
        filter: grayscale(100%);
    }
</style>

@code {
    private string activeTab = "general";
    private ApplicationUser currentUser = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        if (principal.Identity?.IsAuthenticated == true)
        {
            using (var scope = ScopeFactory.CreateScope())
            {
                var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>();
                var user = await userManager.GetUserAsync(principal);
                if (user != null)
                {
                    currentUser = user;
                    // 🔥 ОКРУГЛЯЕМ ПРИ ЗАГРУЗКЕ, ЧТОБЫ УБРАТЬ ЛИШНИЕ НУЛИ
                    currentUser.PortfolioGoal = Math.Round(currentUser.PortfolioGoal, 2);
                }
            }
        }
    }

    private async Task SaveChanges()
    {
        using (var scope = ScopeFactory.CreateScope())
        {
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>();
            var userInDb = await userManager.FindByIdAsync(currentUser.Id);

            if (userInDb != null)
            {
                userInDb.DisplayName = currentUser.DisplayName;
                // Округляем и при сохранении на всякий случай
                userInDb.PortfolioGoal = Math.Round(currentUser.PortfolioGoal, 2);
                userInDb.IsProfilePublic = currentUser.IsProfilePublic;
                userInDb.ShowPortfolioValue = currentUser.ShowPortfolioValue;
                userInDb.ShowGrowth = currentUser.ShowGrowth;
                userInDb.ShowTopItems = currentUser.ShowTopItems;
                userInDb.AvatarUrl = currentUser.AvatarUrl;

                var result = await userManager.UpdateAsync(userInDb);

                if (result.Succeeded)
                {
                    ToastService.ShowToast("Настройки успешно сохранены!", StandoffPortfolioTracker.AdminPanel.Services.ToastLevel.Success);
                    // Обновляем локальную модель
                    currentUser = userInDb;
                }
                else
                {
                    ToastService.ShowToast("Ошибка при сохранении.", StandoffPortfolioTracker.AdminPanel.Services.ToastLevel.Error);
                }
            }
        }
    }

    private string GetProfileUrl() => $"{NavManager.BaseUri}profile/{currentUser.Id}";

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            if (file.Size > 2 * 1024 * 1024)
            {
                ToastService.ShowToast("Файл слишком большой! Макс 2MB.", StandoffPortfolioTracker.AdminPanel.Services.ToastLevel.Warning);
                return;
            }

            try
            {
                var fileName = $"{currentUser.Id}_{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
                var path = Path.Combine(Environment.WebRootPath, "uploads", "avatars", fileName);

                Directory.CreateDirectory(Path.GetDirectoryName(path)!);

                await using var stream = new FileStream(path, FileMode.Create);
                await file.OpenReadStream(2 * 1024 * 1024).CopyToAsync(stream);

                currentUser.AvatarUrl = $"/uploads/avatars/{fileName}";
                await SaveChanges();

                NavManager.NavigateTo(NavManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error: {ex.Message}");
                ToastService.ShowToast("Ошибка загрузки фото.", StandoffPortfolioTracker.AdminPanel.Services.ToastLevel.Error);
            }
        }
    }
}