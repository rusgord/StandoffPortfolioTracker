@page "/settings"
@using Microsoft.AspNetCore.Identity
@using StandoffPortfolioTracker.Core.Entities
@using System.Security.Claims
@using Microsoft.Extensions.DependencyInjection
@inject IServiceScopeFactory ScopeFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager
@inject IWebHostEnvironment Environment
@attribute [Authorize]
@rendermode InteractiveServer

<div class="container-fluid">
    <h3 class="mb-4 text-gray-800">⚙️ Настройки профиля</h3>

    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="list-group shadow-sm">
                <button class="list-group-item list-group-item-action @(activeTab == "general" ? "active" : "")" @onclick='() => activeTab = "general"'>
                    <i class="bi bi-person-badge me-2"></i> Основное
                </button>
                <button class="list-group-item list-group-item-action @(activeTab == "privacy" ? "active" : "")" @onclick='() => activeTab = "privacy"'>
                    <i class="bi bi-shield-lock me-2"></i> Приватность
                </button>
                <button class="list-group-item list-group-item-action @(activeTab == "security" ? "active" : "")" @onclick='() => activeTab = "security"'>
                    <i class="bi bi-key me-2"></i> Безопасность
                </button>
            </div>

            <div class="card mt-3 shadow-sm border-0 bg-light">
                <div class="card-body text-center">
                    <small class="text-muted">Ваша публичная ссылка:</small>
                    <div class="input-group input-group-sm mt-1">
                        <input type="text" class="form-control" value="@GetProfileUrl()" readonly />
                        <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText('@GetProfileUrl()')">📋</button>
                    </div>
                    <a href="profile/@currentUser?.Id" class="btn btn-sm btn-link mt-1">Посмотреть профиль</a>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card shadow mb-4">
                <div class="card-body">

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success alert-dismissible fade show">
                            @successMessage
                            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
                        </div>
                    }

                    @if (activeTab == "general")
                    {
                        <h5 class="mb-3">👤 Основная информация</h5>

                        <div class="d-flex align-items-center gap-4 mb-4">
                            <div class="position-relative">
                                <img src="@(string.IsNullOrEmpty(currentUser?.AvatarUrl) ? "/images/default-avatar.png" : currentUser.AvatarUrl)"
                                     class="rounded-circle border shadow-sm"
                                     style="width: 120px; height: 120px; object-fit: cover;" />
                            </div>

                            <div>
                                <label class="btn btn-primary btn-sm mb-2 cursor-pointer">
                                    <i class="bi bi-upload"></i> Загрузить новое фото
                                    <InputFile OnChange="HandleFileSelected" style="display:none;" accept=".jpg,.jpeg,.png" />
                                </label>
                                <div class="text-muted small">Поддерживаются JPG, PNG (макс. 2MB)</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Отображаемое имя</label>
                            <input type="text" class="form-control" @bind="currentUser.DisplayName" placeholder="Например: Gordan Play" />
                            <div class="form-text">Это имя будет видно всем.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted">Логин (Email)</label>
                            <input type="text" class="form-control bg-light" value="@currentUser.UserName" disabled />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Цель портфолио (G)</label>
                            <InputNumber class="form-control" @bind-Value="currentUser.PortfolioGoal" />
                        </div>

                        <button class="btn btn-primary" @onclick="SaveChanges">Сохранить изменения</button>
                    }

                    @if (activeTab == "privacy")
                    {
                        <h5 class="mb-3">🔒 Настройки приватности</h5>
                        <p class="text-muted small">Управляйте тем, что видят другие пользователи в вашем профиле.</p>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="publicProfile" @bind="currentUser.IsProfilePublic">
                            <label class="form-check-label" for="publicProfile">Публичный профиль (доступен по ссылке)</label>
                        </div>

                        <div class="border-top my-3"></div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="showVal" @bind="currentUser.ShowPortfolioValue" disabled="@(!currentUser.IsProfilePublic)">
                                <label class="form-check-label" for="showVal">Показывать общую стоимость портфеля</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="showGrowth" @bind="currentUser.ShowGrowth" disabled="@(!currentUser.IsProfilePublic)">
                                <label class="form-check-label" for="showGrowth">Показывать процент роста/падения</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="showTop" @bind="currentUser.ShowTopItems" disabled="@(!currentUser.IsProfilePublic)">
                                <label class="form-check-label" for="showTop">Показывать Топ-3 инвестиции</label>
                            </div>
                        </div>

                        <button class="btn btn-primary" @onclick="SaveChanges">Применить настройки</button>
                    }

                    @if (activeTab == "security")
                    {
                        <h5 class="mb-3">🔑 Безопасность</h5>
                        <div class="list-group">
                            <a href="Identity/Account/Manage/ChangePassword" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">Сменить пароль</div>
                                    <small class="text-muted">Обновите ваш пароль для входа</small>
                                </div>
                                <i class="bi bi-chevron-right"></i>
                            </a>
                            <a href="Identity/Account/Manage/ExternalLogins" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">Привязка соцсетей (Google)</div>
                                    <small class="text-muted">Управление внешними входами</small>
                                </div>
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </div>
                    }

                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string activeTab = "general";
    private ApplicationUser currentUser = new();
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        if (principal.Identity?.IsAuthenticated == true)
        {
            // 🔥 СОЗДАЕМ НОВЫЙ SCOPE ДЛЯ ЧТЕНИЯ (ИСПРАВЛЕНИЕ ОШИБКИ)
            using (var scope = ScopeFactory.CreateScope())
            {
                var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>();
                var user = await userManager.GetUserAsync(principal);
                if (user != null)
                {
                    currentUser = user;
                }
            }
        }
    }

    private async Task SaveChanges()
    {
        // 🔥 СОЗДАЕМ НОВЫЙ SCOPE ДЛЯ ЗАПИСИ (ИСПРАВЛЕНИЕ ОШИБКИ)
        using (var scope = ScopeFactory.CreateScope())
        {
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>();

            // 1. Загружаем свежую версию юзера из базы
            var userInDb = await userManager.FindByIdAsync(currentUser.Id);

            if (userInDb != null)
            {
                // 2. Переносим изменения
                userInDb.DisplayName = currentUser.DisplayName;
                userInDb.PortfolioGoal = currentUser.PortfolioGoal;
                userInDb.IsProfilePublic = currentUser.IsProfilePublic;
                userInDb.ShowPortfolioValue = currentUser.ShowPortfolioValue;
                userInDb.ShowGrowth = currentUser.ShowGrowth;
                userInDb.ShowTopItems = currentUser.ShowTopItems;
                userInDb.AvatarUrl = currentUser.AvatarUrl;

                // 3. Сохраняем
                var result = await userManager.UpdateAsync(userInDb);

                if (result.Succeeded)
                {
                    successMessage = "Настройки успешно сохранены!";
                    // Обновляем локальную переменную, чтобы интерфейс не дергался
                    currentUser = userInDb;
                }
            }
        }
    }

    private string GetProfileUrl() => $"{NavManager.BaseUri}profile/{currentUser.Id}";

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            // Лимит 2MB
            if (file.Size > 2 * 1024 * 1024) return;

            try
            {
                var fileName = $"{currentUser.Id}_{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
                var path = Path.Combine(Environment.WebRootPath, "uploads", "avatars", fileName);

                Directory.CreateDirectory(Path.GetDirectoryName(path)!);

                await using var stream = new FileStream(path, FileMode.Create);
                await file.OpenReadStream(2 * 1024 * 1024).CopyToAsync(stream);

                // Обновляем путь в модели
                currentUser.AvatarUrl = $"/uploads/avatars/{fileName}";

                // Сохраняем в базу (используя наш безопасный метод)
                await SaveChanges();

                // 🔥 Перезагружаем страницу, чтобы обновить шапку (MainLayout)
                NavManager.NavigateTo(NavManager.Uri, forceLoad: true);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading: {ex.Message}");
            }
        }
    }
}