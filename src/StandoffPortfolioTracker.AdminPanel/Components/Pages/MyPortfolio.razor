@page "/portfolio"
@using Microsoft.AspNetCore.Authorization
@using StandoffPortfolioTracker.Core.Entities
@using StandoffPortfolioTracker.Core.Enums
@using StandoffPortfolioTracker.AdminPanel.Services
@attribute [Authorize]
@inject PortfolioService PortfolioService
@inject ItemService ItemService
@inject PriceParserService ParserService
@rendermode InteractiveServer

<style>
    /* === Base Styles === */
    .text-gold {
        color: #f0ad4e;
        font-weight: 700;
        text-shadow: 0 0 1px rgba(240, 173, 78, 0.2);
    }

    /* Rarity Text Colors */
    .text-common {
        color: #B0C3D9;
    }

    .text-uncommon {
        color: #5E98D9;
    }

    .text-rare {
        color: #4B69FF;
    }

    .text-epic {
        color: #8847FF;
    }

    .text-legendary {
        color: #D32CE6;
    }

    .text-arcane {
        color: #EB4B4B;
    }

    .text-nameless {
        background: -webkit-linear-gradient(45deg, #FFD700, #FDB931);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: bold;
    }

    /* Backgrounds for Dots/Badges */
    .bg-common {
        background-color: #B0C3D9;
    }

    .bg-uncommon {
        background-color: #5E98D9;
    }

    .bg-rare {
        background-color: #4B69FF;
    }

    .bg-epic {
        background-color: #8847FF;
    }

    .bg-legendary {
        background-color: #D32CE6;
    }

    .bg-arcane {
        background-color: #EB4B4B;
    }

    .bg-nameless {
        background: linear-gradient(45deg, #FFD700, #FDB931);
    }

    /* Dropdowns */
    .custom-select-trigger {
        cursor: pointer;
        border: 1px solid #ced4da;
        padding: 4px 10px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        min-height: 31px;
        font-size: 0.85rem;
    }

        .custom-select-trigger:hover {
            background-color: #f8f9fa;
            border-color: #b6babc;
        }

    .custom-dropdown-menu {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        z-index: 1050;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-radius: 4px;
        margin-top: 2px;
    }

        .custom-dropdown-menu.show {
            display: block;
        }

    .dropdown-item-custom {
        padding: 6px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.85rem;
    }

        .dropdown-item-custom:hover {
            background-color: #e9ecef;
        }

    .item-thumb {
        width: 40px;
        height: 40px;
        object-fit: contain;
    }

    .col-thumb {
        width: 20px;
        height: 20px;
        object-fit: contain;
    }

    .rarity-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }

    .expanded-row {
        background-color: #f8f9fa;
        border-left: 4px solid #4e73df;
    }

    .history-input {
        width: 80px;
        text-align: right;
        padding: 2px 5px;
        font-size: 0.85rem;
    }

    /* Table Filters */
    .table-filter-input {
        font-size: 0.75rem;
        padding: 2px 5px;
        height: 28px;
    }

    .sortable-header {
        cursor: pointer;
        user-select: none;
    }

        .sortable-header:hover {
            background-color: #e2e6ea;
        }

    .filter-label {
        font-size: 0.65rem;
        color: #6c757d;
        margin-bottom: 0;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* === Customization Modal === */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .craft-modal {
        background: white;
        width: 700px;
        max-width: 95%;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }

    /* Gun Preview */
    .gun-preview-container {
        background: #e9ecef;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-bottom: 1px solid #dee2e6;
        min-height: 200px;
        position: relative;
    }

    .gun-preview-img {
        max-width: 80%;
        max-height: 150px;
        object-fit: contain;
        filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3));
        z-index: 1;
    }

    .gun-info-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 5px;
    }

    .gun-name-overlay {
        margin-top: 15px;
        background: rgba(255,255,255,0.9);
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        border: 1px solid #ccc;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 0.9rem;
    }

    /* Slots */
    .slot-container {
        display: flex;
        gap: 12px;
        justify-content: center;
        padding: 15px;
        background: #fff;
        border-bottom: 1px solid #dee2e6;
    }

    .craft-slot {
        width: 65px;
        height: 65px;
        border: 2px dashed #ccc;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        background: #f8f9fa;
        transition: all 0.2s;
    }

        .craft-slot:hover {
            border-color: #4e73df;
            background: #eef2ff;
        }

        .craft-slot.active {
            border-color: #4e73df;
            border-style: solid;
            box-shadow: 0 0 0 4px rgba(78, 115, 223, 0.15);
            transform: translateY(-2px);
        }

        .craft-slot img {
            width: 85%;
            height: 85%;
            object-fit: contain;
        }

    .slot-label {
        position: absolute;
        bottom: -20px;
        font-size: 0.65rem;
        color: #6c757d;
        width: 100%;
        text-align: center;
        font-weight: 600;
    }

    .slot-charm {
        border-color: #ffc107;
        border-style: solid;
    }

        .slot-charm .slot-label {
            color: #d39e00;
        }

    .remove-attachment {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Mini Attachments */
    .mini-attachment-container {
        display: flex;
        gap: 4px;
        align-items: center;
        margin-top: 4px;
    }

    .mini-attachment {
        width: 24px;
        height: 24px;
        object-fit: contain;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        background: #fff;
    }

    .mini-empty {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 1px dashed #adb5bd;
        background: #e9ecef;
        opacity: 0.3;
    }

    .mini-charm {
        border: 1px solid #ffc107;
        box-shadow: 0 0 2px #ffc107;
        border-radius: 50%;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>💼 My Investment Portfolio</h3>
    <div class="d-flex align-items-center gap-2 bg-light p-2 rounded border shadow-sm">
        @if (isCreatingPortfolio)
        {
            <input type="text" class="form-control form-control-sm" placeholder="Name..." @bind="newPortfolioName" style="width: 150px;" />
            <input type="text" class="form-control form-control-sm" placeholder="Description..." @bind="newPortfolioDesc" style="width: 150px;" />
            <button class="btn btn-sm btn-success" @onclick="SaveNewPortfolio">OK</button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="() => isCreatingPortfolio = false">✕</button>
        }
        else if (availablePortfolios.Any())
        {
            <label class="fw-bold text-muted small mb-0">Account:</label>
            <select class="form-select form-select-sm border-primary fw-bold" style="width: 200px;" @bind="currentPortfolioId" @bind:after="OnPortfolioChanged">
                @foreach (var p in availablePortfolios)
                {
                    <option value="@p.Id">@p.Name</option>
                }
            </select>
            <button class="btn btn-sm btn-outline-success" @onclick="() => isCreatingPortfolio = true">➕</button>
            <button class="btn btn-sm btn-outline-danger" @onclick="DeleteCurrentPortfolio">🗑</button>
        }
    </div>
</div>

@if (!availablePortfolios.Any() && !isCreatingPortfolio)
{
    <div class="text-center py-5"><div class="mb-4" style="font-size: 4rem;">👋</div><h3>Welcome!</h3><button class="btn btn-primary btn-lg mt-3" @onclick="() => isCreatingPortfolio = true">🚀 Create First Portfolio</button></div>
}
else
{
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">🔍 Add Asset</div>
                <div class="card-body">
                    <div class="row g-2 mb-3">
                        <div class="col-12"><input type="text" class="form-control form-control-sm" placeholder="Search Skin..." @bind="searchName" @bind:event="oninput" @onkeyup="FilterItems" /></div>
                        <div class="col-6">
                            <select class="form-select form-select-sm" @bind="selectedTypeString" @bind:after="OnTypeChanged">
                                <option value="">All Categories</option>
                                @foreach (var t in Enum.GetValues(typeof(ItemType)))
                                {
                                    <option value="@t">@t</option>
                                }
                            </select>
                        </div>
                        <div class="col-6">
                            @if (selectedTypeString == "Container")
                            {
                                <select class="form-select form-select-sm" @bind="selectedKindString" @bind:after="FilterItems">
                                    <option value="">All Containers</option>
                                    @foreach (var k in Enum.GetValues(typeof(ItemKind)).Cast<ItemKind>().Where(x => x != ItemKind.None))
                                    {
                                        <option value="@k">@k</option>
                                    }
                                </select>
                            }
                            else
                            {
                                <div class="custom-select-trigger" @onclick="() => isRarityFilterOpen = !isRarityFilterOpen">
                                    @if (string.IsNullOrEmpty(selectedRarity))
                                    {
                                        <span class="small">Any Rarity</span>
                                    }
                                    else
                                    {
                                        <span class="small fw-bold @GetRarityClass(Enum.Parse<ItemRarity>(selectedRarity))">@selectedRarity</span>
                                    }
                                    <span class="small text-muted">▼</span>
                                </div>
                                <div class="custom-dropdown-menu @(isRarityFilterOpen ? "show" : "")">
                                    <div class="dropdown-item-custom" @onclick='() => SelectRarityFilter("")'><span class="small">Any</span></div>
                                    @foreach (var r in Enum.GetValues(typeof(ItemRarity)).Cast<ItemRarity>())
                                    {
                                        <div class="dropdown-item-custom" @onclick="() => SelectRarityFilter(r.ToString())">
                                            <span class="rarity-dot @GetRarityBgClass(r)"></span><span class="small fw-bold @GetRarityClass(r)">@r</span>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        <div class="col-12 position-relative">
                            <div class="custom-select-trigger" @onclick="() => isCollectionFilterOpen = !isCollectionFilterOpen">
                                @if (selectedCollectionId == 0)
                                {
                                    <span class="small">All Collections</span>
                                }
                                else
                                {
                                    var c = collections.FirstOrDefault(x => x.Id == selectedCollectionId);
                                    <div class="d-flex align-items-center gap-2">@if (!string.IsNullOrEmpty(c?.ImageUrl))
                                        {
                                            <img src="@c.ImageUrl" class="col-thumb" referrerpolicy="no-referrer" />
                                        }<span class="small fw-bold">@c?.Name</span></div>
                                }
                                <span class="small text-muted">▼</span>
                            </div>
                            <div class="custom-dropdown-menu @(isCollectionFilterOpen ? "show" : "")">
                                <div class="dropdown-item-custom" @onclick="() => SelectCollectionFilter(0)"><span class="small">All Collections</span></div>
                                @foreach (var c in collections)
                                {
                                    <div class="dropdown-item-custom" @onclick="() => SelectCollectionFilter(c.Id)">
                                        @if (!string.IsNullOrEmpty(c.ImageUrl))
                                        {
                                            <img src="@c.ImageUrl" class="col-thumb" referrerpolicy="no-referrer" />
                                        }<span class="small">@c.Name</span>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="col-12 d-flex gap-3 mt-1 justify-content-center">
                            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="stFilter" @bind="isStatTrackFilter" @bind:after="FilterItems"><label class="form-check-label small" for="stFilter">StatTrack™</label></div>
                            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="patFilter" @bind="isPatternFilter" @bind:after="FilterItems"><label class="form-check-label small" for="patFilter">Pattern</label></div>
                        </div>
                    </div>
                    <hr />
                    <EditForm Model="@newItem" OnValidSubmit="HandleBuy">
                        <DataAnnotationsValidator />
                        <div class="mb-3 position-relative">
                            <label class="form-label fw-bold small">Select Skin:</label>
                            <div class="custom-select-trigger" @onclick="() => isItemDropdownOpen = !isItemDropdownOpen">
                                @if (selectedItemPreview != null)
                                {
                                    <div class="d-flex align-items-center gap-2">
                                        <img src="@selectedItemPreview.ImageUrl" class="item-thumb" referrerpolicy="no-referrer" />
                                        <div style="line-height:1.1;">
                                            <div class="d-flex align-items-center gap-1">
                                                @if (selectedItemPreview.IsStatTrack)
                                                {
                                                    <span class="badge bg-warning text-dark py-0" style="font-size:0.6em">ST</span>
                                                }
                                                @if (selectedItemPreview.IsPattern)
                                                {
                                                    <span class="badge bg-info text-white py-0" style="font-size:0.6em">P</span>
                                                }
                                                <span class="fw-bold small @GetDisplayColorClass(selectedItemPreview)">@selectedItemPreview.Name</span>
                                            </div>
                                            <div class="text-muted small">@selectedItemPreview.SkinName</div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted small">-- Click to Select --</span>
                                }
                                <span class="small">▼</span>
                            </div>
                            <div class="custom-dropdown-menu @(isItemDropdownOpen ? "show" : "")">
                                @foreach (var item in filteredItems.Take(50))
                                {
                                    <div class="dropdown-item-custom" @onclick="() => SelectItem(item)">
                                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                                        {
                                            <img src="@item.ImageUrl" class="item-thumb" referrerpolicy="no-referrer" />
                                        }
                                        <div style="width:100%">
                                            <div class="d-flex align-items-center gap-1">
                                                @if (item.IsStatTrack)
                                                {
                                                    <span class="badge bg-warning text-dark py-0" style="font-size:0.6em">ST</span>
                                                }
                                                @if (item.IsPattern)
                                                {
                                                    <span class="badge bg-info text-white py-0" style="font-size:0.6em">P</span>
                                                }
                                                <span class="small fw-bold @GetDisplayColorClass(item)">@item.Name</span>
                                            </div>
                                            <div class="text-muted small" style="font-size:0.7em;">@item.SkinName</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="mb-2"><div class="btn-group w-100" role="group"><input type="radio" class="btn-check" name="priceMode" id="modeUnit" checked="@(isUnitPriceMode)" @onchange="@(() => SetPriceMode(true))"><label class="btn btn-outline-primary btn-sm" for="modeUnit">Price Per Item</label><input type="radio" class="btn-check" name="priceMode" id="modeTotal" checked="@(!isUnitPriceMode)" @onchange="@(() => SetPriceMode(false))"><label class="btn btn-outline-primary btn-sm" for="modeTotal">Total Spent</label></div></div>
                        <div class="row g-2">
                            <div class="col-4 mb-3"><label class="small">Quantity</label><InputNumber @bind-Value="inputQuantity" class="form-control form-control-sm" @bind-Value:after="RecalculatePrice" min="1" /></div>
                            @if (isUnitPriceMode)
                            {
                                <div class="col-8 mb-3"><label class="small">Price Per Unit (G)</label><InputNumber @bind-Value="inputPricePerUnit" class="form-control form-control-sm" step="0.01" @bind-Value:after="RecalculatePrice" /><div class="text-muted small text-end mt-1">Total: @((inputQuantity * inputPricePerUnit).ToString("N2")) G</div></div>
                            }
                            else
                            {
                                <div class="col-8 mb-3"><label class="small">Total Spent (G)</label><InputNumber @bind-Value="inputTotalSpent" class="form-control form-control-sm" step="0.01" @bind-Value:after="RecalculatePrice" /><div class="text-muted small text-end mt-1">~ @((inputQuantity > 0 ? inputTotalSpent / inputQuantity : 0).ToString("N2")) G / each</div></div>
                            }
                        </div>
                        <button type="submit" class="btn btn-success w-100 btn-sm" disabled="@(newItem.ItemBaseId == 0)">➕ Add</button>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Portfolio Assets</span>
                    <button class="btn btn-sm btn-outline-primary" @onclick="UpdateAllPortfolioPrices">🔄 Update Prices</button>
                </div>
                <div class="card-body p-0">

                    <div class="bg-light p-3 border-bottom">
                        <div class="row g-2 mb-2 align-items-end">
                            <div class="col-md-3">
                                <div class="filter-label">Name</div>
                                <input type="text" class="form-control table-filter-input" placeholder="Search..." @bind="tableFilterName" @bind:event="oninput" />
                            </div>
                            <div class="col-md-3">
                                <div class="filter-label">Quantity</div>
                                <div class="d-flex gap-1">
                                    <input type="number" class="form-control table-filter-input" placeholder="Min" @bind="tableFilterQtyMin" />
                                    <input type="number" class="form-control table-filter-input" placeholder="Max" @bind="tableFilterQtyMax" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="filter-label">Price</div>
                                <div class="d-flex gap-1">
                                    <input type="number" class="form-control table-filter-input" placeholder="Min" @bind="tableFilterPriceMin" />
                                    <input type="number" class="form-control table-filter-input" placeholder="Max" @bind="tableFilterPriceMax" />
                                </div>
                            </div>
                            <div class="col-md-3 text-end align-self-center"><small class="text-muted">Rows: @FilteredInventory.Count()</small></div>
                        </div>

                        <div class="row g-2 align-items-end">
                            <div class="col-md-2">
                                <div class="filter-label">Type</div>
                                <select class="form-select table-filter-input" @bind="tableFilterType">
                                    <option value="">All Types</option>
                                    @foreach (var t in Enum.GetValues(typeof(ItemType)))
                                    {
                                        <option value="@t">@t</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-3 position-relative">
                                <div class="filter-label">Rarity</div>
                                <div class="form-control table-filter-input d-flex align-items-center justify-content-between" style="cursor:pointer;" @onclick="()=>isTableRarityOpen=!isTableRarityOpen">
                                    @if (tableFilterRarity == null)
                                    {
                                        <span>All</span>
                                    }
                                    else
                                    {
                                        <span class="text-truncate">@tableFilterRarity</span>
                                    } <span style="font-size:0.6em">▼</span>
                                </div>
                                <div class="custom-dropdown-menu @(isTableRarityOpen?"show":"")" style="top:100%;">
                                    <div class="dropdown-item-custom" @onclick="()=>SetTableRarity(null)">All</div>
                                    @foreach (var r in Enum.GetValues(typeof(ItemRarity)).Cast<ItemRarity>())
                                    {
                                        <div class="dropdown-item-custom" @onclick="()=>SetTableRarity(r)"><span class="rarity-dot @GetRarityBgClass(r)"></span><span class="@GetRarityClass(r)">@r</span></div>
                                    }
                                </div>
                            </div>

                            <div class="col-md-4 position-relative">
                                <div class="filter-label">Collection</div>
                                <div class="form-control table-filter-input d-flex align-items-center justify-content-between" style="cursor:pointer;" @onclick="()=>isTableCollectionOpen=!isTableCollectionOpen">
                                    @if (tableFilterCollection == 0)
                                    {
                                        <span>All Collections</span>
                                    }
                                    else
                                    {
                                        var c = collections.FirstOrDefault(x => x.Id == tableFilterCollection);
                                        <div class="d-flex gap-1 align-items-center text-truncate">@if (!string.IsNullOrEmpty(c?.ImageUrl))
                                            {
                                                <img src="@c.ImageUrl" style="width:12px;height:12px;object-fit:contain;" />
                                            }<span>@c?.Name</span></div>
                                    } <span style="font-size:0.6em">▼</span>
                                </div>
                                <div class="custom-dropdown-menu @(isTableCollectionOpen?"show":"")" style="top:100%;">
                                    <div class="dropdown-item-custom" @onclick="()=>SetTableCollection(0)">All Collections</div>
                                    @foreach (var c in collections)
                                    {
                                        <div class="dropdown-item-custom" @onclick="()=>SetTableCollection(c.Id)">@if (!string.IsNullOrEmpty(c.ImageUrl))
                                            {
                                                <img src="@c.ImageUrl" style="width:16px;height:16px;object-fit:contain;" />
                                            }<span class="small">@c.Name</span></div>
                                    }
                                </div>
                            </div>

                            <div class="col-md-3 d-flex gap-2">
                                <div class="form-check form-switch p-0" style="min-height:auto">
                                    <label class="form-check-label filter-label" for="tfST">ST</label>
                                    <input class="form-check-input ms-1" type="checkbox" id="tfST" @bind="tableFilterST" style="margin-left:0; float:none; height:12px; width:24px;">
                                </div>
                                <div class="form-check form-switch p-0" style="min-height:auto">
                                    <label class="form-check-label filter-label" for="tfPT">Pat</label>
                                    <input class="form-check-input ms-1" type="checkbox" id="tfPT" @bind="tableFilterPT" style="margin-left:0; float:none; height:12px; width:24px;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0 table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 30px;"></th>
                                    <th class="ps-3">Image</th>
                                    <th class="sortable-header" @onclick='() => Sort("Name")'>Item @SortIcon("Name")</th>
                                    <th class="sortable-header" @onclick='() => Sort("Quantity")'>Qty @SortIcon("Quantity")</th>
                                    <th class="sortable-header" @onclick='() => Sort("AvgBuy")'>Avg Buy @SortIcon("AvgBuy")</th>
                                    <th class="sortable-header" @onclick='() => Sort("TotalCost")'>Total Cost @SortIcon("TotalCost")</th>
                                    <th class="sortable-header" @onclick='() => Sort("Value")'>Value (w/ Crafts) @SortIcon("Value")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var group in FilteredInventory)
                                {
                                    var itemBase = group.Key;
                                    var totalQty = group.Sum(x => x.Quantity);
                                    var totalInvested = group.Sum(x => x.PurchasePrice * x.Quantity);
                                    var avgBuy = totalQty > 0 ? totalInvested / totalQty : 0;
                                    var marketPrice = itemBase.CurrentMarketPrice;
                                    var totalGroupValue = group.Sum(x => CalculateItemTotalValue(x));
                                    var isExpanded = expandedGroups.Contains(itemBase.Id);

                                    <tr style="cursor: pointer;" @onclick="() => ToggleGroup(itemBase.Id)">
                                        <td class="text-center text-muted small">@(isExpanded ? "▲" : "▼")</td>
                                        <td class="ps-3">@if (!string.IsNullOrEmpty(itemBase.ImageUrl))
                                            {
                                                <img src="@itemBase.ImageUrl" style="width:40px;height:40px;object-fit:contain;" referrerpolicy="no-referrer" />
                                            }</td>
                                        <td>
                                            <div class="d-flex align-items-center gap-1">
                                                @if (itemBase.IsStatTrack)
                                                {
                                                    <span class="badge bg-warning text-dark py-0" style="font-size:0.6em">ST</span>
                                                }
                                                @if (itemBase.IsPattern)
                                                {
                                                    <span class="badge bg-info text-white py-0" style="font-size:0.6em">P</span>
                                                }
                                                <span class="fw-bold small @GetDisplayColorClass(itemBase)">@itemBase.Name</span>
                                            </div>
                                            <div class="text-muted small">@itemBase.SkinName</div>
                                        </td>
                                        <td><span class="badge bg-secondary">x @totalQty</span></td>

                                        <td>@avgBuy.ToString("N2") <span class="text-gold">G</span></td>
                                        <td><span class="fw-bold">@totalInvested.ToString("N0")</span> <span class="text-gold">G</span></td>
                                        <td>
                                            <div class="fw-bold text-success">@totalGroupValue.ToString("N2") <span class="text-gold">G</span></div>
                                            @if (totalGroupValue > (marketPrice * totalQty))
                                            {
                                                <div class="text-muted fst-italic" style="font-size:0.7em;">inc. stickers</div>
                                            }
                                        </td>
                                    </tr>
                                    @if (isExpanded)
                                    {
                                        <tr class="expanded-row">
                                            <td colspan="7" class="p-3">
                                                <h6 class="small text-muted fw-bold mb-2">Purchase History & Actions:</h6>
                                                <table class="table table-sm table-borderless mb-0 w-100">
                                                    <thead><tr class="text-muted small"><th>Date / Crafts</th><th>Qty</th><th>Buy Price</th><th>Current / Added</th><th>Actions</th></tr></thead>
                                                    <tbody>
                                                        @foreach (var purchase in group.OrderByDescending(x => x.PurchaseDate))
                                                        {
                                                            var craftVal = CalculateCraftAddedValue(purchase);
                                                            var hasAttachments = purchase.Attachments != null && purchase.Attachments.Any();
                                                            <tr>
                                                                <td class="small">
                                                                    <div>@purchase.PurchaseDate.ToShortDateString()</div>
                                                                    @if (purchase.ItemBase.Type == ItemType.Guns && purchase.Quantity == 1)
                                                                    {
                                                                        <div class="mini-attachment-container">
                                                                            @for (int i = 1; i <= 4; i++)
                                                                            {
                                                                                var sticker = purchase.Attachments?.FirstOrDefault(a => a.SlotPosition == i);
                                                                                if (sticker?.Sticker != null)
                                                                                {
                                                                                    <img src="@sticker.Sticker.ImageUrl" title="@sticker.Sticker.SkinName" class="mini-attachment" referrerpolicy="no-referrer" />
                                                                                }
                                                                                else
                                                                                {
                                                                                    <div class="mini-empty"></div>
                                                                                }
                                                                            }
                                                                            @{
                                                                                var charm = purchase.Attachments?.FirstOrDefault(a => a.SlotPosition == 5);
                                                                            }
                                                                            @if (charm?.Sticker != null)
                                                                            {
                                                                                <div style="width:1px; height:16px; background:#ccc; margin:0 4px;"></div>
                                                                                <img src="@charm.Sticker.ImageUrl" title="Charm" class="mini-attachment mini-charm" referrerpolicy="no-referrer" />
                                                                            }
                                                                        </div>
                                                                    }
                                                                </td>
                                                                <td>
                                                                    <input type="number" class="form-control form-control-sm history-input" value="@purchase.Quantity"
                                                                           @onchange="@(e => UpdatePurchaseQty(purchase, e.Value))" disabled="@hasAttachments" title="@(hasAttachments ? "Remove stickers first" : "")" />
                                                                </td>
                                                                <td>
                                                                    <div class="input-group input-group-sm" style="width: 120px;">
                                                                        <input type="number" class="form-control history-input" value="@purchase.PurchasePrice" step="0.01" @onchange="@(e => UpdatePurchasePrice(purchase, e.Value))" />
                                                                        <span class="input-group-text text-gold">G</span>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div class="d-flex flex-column">
                                                                        <span class="fw-bold text-dark">@marketPrice.ToString("N2") <span class="text-gold">G</span></span>
                                                                        @if (craftVal > 0)
                                                                        {
                                                                            <span class="text-success small" style="font-size:0.75rem;">+@craftVal.ToString("N2") <span class="text-gold">G</span></span>
                                                                        }
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    @if (purchase.ItemBase.Type == ItemType.Guns)
                                                                    {
                                                                        <button class="btn btn-sm btn-outline-warning py-0 me-1"
                                                                                disabled="@(purchase.Quantity > 1)"
                                                                                @onclick="() => OpenCustomization(purchase)"
                                                                                @onclick:stopPropagation="true">
                                                                            🎨
                                                                        </button>
                                                                    }
                                                                    <button class="btn btn-sm btn-outline-danger py-0" @onclick="() => Delete(purchase.Id)" @onclick:stopPropagation="true">×</button>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (isCustomizing && currentCustomizingItem != null)
{
    <div class="modal-overlay" @onclick="CloseCustomization">
        <div class="craft-modal" @onclick:stopPropagation="true">
            <div class="modal-header p-3 bg-light d-flex justify-content-between align-items-center border-bottom">
                <h5 class="m-0">🛠 Customization</h5>
                <button type="button" class="btn-close" @onclick="CloseCustomization"></button>
            </div>

            <div class="gun-preview-container">
                <div class="gun-info-badge">
                    @if (currentCustomizingItem.ItemBase.IsStatTrack)
                    {
                        <span class="badge bg-warning text-dark py-1">StatTrack™</span>
                    }
                    @if (currentCustomizingItem.ItemBase.IsPattern)
                    {
                        <span class="badge bg-info text-white py-1">Pattern</span>
                    }
                </div>

                @if (!string.IsNullOrEmpty(currentCustomizingItem.ItemBase?.ImageUrl))
                {
                    <img src="@currentCustomizingItem.ItemBase.ImageUrl" class="gun-preview-img" referrerpolicy="no-referrer" />
                }

                <div class="gun-name-overlay @GetDisplayColorClass(currentCustomizingItem.ItemBase)">
                    @currentCustomizingItem.ItemBase?.Name | @currentCustomizingItem.ItemBase?.SkinName
                </div>
            </div>

            <div class="slot-container">
                @for (int i = 1; i <= 4; i++)
                {
                    var idx = i;
                    var att = currentAttachments.FirstOrDefault(x => x.SlotPosition == idx);
                    <div class="craft-slot @(activeSlot==idx?"active":"")" @onclick="() => SelectSlot(idx)">
                        @if (att?.Sticker != null)
                        {
                            <img src="@att.Sticker.ImageUrl" /> <div class="remove-attachment" @onclick="()=>RemoveAttachment(idx)" @onclick:stopPropagation="true">×</div>
                        }
                        else
                        {
                            <span class="text-muted small">Sticker</span>
                        }
                        <div class="slot-label">Pos @idx</div>
                    </div>
                }
                <div style="width:1px;background:#ddd;"></div>
                @{
                    var cSlot = 5; var ch = currentAttachments.FirstOrDefault(x => x.SlotPosition == cSlot);
                }
                <div class="craft-slot slot-charm @(activeSlot==cSlot?"active":"")" @onclick="()=>SelectSlot(cSlot)">
                    @if (ch?.Sticker != null)
                    {
                        <img src="@ch.Sticker.ImageUrl" /> <div class="remove-attachment bg-warning text-dark border-0" style="top:-10px;right:-10px;width:auto;padding:0 5px;border-radius:10px;font-size:10px;" @onclick="DetachCharm" @onclick:stopPropagation="true">⬇ Detach</div>
                    }
                    else
                    {
                        <span class="text-muted small">Charm</span>
                    }
                    <div class="slot-label">Charm</div>
                </div>
            </div>
            <div class="p-3 bg-white flex-grow-1 d-flex flex-column" style="min-height: 250px;">
                @if (activeSlot != -1)
                {
                    <div class="input-group input-group-sm mb-2"><input type="text" class="form-control" placeholder="Search..." @bind="attachmentSearch" @bind:event="oninput" /></div>
                    <div class="list-group flex-grow-1 overflow-auto" style="max-height: 200px;">
                        @foreach (var item in GetAvailableAttachments())
                        {
                            <button class="list-group-item list-group-item-action d-flex align-items-center gap-2 p-2" @onclick="() => ApplyAttachment(item)">
                                <img src="@item.ImageUrl" style="width:30px;height:30px;object-fit:contain;" />
                                <div class="w-100">
                                    <div class="d-flex justify-content-between">
                                        <span class="small fw-bold @GetRarityClass(item.Rarity)">@item.SkinName</span>
                                        <span class="small text-muted">@item.CurrentMarketPrice.ToString("N2") <span class="text-gold">G</span></span>
                                    </div>
                                    <div class="small text-muted" style="font-size:0.7em;">@item.Name</div>
                                </div>
                            </button>
                        }
                        @if (!GetAvailableAttachments().Any())
                        {
                            <div class="text-center text-muted mt-4">Ничего не найдено</div>
                        }
                    </div>
                }
                else
                {
                    <div class="d-flex align-items-center justify-content-center h-100 text-muted">Select a slot</div>
                }
            </div>
            <div class="modal-footer p-2 bg-light border-top d-flex justify-content-between">
                <div class="small text-muted ps-2">Added: <span class="fw-bold text-success">+@CalculateCurrentCraftValue().ToString("N2") <span class="text-gold">G</span></span></div>
                <button class="btn btn-primary btn-sm px-4" @onclick="SaveCustomization">Save</button>
            </div>
        </div>
    </div>
}

@code {
    private List<ItemBase> allItems = new();
    private List<ItemBase> filteredItems = new();
    private List<GameCollection> collections = new();
    private List<InventoryItem> inventory = new();
    private List<PortfolioAccount> availablePortfolios = new();
    private string sortColumn = "TotalCost";
    private bool sortAscending = false;
    private string tableFilterName = "";
    private int? tableFilterQtyMin;
    private int? tableFilterQtyMax;
    private decimal? tableFilterPriceMin;
    private decimal? tableFilterPriceMax;
    private ItemType? tableFilterType = null;
    private ItemRarity? tableFilterRarity = null;
    private int tableFilterCollection = 0;
    private bool tableFilterST = false;
    private bool tableFilterPT = false;
    private bool isTableRarityOpen = false;
    private bool isTableCollectionOpen = false;
    private IEnumerable<IGrouping<ItemBase, InventoryItem>> FilteredInventory { get { var query = inventory.AsEnumerable(); if (!string.IsNullOrWhiteSpace(tableFilterName)) query = query.Where(i => (i.ItemBase.Name + i.ItemBase.SkinName).Contains(tableFilterName, StringComparison.OrdinalIgnoreCase)); if (tableFilterQtyMin.HasValue) query = query.Where(i => i.Quantity >= tableFilterQtyMin.Value); if (tableFilterQtyMax.HasValue) query = query.Where(i => i.Quantity <= tableFilterQtyMax.Value); if (tableFilterPriceMin.HasValue) query = query.Where(i => i.PurchasePrice >= tableFilterPriceMin.Value); if (tableFilterPriceMax.HasValue) query = query.Where(i => i.PurchasePrice <= tableFilterPriceMax.Value); if (tableFilterType.HasValue) query = query.Where(i => i.ItemBase.Type == tableFilterType.Value); if (tableFilterRarity.HasValue) query = query.Where(i => i.ItemBase.Rarity == tableFilterRarity.Value); if (tableFilterCollection > 0) query = query.Where(i => i.ItemBase.CollectionId == tableFilterCollection); if (tableFilterST) query = query.Where(i => i.ItemBase.IsStatTrack); if (tableFilterPT) query = query.Where(i => i.ItemBase.IsPattern); var grouped = query.Where(i => i.ItemBase != null).GroupBy(i => i.ItemBase!); switch (sortColumn) { case "Name": return sortAscending ? grouped.OrderBy(g => g.Key.Name) : grouped.OrderByDescending(g => g.Key.Name); case "Quantity": return sortAscending ? grouped.OrderBy(g => g.Sum(x => x.Quantity)) : grouped.OrderByDescending(g => g.Sum(x => x.Quantity)); case "AvgBuy": return sortAscending ? grouped.OrderBy(g => g.Sum(x => x.PurchasePrice * x.Quantity) / (g.Sum(x => x.Quantity) == 0 ? 1 : g.Sum(x => x.Quantity))) : grouped.OrderByDescending(g => g.Sum(x => x.PurchasePrice * x.Quantity) / (g.Sum(x => x.Quantity) == 0 ? 1 : g.Sum(x => x.Quantity))); case "TotalCost": return sortAscending ? grouped.OrderBy(g => g.Sum(x => x.PurchasePrice * x.Quantity)) : grouped.OrderByDescending(g => g.Sum(x => x.PurchasePrice * x.Quantity)); case "Value": return sortAscending ? grouped.OrderBy(g => g.Sum(x => CalculateItemTotalValue(x))) : grouped.OrderByDescending(g => g.Sum(x => CalculateItemTotalValue(x))); default: return grouped; } } }
    private IEnumerable<IGrouping<ItemBase, InventoryItem>> GroupedInventory => FilteredInventory;
    private bool isCustomizing = false;
    private InventoryItem? currentCustomizingItem;
    private List<AppliedAttachment> currentAttachments = new();
    private int activeSlot = -1;
    private string attachmentSearch = "";
    private InventoryItem newItem = new() { Quantity = 1 };
    private ItemBase? selectedItemPreview;
    private bool isUnitPriceMode = true;
    private decimal inputPricePerUnit;
    private int inputQuantity = 1;
    private decimal inputTotalSpent;
    private int currentPortfolioId = 0;
    private bool isCreatingPortfolio = false;
    private string newPortfolioName = "";
    private string newPortfolioDesc = "";
    private string searchName = "";
    private string selectedTypeString = "";
    private string selectedKindString = "";
    private string selectedRarity = "";
    private int selectedCollectionId = 0;
    private bool isStatTrackFilter = false;
    private bool isPatternFilter = false;
    private bool isItemDropdownOpen = false;
    private bool isCollectionFilterOpen = false;
    private bool isRarityFilterOpen = false;
    private HashSet<int> expandedGroups = new();
    protected override async Task OnInitializedAsync() { allItems = await ItemService.GetAllItemsAsync(); collections = await ItemService.GetCollectionsAsync(); await LoadPortfolios(); FilterItems(); }
    private async Task LoadPortfolios() { availablePortfolios = await PortfolioService.GetMyAccountsAsync(); if (availablePortfolios.Any()) { currentPortfolioId = availablePortfolios.First().Id; await LoadInventory(); } }
    private async Task LoadInventory() { inventory = await PortfolioService.GetMyInventoryAsync(currentPortfolioId); StateHasChanged(); }
    private async Task OnPortfolioChanged() => await LoadInventory();
    private void Sort(string column) { if (sortColumn == column) sortAscending = !sortAscending; else { sortColumn = column; sortAscending = true; } }
    private string SortIcon(string column) { if (sortColumn != column) return "↕"; return sortAscending ? "▲" : "▼"; }
    private void SetTableRarity(ItemRarity? r) { tableFilterRarity = r; isTableRarityOpen = false; }
    private void SetTableCollection(int id) { tableFilterCollection = id; isTableCollectionOpen = false; }
    private void SetPriceMode(bool isUnit) { isUnitPriceMode = isUnit; RecalculatePrice(); }
    private void RecalculatePrice() { if (inputQuantity <= 0) inputQuantity = 1; if (isUnitPriceMode) inputTotalSpent = inputPricePerUnit * inputQuantity; else inputPricePerUnit = inputQuantity > 0 ? inputTotalSpent / inputQuantity : 0; }
    private void SelectItem(ItemBase item) { newItem.ItemBaseId = item.Id; selectedItemPreview = item; inputPricePerUnit = Math.Round(item.CurrentMarketPrice, 2); inputQuantity = 1; isUnitPriceMode = true; RecalculatePrice(); isItemDropdownOpen = false; }
    private async Task HandleBuy() { if (newItem.ItemBaseId == 0 || currentPortfolioId == 0) return; newItem.PortfolioAccountId = currentPortfolioId; newItem.PurchaseDate = DateTime.Now; newItem.Quantity = inputQuantity; newItem.PurchasePrice = inputPricePerUnit; await PortfolioService.AddPurchaseAsync(newItem); newItem = new InventoryItem { Quantity = 1, ItemBaseId = 0 }; selectedItemPreview = null; inputPricePerUnit = 0; inputTotalSpent = 0; inputQuantity = 1; await LoadInventory(); }
    private void ToggleGroup(int id) { if (expandedGroups.Contains(id)) expandedGroups.Remove(id); else expandedGroups.Add(id); }
    private async Task UpdatePurchaseQty(InventoryItem item, object? value) { if (int.TryParse(value?.ToString(), out int qty) && qty > 0) { item.Quantity = qty; await PortfolioService.UpdatePurchaseAsync(item); await LoadInventory(); } }
    private async Task UpdatePurchasePrice(InventoryItem item, object? value) { if (decimal.TryParse(value?.ToString(), out decimal price) && price >= 0) { item.PurchasePrice = price; await PortfolioService.UpdatePurchaseAsync(item); await LoadInventory(); } }
    private async Task Delete(int id) { await PortfolioService.DeleteItemAsync(id); await LoadInventory(); }
    private async Task UpdateAllPortfolioPrices() { await ParserService.UpdatePortfolioPricesAsync(); await LoadInventory(); }
    private void OnTypeChanged() { selectedKindString = ""; FilterItems(); }
    private void SelectCollectionFilter(int id) { selectedCollectionId = id; isCollectionFilterOpen = false; FilterItems(); }
    private void SelectRarityFilter(string r) { selectedRarity = r; isRarityFilterOpen = false; FilterItems(); }
    private void FilterItems() { var q = allItems.AsEnumerable(); if (!string.IsNullOrWhiteSpace(searchName)) q = q.Where(i => (i.Name + i.SkinName).Contains(searchName, StringComparison.OrdinalIgnoreCase)); if (!string.IsNullOrEmpty(selectedTypeString) && Enum.TryParse<ItemType>(selectedTypeString, out var t)) q = q.Where(i => i.Type == t); if (!string.IsNullOrEmpty(selectedKindString) && Enum.TryParse<ItemKind>(selectedKindString, out var k)) q = q.Where(i => i.Kind == k); if (!string.IsNullOrEmpty(selectedRarity)) q = q.Where(i => i.Rarity.ToString() == selectedRarity); if (selectedCollectionId > 0) q = q.Where(i => i.CollectionId == selectedCollectionId); if (isStatTrackFilter) q = q.Where(i => i.IsStatTrack); if (isPatternFilter) q = q.Where(i => i.IsPattern); filteredItems = q.OrderBy(i => i.Name).Take(50).ToList(); }
    private async Task SaveNewPortfolio() { if (!string.IsNullOrWhiteSpace(newPortfolioName)) { await PortfolioService.CreateAccountAsync(newPortfolioName, newPortfolioDesc); newPortfolioName = ""; newPortfolioDesc = ""; isCreatingPortfolio = false; await LoadPortfolios(); } }
    private async Task DeleteCurrentPortfolio() { await PortfolioService.DeleteAccountAsync(currentPortfolioId); currentPortfolioId = 0; await LoadPortfolios(); }
    private void OpenCustomization(InventoryItem item) { currentCustomizingItem = item; currentAttachments = item.Attachments.Select(a => new AppliedAttachment { Id = a.Id, InventoryItemId = item.Id, StickerId = a.StickerId, Sticker = a.Sticker, SlotPosition = a.SlotPosition }).ToList(); activeSlot = -1; attachmentSearch = ""; isCustomizing = true; }
    private void CloseCustomization() { isCustomizing = false; currentCustomizingItem = null; }
    private void SelectSlot(int index) { activeSlot = index; }
    private void RemoveAttachment(int index) { var ex = currentAttachments.FirstOrDefault(x => x.SlotPosition == index); if (ex != null) currentAttachments.Remove(ex); }
    private IEnumerable<ItemBase> GetAvailableAttachments() { if (activeSlot == -1) return Enumerable.Empty<ItemBase>(); var q = allItems.AsEnumerable(); if (activeSlot == 5) q = q.Where(x => x.Type == ItemType.Charm); else q = q.Where(x => x.Type == ItemType.Sticker); if (!string.IsNullOrWhiteSpace(attachmentSearch)) q = q.Where(x => x.Name.Contains(attachmentSearch, StringComparison.OrdinalIgnoreCase) || x.SkinName.Contains(attachmentSearch, StringComparison.OrdinalIgnoreCase)); return q.Take(20); }
    private void ApplyAttachment(ItemBase item) { RemoveAttachment(activeSlot); currentAttachments.Add(new AppliedAttachment { StickerId = item.Id, Sticker = item, SlotPosition = activeSlot, InventoryItemId = currentCustomizingItem!.Id }); if (activeSlot >= 1 && activeSlot < 4) activeSlot++; }
    private async Task SaveCustomization() { if (currentCustomizingItem == null) return; await PortfolioService.SaveAttachmentsAsync(currentCustomizingItem.Id, currentAttachments); isCustomizing = false; await LoadInventory(); }
    private async Task DetachCharm() { var ch = currentAttachments.FirstOrDefault(x => x.SlotPosition == 5); if (ch == null || currentCustomizingItem == null) return; await PortfolioService.AddPurchaseAsync(new InventoryItem { ItemBaseId = ch.StickerId, PortfolioAccountId = currentCustomizingItem.PortfolioAccountId, PurchasePrice = 0, Quantity = 1, PurchaseDate = DateTime.Now }); currentAttachments.Remove(ch); await SaveCustomization(); }
    private decimal CalculateCraftAddedValue(InventoryItem item) { if (item.Attachments == null) return 0; decimal added = 0; foreach (var att in item.Attachments) { if (att.Sticker == null) continue; decimal p = att.Sticker.CurrentMarketPrice; if (att.SlotPosition == 5) added += p; else { decimal pct = p < 100 ? 0.2m : (p < 1000 ? 0.1m : 0.05m); added += p * pct; } } return added; }
    private decimal CalculateCurrentCraftValue() => CalculateCraftAddedValue(new InventoryItem { Attachments = currentAttachments });
    private decimal CalculateItemTotalValue(InventoryItem item) => (item.ItemBase?.CurrentMarketPrice ?? 0) + CalculateCraftAddedValue(item);
    private string GetDisplayColorClass(ItemBase item) { if (item.Type == ItemType.Container && (item.Kind == ItemKind.Case || item.Kind == ItemKind.StickerPack || item.Kind == ItemKind.CharmPack || item.Kind == ItemKind.GraffitiPack)) return "text-nameless"; return GetRarityClass(item.Rarity); }
    private string GetRarityClass(ItemRarity r) => r switch { ItemRarity.Common => "text-common", ItemRarity.Uncommon => "text-uncommon", ItemRarity.Rare => "text-rare", ItemRarity.Epic => "text-epic", ItemRarity.Legendary => "text-legendary", ItemRarity.Arcane => "text-arcane", ItemRarity.Nameless => "text-nameless", _ => "text-dark" };
    private string GetRarityBgClass(ItemRarity r) => r switch { ItemRarity.Common => "bg-common", ItemRarity.Uncommon => "bg-uncommon", ItemRarity.Rare => "bg-rare", ItemRarity.Epic => "bg-epic", ItemRarity.Legendary => "bg-legendary", ItemRarity.Arcane => "bg-arcane", ItemRarity.Nameless => "bg-nameless", _ => "bg-light" };
}