@page "/portfolio"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using StandoffPortfolioTracker.Core.Entities
@using StandoffPortfolioTracker.Core.Enums
@using StandoffPortfolioTracker.AdminPanel.Services
@using System.Security.Claims
@attribute [Authorize]
@inject PortfolioService PortfolioService
@inject ItemService ItemService
@inject PriceParserService ParserService
@inject GlobalNotificationService GlobalNotifier
@inject ToastService ToastService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@rendermode InteractiveServer

<style>
    /* === Global & Typography === */
    body {
        background-color: #f8f9fc;
        color: #2c3e50;
    }

    .text-gold {
        color: #d4a017 !important;
        font-weight: 700;
    }

    /* === Stats Cards === */
    .stats-card {
        background: #fff;
        border: 1px solid rgba(0,0,0,0.05);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stats-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #858796;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .stats-value {
        font-size: 1.8rem;
        font-weight: 800;
        color: #2c3e50;
    }

    .stats-sub {
        font-size: 0.9rem;
        font-weight: 600;
        margin-top: 5px;
    }

    /* === Rarity Colors & Badges === */
    .text-common {
        color: #8fa0b5;
    }

    .text-uncommon {
        color: #4a8ad4;
    }

    .text-rare {
        color: #3555f5;
    }

    .text-epic {
        color: #7329f0;
    }

    .text-legendary {
        color: #c41bd6;
    }

    .text-arcane {
        color: #de3535;
    }

    .text-nameless {
        background: -webkit-linear-gradient(45deg, #FFD700, #DAA520);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 600;
    }

    .bg-common {
        background-color: #B0C3D9;
        color: #333;
    }

    .bg-uncommon {
        background-color: #5E98D9;
    }

    .bg-rare {
        background-color: #4B69FF;
    }

    .bg-epic {
        background-color: #8847FF;
    }

    .bg-legendary {
        background-color: #D32CE6;
    }

    .bg-arcane {
        background-color: #EB4B4B;
    }

    .bg-nameless {
        background: linear-gradient(45deg, #FFD700, #FDB931);
        color: #333;
    }

    /* === Layout === */
    .modern-card {
        background: white;
        border: 1px solid rgba(0,0,0,0.05);
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: visible;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card-header-clean {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #edf0f2;
        background: #fff;
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* === Custom Dropdown === */
    .custom-select-trigger {
        background: #fff;
        border: 1px solid #e3e6f0;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.9rem;
        color: #495057;
        user-select: none;
        transition: all 0.2s;
    }

        .custom-select-trigger:hover {
            border-color: #4e73df;
            color: #4e73df;
        }

    .custom-dropdown-container {
        position: relative;
    }

    .custom-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 100%;
        width: max-content;
        background: white;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        z-index: 9999;
        display: none;
        max-height: 300px;
        overflow-y: auto;
        padding: 6px 0;
        margin-top: 4px;
    }

        .custom-dropdown-menu.show {
            display: block;
            animation: fadeIn 0.2s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

    .dropdown-item-custom {
        padding: 8px 16px;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #333;
        transition: background 0.1s;
    }

        .dropdown-item-custom:hover {
            background-color: #f0f4ff;
            color: #4e73df;
        }

    .col-thumb {
        width: 24px;
        height: 24px;
        object-fit: contain;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 2px;
        box-shadow: 0 0 8px rgba(0,0,0,0.08);
    }

    /* === Filters & Table === */
    .filter-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #e3e6f0;
        background: #f8f9fa;
        color: #6c757d;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 700;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        user-select: none;
    }

        .filter-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .filter-btn.active-st {
            background: linear-gradient(135deg, #ffd700 0%, #fdb931 100%);
            color: #343a40;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(253, 185, 49, 0.4);
        }

        .filter-btn.active-pat {
            background: linear-gradient(135deg, #4b69ff 0%, #3555f5 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(75, 105, 255, 0.4);
        }

    .table-container {
        flex-grow: 1;
        overflow-y: auto;
        min-height: 400px;
        border-radius: 0 0 16px 16px;
    }

    .inventory-table thead th {
        background: #f8f9fc;
        position: sticky;
        top: 0;
        z-index: 10;
        border-bottom: 2px solid #e3e6f0;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #858796;
        font-weight: 700;
        padding: 12px 16px;
    }

    .inventory-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
    }

    .inventory-row {
        border-left: 4px solid transparent;
        transition: background 0.1s;
    }

        .inventory-row:hover td {
            background-color: #fcfcfd;
        }

    .row-common {
        border-left-color: #B0C3D9;
    }

    .row-uncommon {
        border-left-color: #5E98D9;
    }

    .row-rare {
        border-left-color: #4B69FF;
    }

    .row-epic {
        border-left-color: #8847FF;
    }

    .row-legendary {
        border-left-color: #D32CE6;
    }

    .row-arcane {
        border-left-color: #EB4B4B;
    }

    .row-nameless {
        border-left-color: #FFD700;
    }

    .expanded-details {
        background: #f8f9fa;
        box-shadow: inset 0 3px 6px rgba(0,0,0,0.02);
    }

    .item-thumb-lg {
        width: 50px;
        height: 50px;
        object-fit: contain;
        background: #fff;
        border-radius: 6px;
        border: 1px solid #f0f0f0;
        padding: 2px;
    }

    .item-thumb-sm {
        width: 32px;
        height: 32px;
        object-fit: contain;
    }

    /* === Helpers === */
    .mini-stickers-row {
        display: flex;
        gap: 4px;
    }

    .mini-sticker {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #fff;
        border: 1px solid #eee;
        padding: 2px;
        object-fit: contain;
    }

    .mini-empty {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e9ecef;
        border: 1px dashed #ccc;
        opacity: 0.5;
    }

    .spin-icon {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        100% {
            transform: rotate(360deg);
        }
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .locked-feature {
        opacity: 0.5;
        pointer-events: none;
        position: relative;
    }

    .badge-mini {
        font-size: 0.6rem;
        font-weight: 800;
        padding: 2px 6px;
        border-radius: 4px;
        letter-spacing: 0.5px;
        line-height: 1;
    }

    .badge-premium {
        color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.2);
    }

    .badge-lite {
        color: #0dcaf0;
        background: rgba(13, 202, 240, 0.1);
        border: 1px solid rgba(13, 202, 240, 0.2);
    }

    /* === Customization Modal Styles (from previous) === */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .craft-modal {
        background: #fff;
        width: 900px;
        max-width: 95%;
        max-height: 90vh;
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .gun-preview-container {
        background: radial-gradient(circle, #f8f9fa 0%, #e9ecef 100%);
        min-height: 240px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        border-bottom: 1px solid #e3e6f0;
    }

    .craft-slot {
        width: 80px;
        height: 80px;
        background: #fff;
        border: 2px dashed #ccc;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
    }

        .craft-slot:hover {
            transform: translateY(-3px);
            border-color: #4e73df;
        }

        .craft-slot.active {
            border-color: #4e73df;
            background: #f4f6fd;
            box-shadow: 0 0 0 3px rgba(78,115,223,0.2);
        }

    .remove-attachment {
        position: absolute;
        top: -10px;
        right: -10px;
        width: 24px;
        height: 24px;
        background: #e74a3b;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        cursor: pointer;
        z-index: 5;
    }

    .charm-action-btn {
        position: absolute;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        border: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: transform 0.1s;
    }

        .charm-action-btn:hover {
            transform: scale(1.1);
        }

    .btn-detach {
        top: -10px;
        right: -10px;
        background: #f6c23e;
        color: #333;
        z-index: 6;
    }

    .btn-delete {
        top: -10px;
        left: -10px;
        background: #e74a3b;
        color: white;
        z-index: 6;
    }
</style>

<div class="container-fluid py-4" @onclick="CloseAllDropdowns">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h1 class="h3 fw-bold text-dark mb-1">💼 Мой Портфель</h1>
            <p class="text-muted small mb-0">Управляйте своими активами и отслеживайте их стоимость.</p>
        </div>

        @if (!isLoading && availablePortfolios.Any())
        {
            <div class="d-flex align-items-center gap-2 bg-white p-2 rounded-4 shadow-sm border">
                <div class="px-3 border-end">
                    <span class="text-xs text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Аккаунт</span>
                </div>

                <div class="custom-dropdown-container">
                    <div class="custom-select-trigger border-0 bg-transparent p-0" style="min-width: 150px;" @onclick="() => ToggleDropdown(ref isPortfolioDropdownOpen)" @onclick:stopPropagation>
                        <span class="fw-bold text-dark fs-6">@GetPortfolioName(currentPortfolioId)</span>
                        <i class="bi bi-chevron-down small text-muted ms-2"></i>
                    </div>
                    <div class="custom-dropdown-menu @(isPortfolioDropdownOpen ? "show" : "")">
                        @foreach (var p in availablePortfolios)
                        {
                            <div class="dropdown-item-custom @(currentPortfolioId == p.Id ? "bg-light text-primary fw-bold" : "")" @onclick="() => SelectPortfolio(p.Id)">
                                💼 @p.Name
                            </div>
                        }
                    </div>
                </div>

                <div class="vr mx-1"></div>
                <button class="btn btn-sm btn-outline-primary rounded-circle" style="width: 32px; height: 32px;" title="Создать новый" @onclick="StartCreatePortfolio">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger rounded-circle" style="width: 32px; height: 32px;" title="Удалить текущий" @onclick="DeleteCurrentPortfolio">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        }
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 50vh;">
            <div class="text-center">
                <div class="spinner-border mb-3" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="text-muted fw-bold">Загрузка портфелей...</p>
            </div>
        </div>
    }
    else if (!availablePortfolios.Any() && !isCreatingPortfolio)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 50vh;">
            <div class="text-center p-5 bg-white rounded-4 shadow-sm border">
                <div class="mb-3 display-1 opacity-25">📂</div>
                <h3 class="fw-bold">Добро пожаловать!</h3>
                <p class="text-muted mb-4">Создайте свой первый портфель для начала работы.</p>
                <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" @onclick="StartCreatePortfolio">
                    🚀 Создать портфель
                </button>
            </div>
        </div>
    }
    else if (isCreatingPortfolio)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 50vh;">
            <div class="text-center p-5 bg-white rounded-4 shadow-sm border">
                <h3 class="fw-bold mb-3">Создание портфеля</h3>
                <div class="d-flex gap-2 justify-content-center">
                    <input type="text" class="form-control form-control-sm border-0 bg-light rounded-pill px-3" placeholder="Название..." @bind="newPortfolioName" style="width: 250px;" />
                    <button class="btn btn-sm btn-success rounded-pill px-4 fw-bold" @onclick="SaveNewPortfolio">ОК</button>
                    <button class="btn btn-sm btn-light rounded-circle" @onclick="() => isCreatingPortfolio = false">✕</button>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-label">Текущая стоимость</div>
                    <div class="stats-value">@GetTotalPortfolioValue().ToString("N2") <span class="text-gold fs-5">G</span></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-label">Вложено средств</div>
                    <div class="stats-value text-muted">@GetTotalInvested().ToString("N2") <span class="fs-5 text-secondary">G</span></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-label">Прибыль</div>
                    @{
                        var profit = GetTotalPortfolioValue() - GetTotalInvested();
                        var profitClass = profit >= 0 ? "text-success" : "text-danger";
                        var profitSign = profit >= 0 ? "+" : "";
                    }
                    <div class="stats-value @profitClass">@profitSign@profit.ToString("N2") <span class="fs-5">G</span></div>
                    <div class="stats-sub @profitClass">
                        @if (GetTotalInvested() > 0)
                        {
                            <span>@profitSign@(((profit / GetTotalInvested()) * 100).ToString("N2"))%</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 h-100">
            <div class="col-lg-12">
                <div class="modern-card h-100">
                    <div class="card-header-clean">
                        <h6 class="m-0 fw-bold text-dark"><i class="bi bi-list-ul me-2 text-primary"></i>Список активов</h6>

                        <div class="d-flex align-items-center gap-2">
                            @if (!CanUpdatePrices())
                            {
                                <span class="badge bg-warning text-dark"><i class="bi bi-lock-fill me-1"></i>Premium Only</span>
                            }
                            <button class="btn btn-sm btn-light border shadow-sm text-primary fw-bold me-2"
                                    @onclick="UpdateAllPortfolioPrices" disabled="@(!CanUpdatePrices() || isUpdatingPrices)" title="@(!CanUpdatePrices() ? "Доступно только в Premium" : "Обновить цены")">
                                <i class="bi bi-arrow-clockwise me-1 @(isUpdatingPrices ? "spin-icon" : "")"></i>Обновить цены
                            </button>
                            <button class="btn btn-sm btn-success shadow-sm fw-bold" @onclick="OpenAddItemModal" title="Добавить новый предмет">
                                <i class="bi bi-plus-circle me-1"></i>Добавить актив
                            </button>
                        </div>
                    </div>

                    <div class="p-3 bg-white border-bottom d-flex gap-2 align-items-center flex-wrap">
                        <div class="input-group input-group-sm w-auto">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control border-start-0" placeholder="Поиск..." @bind="tableFilterName" @bind:event="oninput" style="width: 120px;" />
                        </div>

                        <div class="custom-dropdown-container">
                            <button class="btn btn-sm btn-white border dropdown-toggle" @onclick="() => ToggleDropdown(ref isTableTypeOpen)" @onclick:stopPropagation>
                                @(tableFilterType.HasValue? tableFilterType.Value.ToString() : "Все типы")
                            </button>
                            <div class="custom-dropdown-menu @(isTableTypeOpen ? "show" : "")">
                                <div class="dropdown-item-custom" @onclick="() => SetTableType(null)">Все типы</div>
                                @foreach (var t in Enum.GetValues(typeof(ItemType)))
                                {
                                    <div class="dropdown-item-custom" @onclick="() => SetTableType((ItemType)t)">@t</div>
                                }
                            </div>
                        </div>

                        <div class="custom-dropdown-container">
                            <button class="btn btn-sm btn-white border dropdown-toggle" @onclick="() => ToggleDropdown(ref isTableRarityOpen)" @onclick:stopPropagation>
                                @(tableFilterRarity?.ToString() ?? "Редкость")
                            </button>
                            <div class="custom-dropdown-menu @(isTableRarityOpen ? "show" : "")">
                                <div class="dropdown-item-custom" @onclick="() => SetTableRarity(null)">Все</div>
                                @foreach (var r in Enum.GetValues(typeof(ItemRarity)).Cast<ItemRarity>())
                                {
                                    <div class="dropdown-item-custom" @onclick="() => SetTableRarity(r)">
                                        <span class="rarity-dot @GetRarityBgClass(r)"></span> @r
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="custom-dropdown-container">
                            <button class="btn btn-sm btn-white border dropdown-toggle" @onclick="() => ToggleDropdown(ref isTableCollectionOpen)" @onclick:stopPropagation>
                                Коллекция
                            </button>
                            <div class="custom-dropdown-menu @(isTableCollectionOpen ? "show" : "")" style="min-width: 200px;">
                                <div class="dropdown-item-custom" @onclick="() => SetTableCollection(0)">Все коллекции</div>
                                @foreach (var c in collections)
                                {
                                    <div class="dropdown-item-custom" @onclick="() => SetTableCollection(c.Id)">
                                        @if (!string.IsNullOrEmpty(c.ImageUrl))
                                        {
                                            <img src="@c.ImageUrl" class="col-thumb" referrerpolicy="no-referrer" />
                                        }
                                        <span class="text-truncate">@c.Name</span>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="ms-auto text-muted small fw-bold">
                            Найдено: @FilteredInventory.Count()
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table inventory-table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">Фото</th>
                                    <th>Предмет</th>
                                    <th class="text-center sortable-header" @onclick='() => Sort("Quantity")' style="cursor:pointer">Кол-во @SortIcon("Quantity")</th>
                                    <th class="text-end sortable-header" @onclick='() => Sort("AvgBuy")' style="cursor:pointer">Ср. Закуп @SortIcon("AvgBuy")</th>
                                    <th class="text-end sortable-header" @onclick='() => Sort("Value")' style="cursor:pointer">Стоимость @SortIcon("Value")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var group in FilteredInventory)
                                {
                                    var itemBase = group.Key;
                                    var totalQty = group.Sum(x => x.Quantity);
                                    var totalInvested = group.Sum(x => x.PurchasePrice * x.Quantity);
                                    var avgBuy = totalQty > 0 ? totalInvested / totalQty : 0;

                                    // ИСПРАВЛЕНО: Теперь учитываем количество для каждого элемента
                                    var totalGroupValue = group.Sum(x => CalculateItemTotalValue(x));

                                    var isExpanded = expandedGroups.Contains(itemBase.Id);
                                    var rarityClass = $"row-{itemBase.Rarity.ToString().ToLower()}";

                                    // Расчет процента и цвета
                                    var diff = totalGroupValue - totalInvested;
                                    var percent = totalInvested > 0 ? (diff / totalInvested) * 100 : 0;
                                    var colorClass = diff >= 0 ? "text-success" : "text-danger";
                                    var percentSign = diff >= 0 ? "+" : "";

                                    <tr class="inventory-row @rarityClass row-rarity-border" @onclick="() => ToggleGroup(itemBase.Id)" style="cursor: pointer;">
                                        <td class="text-center">
                                            @if (!string.IsNullOrEmpty(itemBase.ImageUrl))
                                            {
                                                <img src="@itemBase.ImageUrl" class="item-thumb-lg" referrerpolicy="no-referrer" />
                                            }
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <div class="d-flex align-items-center gap-1">
                                                    @if (itemBase.IsStatTrack)
                                                    {
                                                        <span class="badge bg-warning text-dark py-0 px-1" style="font-size:0.6em">ST</span>
                                                    }
                                                    @if (itemBase.IsPattern)
                                                    {
                                                        <img src="icons/pattern-icon.png" style="width: 14px; height: 14px; object-fit: contain;" title="Pattern" />
                                                    }
                                                    <span class="fw-bold text-dark">@itemBase.Name</span>
                                                </div>
                                                <div class="small @GetDisplayColorClass(itemBase)">@itemBase.SkinName</div>
                                            </div>
                                        </td>
                                        <td class="text-center"><span class="badge bg-light text-dark border">x @totalQty</span></td>
                                        <td class="text-end text-muted">@avgBuy.ToString("N2")</td>
                                        <td class="text-end">
                                            <div class="fw-bold text-dark">@totalGroupValue.ToString("N2") <span class="text-gold small">G</span></div>
                                            @if (totalInvested > 0)
                                            {
                                                <div class="small @colorClass fw-bold">@percentSign@percent.ToString("N1")%</div>
                                            }
                                        </td>
                                    </tr>

                                    @if (isExpanded)
                                    {
                                        <tr class="expanded-details">
                                            <td colspan="5" class="p-3">
                                                <div class="bg-white rounded-3 shadow-sm border p-3">
                                                    <h6 class="small text-uppercase text-muted fw-bold mb-3 border-bottom pb-2">История покупок</h6>
                                                    <table class="table table-sm table-borderless mb-0 align-middle">
                                                        <thead class="text-muted small">
                                                            <tr>
                                                                <th>Дата / Модификации</th>
                                                                <th>Кол-во</th>
                                                                <th>Цена закупки</th>
                                                                <th class="text-end">Действия</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var purchase in group.OrderByDescending(x => x.PurchaseDate))
                                                            {
                                                                var craftVal = CalculateCraftAddedValue(purchase);
                                                                var hasAttachments = purchase.Attachments != null && purchase.Attachments.Any();
                                                                <tr>
                                                                    <td class="py-2">
                                                                        <div class="small text-dark fw-bold">@purchase.PurchaseDate.ToShortDateString()</div>
                                                                        @if (purchase.ItemBase.Type == ItemType.Guns && purchase.Quantity == 1)
                                                                        {
                                                                            <div class="mini-stickers-row mt-1">
                                                                                @for (int i = 1; i <= 4; i++)
                                                                                {
                                                                                    var sticker = purchase.Attachments?.FirstOrDefault(a => a.SlotPosition == i);
                                                                                    if (sticker?.Sticker != null)
                                                                                    {
                                                                                        <img src="@sticker.Sticker.ImageUrl" class="mini-sticker" title="@sticker.Sticker.SkinName" referrerpolicy="no-referrer" />
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        <div class="mini-empty"></div>
                                                                                    }
                                                                                }
                                                                                @{
                                                                                    var charm = purchase.Attachments?.FirstOrDefault(a => a.SlotPosition == 5);
                                                                                }
                                                                                @if (charm?.Sticker != null)
                                                                                {
                                                                                    <div class="vr mx-1"></div>
                                                                                    <img src="@charm.Sticker.ImageUrl" class="mini-sticker" style="border-color:gold;" referrerpolicy="no-referrer" />
                                                                                }
                                                                            </div>
                                                                        }
                                                                    </td>
                                                                    <td style="width: 100px;">
                                                                        <input type="number" class="form-control form-control-sm text-center fw-bold" value="@purchase.Quantity"
                                                                               @onchange="@(e => UpdatePurchaseQty(purchase, e.Value))" disabled="@hasAttachments" />
                                                                    </td>
                                                                    <td style="width: 140px;">
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" class="form-control fw-bold" value="@purchase.PurchasePrice" step="0.01" @onchange="@(e => UpdatePurchasePrice(purchase, e.Value))" />
                                                                            <span class="input-group-text bg-light text-gold fw-bold">G</span>
                                                                        </div>
                                                                    </td>
                                                                    <td class="text-end">
                                                                        @if (purchase.ItemBase.Type == ItemType.Guns)
                                                                        {
                                                                            <button class="btn btn-sm btn-outline-warning py-1 px-2 me-1 @(CanCustomize() ? "" : "locked-feature")" disabled="@(purchase.Quantity > 1)"
                                                                                    @onclick="() => OpenCustomization(purchase)" @onclick:stopPropagation="true" title="@(CanCustomize() ? "Крафт" : "Требуется Lite/Premium")">
                                                                                @if (!CanCustomize())
                                                                                {
                                                                                    <i class="bi bi-lock-fill"></i>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <span>🎨</span>
                                                                                }
                                                                            </button>
                                                                        }
                                                                        <button class="btn btn-sm btn-outline-danger py-1 px-2" @onclick="() => Delete(purchase.Id)" @onclick:stopPropagation="true" title="Удалить">
                                                                            <i class="bi bi-trash"></i>
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@if (isAddingItem && currentPortfolioId > 0)
{
    <div class="modal-overlay" @onclick="CloseAddItemModal">
        <div class="craft-modal animate__animated animate__zoomIn" @onclick:stopPropagation="true" style="width: 600px;">
            <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold text-dark"><i class="bi bi-plus-circle me-2 text-success"></i>Добавить новый актив</h5>
                <button type="button" class="btn-close" @onclick="CloseAddItemModal"></button>
            </div>

            <div class="p-4 bg-white" style="max-height: 70vh; overflow-y: auto;">
                <EditForm Model="@newItem" OnValidSubmit="HandleBuyModal">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <label class="small fw-bold text-muted mb-2 text-uppercase">Поиск предмета</label>
                        <div class="input-group mb-3 shadow-sm">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control border-start-0" placeholder="Название (напр. AKR...)" @bind="searchName" @bind:event="oninput" @onkeyup="FilterItems" />
                        </div>

                        <div class="d-flex gap-2 mb-3">
                            <div class="custom-dropdown-container w-50">
                                <div class="custom-select-trigger" @onclick="() => ToggleDropdown(ref isTypeFilterOpen)" @onclick:stopPropagation>
                                    <span>@(string.IsNullOrEmpty(selectedTypeString) ? "Все типы" : selectedTypeString)</span>
                                    <i class="bi bi-chevron-down small text-muted"></i>
                                </div>
                                <div class="custom-dropdown-menu @(isTypeFilterOpen ? "show" : "")">
                                    <div class="dropdown-item-custom" @onclick='() => SelectTypeFilter("")'>Все типы</div>
                                    @foreach (var t in Enum.GetValues(typeof(ItemType)))
                                    {
                                        <div class="dropdown-item-custom" @onclick="() => SelectTypeFilter(t.ToString())">@t</div>
                                    }
                                </div>
                            </div>
                            <div class="custom-dropdown-container w-50">
                                <div class="custom-select-trigger" @onclick="() => ToggleDropdown(ref isRarityFilterOpen)" @onclick:stopPropagation>
                                    @if (string.IsNullOrEmpty(selectedRarity))
                                    {
                                        <span>Редкость</span>
                                    }
                                    else
                                    {
                                        <span class="fw-bold @GetRarityClass(Enum.Parse<ItemRarity>(selectedRarity))">@selectedRarity</span>
                                    }
                                    <i class="bi bi-chevron-down small text-muted"></i>
                                </div>
                                <div class="custom-dropdown-menu @(isRarityFilterOpen ? "show" : "")">
                                    <div class="dropdown-item-custom" @onclick='() => SelectRarityFilter("")'>Любая</div>
                                    @foreach (var r in Enum.GetValues(typeof(ItemRarity)).Cast<ItemRarity>())
                                    {
                                        <div class="dropdown-item-custom" @onclick="() => SelectRarityFilter(r.ToString())">
                                            <span class="rarity-dot @GetRarityBgClass(r)"></span> @r
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="mb-3 custom-dropdown-container">
                            <div class="custom-select-trigger" @onclick="() => ToggleDropdown(ref isAddCollectionOpen)" @onclick:stopPropagation>
                                @if (selectedCollectionId == 0)
                                {
                                    <span>Любая коллекция</span>
                                }
                                else
                                {
                                    var c = collections.FirstOrDefault(x => x.Id == selectedCollectionId);
                                    <div class="d-flex align-items-center gap-2">
                                        @if (!string.IsNullOrEmpty(c?.ImageUrl))
                                        {
                                            <img src="@c.ImageUrl" class="col-thumb" referrerpolicy="no-referrer" />
                                        }
                                        <span class="fw-bold text-truncate">@c?.Name</span>
                                    </div>
                                }
                                <i class="bi bi-chevron-down small text-muted"></i>
                            </div>
                            <div class="custom-dropdown-menu @(isAddCollectionOpen ? "show" : "")">
                                <div class="dropdown-item-custom" @onclick="() => SelectAddCollection(0)">Любая коллекция</div>
                                @foreach (var c in collections)
                                {
                                    <div class="dropdown-item-custom" @onclick="() => SelectAddCollection(c.Id)">
                                        @if (!string.IsNullOrEmpty(c.ImageUrl))
                                        {
                                            <img src="@c.ImageUrl" class="col-thumb" referrerpolicy="no-referrer" />
                                        }
                                        <span>@c.Name</span>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-3">
                            <div class="filter-btn @(isStatTrackFilter ? "active-st" : "")" @onclick="ToggleST">
                                <i class="bi @(isStatTrackFilter ? "bi-check-circle-fill" : "bi-circle")"></i> StatTrack™
                            </div>
                            <div class="filter-btn @(isPatternFilter ? "active-pat" : "")" @onclick="TogglePT">
                                <i class="bi @(isPatternFilter ? "bi-check-circle-fill" : "bi-circle")"></i> Pattern
                            </div>
                        </div>
                    </div>

                    <hr class="text-muted opacity-25 my-3" />

                    <div class="mb-3 custom-dropdown-container">
                        <label class="small fw-bold text-muted mb-2 text-uppercase">Выбранный предмет</label>
                        <div class="custom-select-trigger p-2" style="min-height: 54px;" @onclick="() => ToggleDropdown(ref isItemDropdownOpen)" @onclick:stopPropagation>
                            @if (selectedItemPreview != null)
                            {
                                <div class="d-flex align-items-center gap-3">
                                    <img src="@selectedItemPreview.ImageUrl" class="item-thumb-lg" referrerpolicy="no-referrer" />
                                    <div class="lh-sm">
                                        <div class="d-flex align-items-center gap-1">
                                            @if (selectedItemPreview.IsStatTrack)
                                            {
                                                <span class="badge bg-warning text-dark py-0 px-1" style="font-size:0.6em">ST</span>
                                            }
                                            @if (selectedItemPreview.IsPattern)
                                            {
                                                <img src="icons/pattern-icon.png" style="width: 14px; height: 14px; object-fit: contain;" title="Pattern" />
                                            }
                                            <span class="fw-bold text-dark">@selectedItemPreview.Name</span>
                                        </div>
                                        <div class="small @GetDisplayColorClass(selectedItemPreview)">@selectedItemPreview.SkinName</div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <span class="text-muted fst-italic ms-2">-- Выберите скин --</span>
                            }
                            <i class="bi bi-chevron-down small text-muted me-2"></i>
                        </div>

                        <div class="custom-dropdown-menu @(isItemDropdownOpen ? "show" : "")">
                            @foreach (var item in filteredItems.Take(50))
                            {
                                <div class="dropdown-item-custom border-bottom" @onclick="() => SelectItem(item)">
                                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                                    {
                                        <img src="@item.ImageUrl" class="rounded" style="width:36px;height:36px;object-fit:contain;" referrerpolicy="no-referrer" />
                                    }
                                    <div>
                                        <div class="d-flex align-items-center gap-1">
                                            @if (item.IsStatTrack)
                                            {
                                                <span class="badge bg-warning text-dark py-0 px-1" style="font-size:0.5em">ST</span>
                                            }
                                            @if (item.IsPattern)
                                            {
                                                <img src="icons/pattern-icon.png" style="width: 12px; height: 12px; object-fit: contain;" title="Pattern" />
                                            }
                                            <span class="fw-bold text-dark">@item.Name</span>
                                        </div>
                                        <div class="small @GetDisplayColorClass(item)">@item.SkinName</div>
                                    </div>
                                </div>
                            }
                            @if (!filteredItems.Any())
                            {
                                <div class="p-3 text-center text-muted small">Ничего не найдено</div>
                            }
                        </div>
                    </div>

                    <div class="bg-light p-3 rounded-4 mb-3 border">
                        <div class="btn-group w-100 mb-3 bg-white shadow-sm rounded-2 p-1">
                            <input type="radio" class="btn-check" name="priceMode2" id="modeUnit2" checked="@(isUnitPriceMode)" @onchange="@(() => SetPriceMode(true))">
                            <label class="btn btn-sm fw-bold @(isUnitPriceMode ? "btn-primary" : "btn-light text-muted")" for="modeUnit2">За 1 шт.</label>

                            <input type="radio" class="btn-check" name="priceMode2" id="modeTotal2" checked="@(!isUnitPriceMode)" @onchange="@(() => SetPriceMode(false))">
                            <label class="btn btn-sm fw-bold @(!isUnitPriceMode ? "btn-primary" : "btn-light text-muted")" for="modeTotal2">Общая сумма</label>
                        </div>

                        <div class="row g-2">
                            <div class="col-4">
                                <label class="small fw-bold text-muted">Кол-во</label>
                                <InputNumber @bind-Value="inputQuantity" class="form-control fw-bold text-center" @bind-Value:after="RecalculatePrice" min="1" />
                            </div>
                            <div class="col-8">
                                @if (isUnitPriceMode)
                                {
                                    <label class="small fw-bold text-muted">Цена за шт (G)</label>
                                    <div class="input-group">
                                        <InputNumber @bind-Value="inputPricePerUnit" class="form-control fw-bold" step="0.01" @bind-Value:after="RecalculatePrice" />
                                        <span class="input-group-text bg-white text-gold fw-bold">G</span>
                                    </div>
                                    <div class="text-end mt-1 text-muted small">
                                        Итого: <strong class="text-dark">@((inputQuantity * inputPricePerUnit).ToString("N2")) G</strong>
                                    </div>
                                }
                                else
                                {
                                    <label class="small fw-bold text-muted">Всего потрачено (G)</label>
                                    <div class="input-group">
                                        <InputNumber @bind-Value="inputTotalSpent" class="form-control fw-bold" step="0.01" @bind-Value:after="RecalculatePrice" />
                                        <span class="input-group-text bg-white text-gold fw-bold">G</span>
                                    </div>
                                    <div class="text-end mt-1 text-muted small">
                                        ~ <strong class="text-dark">@((inputQuantity > 0 ? inputTotalSpent / inputQuantity : 0).ToString("N2")) G</strong> / шт.
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success flex-grow-1 py-2 rounded-3 fw-bold shadow-sm" disabled="@(newItem.ItemBaseId == 0)">
                            <i class="bi bi-check-lg me-2"></i>Добавить в портфель
                        </button>
                        <button type="button" class="btn btn-light py-2 px-4 rounded-3 fw-bold" @onclick="CloseAddItemModal">
                            <i class="bi bi-x me-2"></i>Отмена
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@if (isCustomizing && currentCustomizingItem != null)
{
    <div class="modal-overlay" @onclick="CloseCustomization">
        <div class="craft-modal animate__animated animate__zoomIn" @onclick:stopPropagation="true">
            <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold text-dark"><i class="bi bi-palette-fill text-primary me-2"></i>Кастомизация</h5>
                <button type="button" class="btn-close" @onclick="CloseCustomization"></button>
            </div>

            <div class="gun-preview-container">
                <div class="position-absolute top-0 end-0 m-3 d-flex gap-2">
                    @if (currentCustomizingItem.ItemBase.IsStatTrack)
                    {
                        <span class="badge bg-warning text-dark shadow-sm">StatTrack</span>
                    }
                    @if (currentCustomizingItem.ItemBase.IsPattern)
                    {
                        <img src="icons/pattern-icon.png" style="width: 20px; height: 20px; object-fit: contain;" title="Pattern" class="shadow-sm" />
                    }
                </div>
                @if (!string.IsNullOrEmpty(currentCustomizingItem.ItemBase?.ImageUrl))
                {
                    <img src="@currentCustomizingItem.ItemBase.ImageUrl" style="max-width: 80%; max-height: 180px; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3));" referrerpolicy="no-referrer" />
                }
                <div class="mt-3 bg-white px-3 py-1 rounded-pill shadow-sm border fw-bold text-dark">
                    @currentCustomizingItem.ItemBase?.Name | <span class="@GetDisplayColorClass(currentCustomizingItem.ItemBase)">@currentCustomizingItem.ItemBase?.SkinName</span>
                </div>
            </div>

            <div class="d-flex justify-content-center bg-white p-3 border-bottom gap-3">
                @for (int i = 1; i <= 4; i++)
                {
                    var idx = i;
                    var att = currentAttachments.FirstOrDefault(x => x.SlotPosition == idx);
                    <div class="craft-slot @(activeSlot == idx ? "active" : "")" @onclick="() => SelectSlot(idx)">
                        @if (att?.Sticker != null)
                        {
                            <img src="@att.Sticker.ImageUrl" referrerpolicy="no-referrer" style="width: 90%; height: 90%; object-fit: contain;" />
                            <div class="remove-attachment" @onclick="() => RemoveAttachment(idx)" @onclick:stopPropagation="true">×</div>
                        }
                        else
                        {
                            <i class="bi bi-sticky text-muted opacity-25 fs-4"></i>
                        }
                    </div>
                }
                <div class="vr mx-2 opacity-25"></div>
                @{
                    var cSlot = 5; var ch = currentAttachments.FirstOrDefault(x => x.SlotPosition == cSlot);
                }
                <div class="craft-slot @(activeSlot == cSlot ? "active" : "")" @onclick="() => SelectSlot(cSlot)" style="border-color: @(ch != null ? "gold" : "")">
                    @if (ch?.Sticker != null)
                    {
                        <img src="@ch.Sticker.ImageUrl" referrerpolicy="no-referrer" style="width: 90%; height: 90%; object-fit: contain;" />
                        <button class="charm-action-btn btn-delete" @onclick="DeleteCharm" @onclick:stopPropagation="true" title="Удалить"><i class="bi bi-trash"></i></button>
                        <button class="charm-action-btn btn-detach" @onclick="DetachCharm" @onclick:stopPropagation="true" title="Снять в инвентарь"><i class="bi bi-arrow-down"></i></button>
                    }
                    else
                    {
                        <i class="bi bi-gem text-warning opacity-50 fs-4"></i>
                    }
                </div>
            </div>

            <div class="d-flex flex-column flex-grow-1 bg-white">
                @if (activeSlot != -1)
                {
                    <div class="p-3 border-bottom bg-light">
                        <input type="text" class="form-control" placeholder="Поиск наклейки..." @bind="attachmentSearch" @bind:event="oninput" />
                    </div>
                    <div class="list-group list-group-flush overflow-auto flex-grow-1" style="max-height: 250px;">
                        @foreach (var item in GetAvailableAttachments())
                        {
                            <button class="list-group-item list-group-item-action d-flex align-items-center gap-3 p-2" @onclick="() => ApplyAttachment(item)">
                                <img src="@item.ImageUrl" style="width:40px;height:40px;object-fit:contain;" referrerpolicy="no-referrer" />
                                <div>
                                    <div class="fw-bold @GetRarityClass(item.Rarity)">@item.SkinName</div>
                                    <div class="small text-muted">@item.Name</div>
                                </div>
                                <div class="ms-auto fw-bold text-dark">@item.CurrentMarketPrice.ToString("N2") G</div>
                            </button>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center p-5 text-muted opacity-50">Выберите слот для добавления</div>
                }
            </div>

            <div class="p-3 bg-light border-top d-flex justify-content-between align-items-center">
                <div class="text-dark small">Стоимость крафта: <span class="fw-bold text-success">+@CalculateCurrentCraftValue().ToString("N2") <span class="text-gold">G</span></span></div>
                <button class="btn btn-primary fw-bold px-4" @onclick="SaveCustomization">Сохранить</button>
            </div>
        </div>
    </div>
}

@code {
    // ... (Variables logic remains same as provided previously, adding Total Calc helpers)
    private List<ItemBase> allItems = new();
    private List<ItemBase> filteredItems = new();
    private List<GameCollection> collections = new();
    private List<InventoryItem> inventory = new();
    private List<PortfolioAccount> availablePortfolios = new();
    private SubscriptionType userSubscription = SubscriptionType.None;

    // UI States
    private string sortColumn = "Rarity";
    private bool sortAscending = false;
    private bool isCreatingPortfolio = false;
    private bool isCustomizing = false;
    private bool isUpdatingPrices = false;
    private bool isLoading = true;
    private bool isAddingItem = false;
    // Dropdown States
    private bool isRarityFilterOpen = false;
    private bool isItemDropdownOpen = false;
    private bool isTableRarityOpen = false;
    private bool isTableCollectionOpen = false;
    private bool isAddCollectionOpen = false;
    private bool isPortfolioDropdownOpen = false;
    private bool isTypeFilterOpen = false;
    private bool isTableTypeOpen = false;

    // Filters & Inputs
    private string newPortfolioName = "";
    private string newPortfolioDesc = "";
    private int currentPortfolioId = 0;
    // Add Item Inputs
    private InventoryItem newItem = new() { Quantity = 1 };
    private string searchName = "";
    private string selectedTypeString = "";
    private string selectedKindString = "";
    private string selectedRarity = "";
    private bool isStatTrackFilter = false;
    private bool isPatternFilter = false;
    private ItemBase? selectedItemPreview;
    private bool isUnitPriceMode = true;
    private decimal inputPricePerUnit;
    private int inputQuantity = 1;
    private decimal inputTotalSpent;
    private int selectedCollectionId = 0;
    // Table Filters
    private string tableFilterName = "";
    private int? tableFilterQtyMin;
    private int? tableFilterQtyMax;
    private decimal? tableFilterPriceMin;
    private decimal? tableFilterPriceMax;
    private ItemType? tableFilterType = null;
    private ItemRarity? tableFilterRarity = null;
    private int tableFilterCollection = 0;
    private bool tableFilterST = false;
    private bool tableFilterPT = false;
    private HashSet<int> expandedGroups = new();
    // Customization
    private InventoryItem? currentCustomizingItem;
    private List<AppliedAttachment> currentAttachments = new();
    private int activeSlot = -1;
    private string attachmentSearch = "";

    private IEnumerable<IGrouping<ItemBase, InventoryItem>> FilteredInventory
    {
        get
        {
            var query = inventory.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(tableFilterName)) query = query.Where(i => (i.ItemBase.Name + i.ItemBase.SkinName).Contains(tableFilterName, StringComparison.OrdinalIgnoreCase));
            if (tableFilterQtyMin.HasValue) query = query.Where(i => i.Quantity >= tableFilterQtyMin.Value);
            if (tableFilterQtyMax.HasValue) query = query.Where(i => i.Quantity <= tableFilterQtyMax.Value);
            if (tableFilterPriceMin.HasValue) query = query.Where(i => i.PurchasePrice >= tableFilterPriceMin.Value);
            if (tableFilterPriceMax.HasValue) query = query.Where(i => i.PurchasePrice <= tableFilterPriceMax.Value);
            if (tableFilterType.HasValue) query = query.Where(i => i.ItemBase.Type == tableFilterType.Value);
            if (tableFilterRarity.HasValue) query = query.Where(i => i.ItemBase.Rarity == tableFilterRarity.Value);
            if (tableFilterCollection > 0) query = query.Where(i => i.ItemBase.CollectionId == tableFilterCollection);
            if (tableFilterST) query = query.Where(i => i.ItemBase.IsStatTrack);
            if (tableFilterPT) query = query.Where(i => i.ItemBase.IsPattern);

            var grouped = query.Where(i => i.ItemBase != null).GroupBy(i => i.ItemBase!);

            switch (sortColumn)
            {
                case "Name": return sortAscending ? grouped.OrderBy(g => g.Key.Name) : grouped.OrderByDescending(g => g.Key.Name);
                case "Quantity": return sortAscending ? grouped.OrderBy(g => g.Sum(x => x.Quantity)) : grouped.OrderByDescending(g => g.Sum(x => x.Quantity));
                case "AvgBuy": return sortAscending ? grouped.OrderBy(g => g.Sum(x => x.PurchasePrice * x.Quantity) / (g.Sum(x => x.Quantity) == 0 ? 1 : g.Sum(x => x.Quantity))) : grouped.OrderByDescending(g => g.Sum(x => x.PurchasePrice * x.Quantity) / (g.Sum(x => x.Quantity) == 0 ? 1 : g.Sum(x => x.Quantity)));
                case "TotalCost": return sortAscending ? grouped.OrderBy(g => g.Sum(x => x.PurchasePrice * x.Quantity)) : grouped.OrderByDescending(g => g.Sum(x => x.PurchasePrice * x.Quantity));
                case "Value": return sortAscending ? grouped.OrderBy(g => g.Sum(x => CalculateItemTotalValue(x))) : grouped.OrderByDescending(g => g.Sum(x => CalculateItemTotalValue(x)));
                case "Rarity": return sortAscending ? grouped.OrderBy(g => g.Key.Rarity).ThenBy(g => g.Key.Name) : grouped.OrderByDescending(g => g.Key.Rarity).ThenBy(g => g.Key.Name);
                default: return grouped;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            await LoadUserSubscription();
            allItems = await ItemService.GetAllItemsAsync();
            collections = await ItemService.GetCollectionsAsync();
            await LoadPortfolios();
            FilterItems();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadUserSubscription()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        if (user != null) { userSubscription = user.SubType; }
    }

    // === Helpers for Totals ===
    private decimal GetTotalPortfolioValue()
    {
        return inventory.Sum(x => CalculateItemTotalValue(x));
    }

    private decimal GetTotalInvested()
    {
        return inventory.Sum(x => x.PurchasePrice * x.Quantity);
    }

    // === FIXED CALCULATION LOGIC ===
    private decimal CalculateItemTotalValue(InventoryItem item)
    {
        // Цена предмета * Количество + Стоимость наклеек
        // Наклейки считаются один раз, так как они привязаны к конкретному InventoryItem (ID)
        // Если InventoryItem имеет Quantity > 1, то обычно это предметы без наклеек (кейсы).
        // Если это скины, то они обычно добавляются по 1 шт.
        // Но на всякий случай логика: (Цена * Кол-во) + Крафт

        var baseVal = (item.ItemBase?.CurrentMarketPrice ?? 0) * item.Quantity;
        var craftVal = CalculateCraftAddedValue(item);
        return baseVal + craftVal;
    }

    private decimal CalculateCraftAddedValue(InventoryItem item)
    {
        if (item.Attachments == null) return 0;
        decimal added = 0;
        foreach (var att in item.Attachments)
        {
            if (att.Sticker == null) continue;
            decimal p = att.Sticker.CurrentMarketPrice;
            if (att.SlotPosition == 5) added += p; // Брелок 100%
            else
            {
                decimal pct = p < 100 ? 0.2m : (p < 1000 ? 0.1m : 0.05m); // % от наклейки
                added += p * pct;
            }
        }
        return added;
    }

    // ... (Rest of CRUD methods: StartCreatePortfolio, SaveNewPortfolio, HandleBuy, etc. - UNCHANGED)
    private int GetMaxPortfolios() => userSubscription switch { SubscriptionType.Premium => 10, SubscriptionType.Lite => 3, _ => 1 };
    private int GetMaxItemsLimit() => userSubscription switch { SubscriptionType.Premium => 1000, SubscriptionType.Lite => 100, _ => 25 };
    private bool CanCustomize() => userSubscription != SubscriptionType.None;
    private bool CanUpdatePrices() => userSubscription == SubscriptionType.Premium;

    private async Task StartCreatePortfolio()
    {
        if (availablePortfolios.Count >= GetMaxPortfolios())
        {
            ToastService.ShowToast($"Лимит портфелей достигнут ({GetMaxPortfolios()}). Обновите подписку!", ToastLevel.Warning);
            return;
        }
        isCreatingPortfolio = true;
    }

    private async Task SaveNewPortfolio()
    {
        if (!string.IsNullOrWhiteSpace(newPortfolioName))
        {
            await PortfolioService.CreateAccountAsync(newPortfolioName, newPortfolioDesc);
            newPortfolioName = ""; newPortfolioDesc = "";
            isCreatingPortfolio = false;
            await LoadPortfolios();
            ToastService.ShowToast("Портфель создан!", ToastLevel.Success);
        }
    }

    private void OpenAddItemModal()
    {
        isAddingItem = true;
        newItem = new InventoryItem { Quantity = 1 };
        selectedItemPreview = null;
        inputPricePerUnit = 0;
        inputTotalSpent = 0;
        inputQuantity = 1;
        isUnitPriceMode = true;
    }

    private void CloseAddItemModal()
    {
        isAddingItem = false;
        newItem = new InventoryItem { Quantity = 1 };
        selectedItemPreview = null;
    }

    private async Task HandleBuyModal()
    {
        await HandleBuy();
        CloseAddItemModal();
    }

    private async Task HandleBuy()
    {
        if (newItem.ItemBaseId == 0 || currentPortfolioId == 0) return;
        if (inventory.Count >= GetMaxItemsLimit())
        {
            ToastService.ShowToast($"Лимит предметов достигнут ({GetMaxItemsLimit()}). Обновите подписку!", ToastLevel.Warning);
            return;
        }

        newItem.PortfolioAccountId = currentPortfolioId;
        newItem.PurchaseDate = DateTime.Now;
        newItem.Quantity = inputQuantity;
        newItem.PurchasePrice = inputPricePerUnit;
        await PortfolioService.AddPurchaseAsync(newItem);

        newItem = new InventoryItem { Quantity = 1, ItemBaseId = 0 };
        selectedItemPreview = null;
        inputPricePerUnit = 0; inputTotalSpent = 0; inputQuantity = 1;
        await LoadInventory();
        ToastService.ShowToast("Предмет добавлен!", ToastLevel.Success);
    }

    private void OpenCustomization(InventoryItem item)
    {
        if (!CanCustomize())
        {
            ToastService.ShowToast("Кастомизация доступна в Lite и Premium подписке!", ToastLevel.Warning);
            return;
        }
        currentCustomizingItem = item;
        currentAttachments = item.Attachments.Select(a => new AppliedAttachment { Id = a.Id, InventoryItemId = item.Id, StickerId = a.StickerId, Sticker = a.Sticker, SlotPosition = a.SlotPosition }).ToList();
        activeSlot = -1; attachmentSearch = "";
        isCustomizing = true;
    }

    private async Task UpdateAllPortfolioPrices()
    {
        if (!CanUpdatePrices())
        {
            ToastService.ShowToast("Обновление цен доступно только в Premium!", ToastLevel.Warning);
            return;
        }

        isUpdatingPrices = true;
        StateHasChanged();
        await ParserService.UpdatePortfolioPricesAsync();
        await LoadInventory();
        isUpdatingPrices = false;
        GlobalNotifier.NotifyUser(currentPortfolioId.ToString(), "Цены успешно обновлены!", ToastLevel.Success);
        ToastService.ShowToast("Цены обновлены!", ToastLevel.Success);
    }

    // UI Helpers
    private void CloseAllDropdowns()
    {
        isRarityFilterOpen = false; isItemDropdownOpen = false; isTableRarityOpen = false;
        isTableCollectionOpen = false; isAddCollectionOpen = false; isPortfolioDropdownOpen = false;
        isTypeFilterOpen = false; isTableTypeOpen = false;
    }

    private void ToggleDropdown(ref bool flag) { var state = !flag; CloseAllDropdowns(); flag = state; }
    private void ToggleST() { isStatTrackFilter = !isStatTrackFilter; FilterItems(); }
    private void TogglePT() { isPatternFilter = !isPatternFilter; FilterItems(); }

    private async Task LoadPortfolios() { availablePortfolios = await PortfolioService.GetMyAccountsAsync(); if (availablePortfolios.Any()) { currentPortfolioId = availablePortfolios.First().Id; await LoadInventory(); } StateHasChanged(); }
    private async Task LoadInventory() { inventory = await PortfolioService.GetMyInventoryAsync(currentPortfolioId); StateHasChanged(); }
    private async Task SelectPortfolio(int id) { currentPortfolioId = id; await LoadInventory(); }
    private async Task OnPortfolioChanged() => await LoadInventory();
    private string GetPortfolioName(int id) => availablePortfolios.FirstOrDefault(p => p.Id == id)?.Name ?? "Выбрать";
    private void Sort(string column) { if (sortColumn == column) sortAscending = !sortAscending; else { sortColumn = column; sortAscending = true; } }
    private string SortIcon(string column) { if (sortColumn != column) return "↕"; return sortAscending ? "▲" : "▼"; }

    private void SetTableRarity(ItemRarity? r) { tableFilterRarity = r; isTableRarityOpen = false; }
    private void SetTableCollection(int id) { tableFilterCollection = id; isTableCollectionOpen = false; }
    private void SetTableType(ItemType? t) { tableFilterType = t; isTableTypeOpen = false; }

    private void SetPriceMode(bool isUnit) { isUnitPriceMode = isUnit; RecalculatePrice(); }
    private void RecalculatePrice() { if (inputQuantity <= 0) inputQuantity = 1; if (isUnitPriceMode) inputTotalSpent = inputPricePerUnit * inputQuantity; else inputPricePerUnit = inputQuantity > 0 ? inputTotalSpent / inputQuantity : 0; }

    private void SelectItem(ItemBase item) { newItem.ItemBaseId = item.Id; selectedItemPreview = item; inputPricePerUnit = Math.Round(item.CurrentMarketPrice, 2); inputQuantity = 1; isUnitPriceMode = true; RecalculatePrice(); isItemDropdownOpen = false; }

    private void SelectTypeFilter(string typeStr) { selectedTypeString = typeStr; isTypeFilterOpen = false; OnTypeChanged(); }

    private void ToggleGroup(int id) { if (expandedGroups.Contains(id)) expandedGroups.Remove(id); else expandedGroups.Add(id); }
    private async Task UpdatePurchaseQty(InventoryItem item, object? value) { if (int.TryParse(value?.ToString(), out int qty) && qty > 0) { item.Quantity = qty; await PortfolioService.UpdatePurchaseAsync(item); await LoadInventory(); } }
    private async Task UpdatePurchasePrice(InventoryItem item, object? value) { if (decimal.TryParse(value?.ToString(), out decimal price) && price >= 0) { item.PurchasePrice = price; await PortfolioService.UpdatePurchaseAsync(item); await LoadInventory(); } }
    private async Task Delete(int id) { await PortfolioService.DeleteItemAsync(id); await LoadInventory(); }
    private async Task DeleteCurrentPortfolio() { await PortfolioService.DeleteAccountAsync(currentPortfolioId); currentPortfolioId = 0; await LoadPortfolios(); }

    private void OnTypeChanged() { selectedKindString = ""; FilterItems(); }
    private void SelectRarityFilter(string r) { selectedRarity = r; isRarityFilterOpen = false; FilterItems(); }
    private void SelectAddCollection(int id) { selectedCollectionId = id; isAddCollectionOpen = false; FilterItems(); }

    private void FilterItems()
    {
        var q = allItems.AsEnumerable();
        if (!string.IsNullOrWhiteSpace(searchName)) q = q.Where(i => (i.Name + i.SkinName).Contains(searchName, StringComparison.OrdinalIgnoreCase));
        if (!string.IsNullOrEmpty(selectedTypeString) && Enum.TryParse<ItemType>(selectedTypeString, out var t)) q = q.Where(i => i.Type == t);
        if (!string.IsNullOrEmpty(selectedKindString) && Enum.TryParse<ItemKind>(selectedKindString, out var k)) q = q.Where(i => i.Kind == k);
        if (!string.IsNullOrEmpty(selectedRarity)) q = q.Where(i => i.Rarity.ToString() == selectedRarity); if (selectedCollectionId > 0) q = q.Where(i => i.CollectionId == selectedCollectionId);
        if (isStatTrackFilter) q = q.Where(i => i.IsStatTrack); if (isPatternFilter) q = q.Where(i => i.IsPattern); filteredItems = q.OrderBy(i => i.Name).Take(50).ToList();
    }

    private void CloseCustomization() { isCustomizing = false; currentCustomizingItem = null; }
    private void SelectSlot(int index) { activeSlot = index; }
    private void RemoveAttachment(int index) { var ex = currentAttachments.FirstOrDefault(x => x.SlotPosition == index); if (ex != null) currentAttachments.Remove(ex); }

    private IEnumerable<ItemBase> GetAvailableAttachments()
    {
        if (activeSlot == -1) return Enumerable.Empty<ItemBase>();
        var q = allItems.AsEnumerable(); if (activeSlot == 5) q = q.Where(x => x.Type == ItemType.Charm); else q = q.Where(x => x.Type == ItemType.Sticker); if (!string.IsNullOrWhiteSpace(attachmentSearch)) q = q.Where(x => x.Name.Contains(attachmentSearch, StringComparison.OrdinalIgnoreCase) || x.SkinName.Contains(attachmentSearch, StringComparison.OrdinalIgnoreCase));
        return q.Take(20);
    }
    private void ApplyAttachment(ItemBase item) { RemoveAttachment(activeSlot); currentAttachments.Add(new AppliedAttachment { StickerId = item.Id, Sticker = item, SlotPosition = activeSlot, InventoryItemId = currentCustomizingItem!.Id }); if (activeSlot >= 1 && activeSlot < 4) activeSlot++; }
    private async Task SaveCustomization() { if (currentCustomizingItem == null) return; await PortfolioService.SaveAttachmentsAsync(currentCustomizingItem.Id, currentAttachments); isCustomizing = false; await LoadInventory(); ToastService.ShowToast("Крафт сохранен!", ToastLevel.Success); }
    private async Task DetachCharm() { var ch = currentAttachments.FirstOrDefault(x => x.SlotPosition == 5); if (ch == null || currentCustomizingItem == null) return; await PortfolioService.AddPurchaseAsync(new InventoryItem { ItemBaseId = ch.StickerId, PortfolioAccountId = currentCustomizingItem.PortfolioAccountId, PurchasePrice = 0, Quantity = 1, PurchaseDate = DateTime.Now }); currentAttachments.Remove(ch); await SaveCustomization(); ToastService.ShowToast("Брелок снят в инвентарь", ToastLevel.Info); }
    private void DeleteCharm() { var ch = currentAttachments.FirstOrDefault(x => x.SlotPosition == 5); if (ch != null) currentAttachments.Remove(ch); }

    private decimal CalculateCurrentCraftValue() => CalculateCraftAddedValue(new InventoryItem { Attachments = currentAttachments });

    private string GetDisplayColorClass(ItemBase item) { if (item.Type == ItemType.Container && (item.Kind == ItemKind.Case || item.Kind == ItemKind.StickerPack || item.Kind == ItemKind.CharmPack || item.Kind == ItemKind.GraffitiPack)) return "text-nameless"; return GetRarityClass(item.Rarity); }
    private string GetRarityClass(ItemRarity r) => r switch { ItemRarity.Common => "text-common", ItemRarity.Uncommon => "text-uncommon", ItemRarity.Rare => "text-rare", ItemRarity.Epic => "text-epic", ItemRarity.Legendary => "text-legendary", ItemRarity.Arcane => "text-arcane", ItemRarity.Nameless => "text-nameless", _ => "text-dark" };
    private string GetRarityBgClass(ItemRarity r) => r switch { ItemRarity.Common => "bg-common", ItemRarity.Uncommon => "bg-uncommon", ItemRarity.Rare => "bg-rare", ItemRarity.Epic => "bg-epic", ItemRarity.Legendary => "bg-legendary", ItemRarity.Arcane => "bg-arcane", ItemRarity.Nameless => "bg-nameless", _ => "bg-light" };
}