@page "/portfolio"
@using StandoffPortfolioTracker.Core.Entities
@using StandoffPortfolioTracker.AdminPanel.Services
@inject PortfolioService PortfolioService
@inject ItemService ItemService
@rendermode InteractiveServer

<h3>💼 Мой Инвестиционный Портфель</h3>

<div class="row">
    <div class="col-md-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">Новая покупка</div>
            <div class="card-body">
                <EditForm Model="@newItem" OnValidSubmit="HandleBuy">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <label>Что купил?</label>
                        <InputSelect @bind-Value="newItem.ItemBaseId" class="form-select">
                            <option value="0">-- Выбери скин --</option>
                            @if (availableItems != null)
                            {
                                @foreach (var item in availableItems)
                                {
                                    <option value="@item.Id">@item.Name @item.SkinName</option>
                                }
                            }
                        </InputSelect>
                    </div>

                    <div class="mb-3">
                        <label>Цена закупки (G)</label>
                        <InputNumber @bind-Value="newItem.PurchasePrice" class="form-control" />
                        <small class="text-muted">За одну штуку</small>
                    </div>

                    <div class="mb-3">
                        <label>Количество</label>
                        <InputNumber @bind-Value="newItem.Quantity" class="form-control" />
                    </div>

                    <button type="submit" class="btn btn-success w-100">Добавить в портфель</button>
                </EditForm>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header">
                Мои Активы
            </div>
            <div class="card-body">
                @if (inventory == null)
                {
                    <p>Загрузка...</p>
                }
                else if (!inventory.Any())
                {
                    <div class="alert alert-info">Портфель пуст. Добавь первую покупку!</div>
                }
                else
                {
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Фото</th>
                                <th>Предмет</th>
                                <th>Вложено</th>
                                <th>Сейчас (с ком.)</th>
                                <th>Профит</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invItem in inventory)
                            {
                                // --- МАТЕМАТИКА ---
                                var marketPrice = invItem.ItemBase?.CurrentMarketPrice ?? 0;
                                var totalBuy = invItem.PurchasePrice * invItem.Quantity;

                                // Комиссия рынка 20% (получаем 0.8 от цены)
                                var sellPriceOne = marketPrice * 0.8m;
                                var totalSell = sellPriceOne * invItem.Quantity;

                                var profit = totalSell - totalBuy;
                                var profitPercent = totalBuy > 0 ? (profit / totalBuy) * 100 : 0;

                                // Цвета
                                var profitClass = profit >= 0 ? "text-success" : "text-danger";
                                var sign = profit > 0 ? "+" : "";

                                <tr>
                                    <td>
                                        @if (!string.IsNullOrEmpty(invItem.ItemBase?.ImageUrl))
                                        {
                                            <img src="@invItem.ItemBase.ImageUrl" alt="skin"
                                                 style="width: 50px; height: 50px; object-fit: contain;" />
                                        }
                                        else
                                        {
                                            <div style="width: 50px; height: 50px; background: #eee; border-radius: 4px;"></div>
                                        }
                                    </td>
                                    <td>
                                        <strong>@invItem.ItemBase?.Name</strong>
                                        <div class="small text-muted">@invItem.ItemBase?.SkinName</div>
                                        <span class="badge bg-secondary">@invItem.Quantity шт.</span>
                                    </td>
                                    <td>
                                        <div>@invItem.PurchasePrice.ToString("N2") G</div>
                                        <small class="text-muted">Всего: @totalBuy.ToString("N0")</small>
                                    </td>
                                    <td>
                                        <div>@marketPrice.ToString("N2") G</div>
                                        <small class="text-muted">Чистыми: @totalSell.ToString("N0")</small>
                                    </td>
                                    <td class="@profitClass">
                                        <div class="fw-bold">@sign@profit.ToString("N2") G</div>
                                        <small>@sign@profitPercent.ToString("N1")%</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => Delete(invItem.Id)">
                                            🗑
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<ItemBase> availableItems = new();
    private List<InventoryItem> inventory = new();
    private InventoryItem newItem = new() { Quantity = 1 };

    protected override async Task OnInitializedAsync()
    {
        // Загружаем список для выпадающего меню
        availableItems = await ItemService.GetAllItemsAsync();
        // Загружаем портфель
        await LoadInventory();
    }

    private async Task LoadInventory()
    {
        // Хардкод ID аккаунта = 1 (пока нет авторизации)
        inventory = await PortfolioService.GetInventoryAsync(1);
    }

    private async Task HandleBuy()
    {
        if (newItem.ItemBaseId == 0) return;

        newItem.PortfolioAccountId = 1;
        newItem.PurchaseDate = DateTime.Now;

        await PortfolioService.AddPurchaseAsync(newItem);

        // Сброс полей
        newItem = new InventoryItem { Quantity = 1, PurchasePrice = 0 };
        await LoadInventory();
    }

    private async Task Delete(int id)
    {
        await PortfolioService.DeleteItemAsync(id);
        await LoadInventory();
    }
}