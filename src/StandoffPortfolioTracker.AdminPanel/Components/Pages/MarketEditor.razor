@page "/market-editor"
@using Microsoft.AspNetCore.Authorization
@using StandoffPortfolioTracker.Core.Entities
@using StandoffPortfolioTracker.Core.Enums
@using StandoffPortfolioTracker.AdminPanel.Services
@attribute [Authorize(Roles = "Admin")]
@inject ItemService ItemService
@inject PriceParserService ParserService
@inject WikiParserService WikiService
@rendermode InteractiveServer

<style>
    /* Стили для редкости */
    .rarity-common {
        background-color: #B0C3D9;
        color: #333;
    }

    .rarity-uncommon {
        background-color: #5E98D9;
        color: #fff;
    }

    .rarity-rare {
        background-color: #4B69FF;
        color: #fff;
    }

    .rarity-epic {
        background-color: #8847FF;
        color: #fff;
    }

    .rarity-legendary {
        background-color: #D32CE6;
        color: #fff;
    }

    .rarity-arcane {
        background-color: #EB4B4B;
        color: #fff;
    }

    .rarity-nameless {
        background: linear-gradient(45deg, #FFD700, #FDB931);
        color: #333;
        border: 1px solid #d4af37;
    }

    /* === Text Colors for Dropdowns === */
    .text-common {
        color: #8a99a8;
    }

    .text-uncommon {
        color: #5E98D9;
    }

    .text-rare {
        color: #4B69FF;
    }

    .text-epic {
        color: #8847FF;
    }

    .text-legendary {
        color: #D32CE6;
    }

    .text-arcane {
        color: #EB4B4B;
    }

    .text-nameless {
        color: #e0a800;
        font-weight: bold;
    }

    /* === Background Dots for Dropdowns === */
    .bg-common {
        background-color: #B0C3D9;
    }

    .bg-uncommon {
        background-color: #5E98D9;
    }

    .bg-rare {
        background-color: #4B69FF;
    }

    .bg-epic {
        background-color: #8847FF;
    }

    .bg-legendary {
        background-color: #D32CE6;
    }

    .bg-arcane {
        background-color: #EB4B4B;
    }

    .bg-nameless {
        background: linear-gradient(45deg, #FFD700, #FDB931);
    }

    .rarity-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }

    /* === Custom Dropdowns === */
    .custom-select-trigger {
        cursor: pointer;
        border: 1px solid #ced4da;
        padding: 4px 10px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        min-height: 31px;
        font-size: 0.875rem;
    }

        .custom-select-trigger:hover {
            background-color: #f8f9fa;
            border-color: #b6babc;
        }

    .custom-dropdown-menu {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        z-index: 1050;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-radius: 4px;
        margin-top: 2px;
    }

        .custom-dropdown-menu.show {
            display: block;
        }

    .dropdown-item-custom {
        padding: 6px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.875rem;
    }

        .dropdown-item-custom:hover {
            background-color: #e9ecef;
        }

    /* === Toggle Buttons === */
    .btn-check:checked + .btn-outline-warning {
        background-color: #ffc107;
        color: #000;
        border-color: #ffc107;
    }

    .btn-check:checked + .btn-outline-info {
        background-color: #0dcaf0;
        color: #fff;
        border-color: #0dcaf0;
    }

    /* === General === */
    .price-input {
        width: 100px !important;
        text-align: right;
    }

    .selected-row {
        background-color: #e9ecef !important;
        border-left: 4px solid #0d6efd;
    }

    .collection-img-sm {
        width: 20px;
        height: 20px;
        object-fit: contain;
    }

    .collection-btn-active {
        background-color: #e2e6ea;
        border-color: #6c757d;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1050;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>🛒 Справочник Предметов (Admin)</h3>
        <div>
            <button class="btn btn-outline-secondary me-2" @onclick="ToggleCollections">📁 Коллекции</button>
            <button class="btn btn-success" @onclick="CreateNewItem">➕ Создать</button>
        </div>
    </div>

    <div class="card mb-3 border-warning">
        <div class="card-body py-2 d-flex justify-content-between align-items-center">
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-danger" @onclick="RunImport" disabled="@isBusy">
                    @if (isBusy && currentAction == "import")
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                    }
                    else
                    {
                        <span>🌍 Импорт (API)</span>
                    }
                </button>
                <button class="btn btn-sm btn-dark ms-2" @onclick="DebugApi" disabled="@isBusy">
                    @if (isBusy && currentAction == "debug")
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                    }
                    else
                    {
                        <span>🐞 API Check</span>
                    }
                </button>
                <button class="btn btn-sm btn-primary" @onclick="RunParser" disabled="@isBusy">
                    @if (isBusy && currentAction == "parse")
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                    }
                    else
                    {
                        <span>💲 Цены</span>
                    }
                </button>
                <button class="btn btn-warning text-dark" @onclick="FixImages" disabled="@isBusy">
                    @if (isBusy && currentAction == "images")
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                    }
                    else
                    {
                        <span>🖼️ PNG</span>
                    }
                </button>
            </div>
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <span class="text-success small fw-bold">@statusMessage</span>
            }
        </div>
    </div>

    <div class="card mb-3 border-info">
        <div class="card-header bg-info text-white py-1"><small>📥 Парсинг с Wiki</small></div>
        <div class="card-body py-2">
            <div class="input-group input-group-sm">
                <input type="text" class="form-control" placeholder="Ссылка Wiki..." @bind="wikiUrl" />
                <select class="form-select" @bind="wikiCollectionId" style="max-width: 200px;">
                    <option value="0">Коллекция...</option>
                    @foreach (var c in collections)
                    {
                        <option value="@c.Id">@c.Name</option>
                    }
                </select>
                <button class="btn btn-info text-white" @onclick="ParseWiki" disabled="@(isBusy || wikiCollectionId == 0)">🚀</button>
            </div>
        </div>
    </div>

    @if (showCollections)
    {
        <div class="card mb-3 border-info shadow">
            <div class="card-header bg-info text-white d-flex justify-content-between py-1 align-items-center">
                <span>📁 Редактор коллекций</span>
                <button class="btn-close btn-close-white" @onclick="ToggleCollections"></button>
            </div>
            <div class="card-body bg-light">
                <div class="row g-2 mb-3 align-items-end">
                    <div class="col-md-3"><input type="text" class="form-control form-control-sm" placeholder="Название" @bind="newColName" /></div>
                    <div class="col-md-4"><input type="text" class="form-control form-control-sm" placeholder="URL иконки" @bind="newColImage" /></div>
                    <div class="col-md-3">
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="isRemoved" @bind="newColIsRemoved" /><label class="form-check-label small" for="isRemoved">⛔ Removed</label></div>
                    </div>
                    <div class="col-md-2"><button class="btn btn-success btn-sm w-100" @onclick="SaveCollection">Сохранить</button></div>
                </div>
                <div class="d-flex flex-wrap gap-2" style="max-height: 150px; overflow-y: auto;">
                    @foreach (var c in collections)
                    {
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary d-flex align-items-center gap-2 @(editingCol?.Id == c.Id ? "collection-btn-active" : "")" @onclick="() => EditCollection(c)">
                                @if (!string.IsNullOrEmpty(c.ImageUrl))
                                {
                                    <img src="@c.ImageUrl" class="collection-img-sm" referrerpolicy="no-referrer" />
                                }
                                <span>@c.Name</span>
                            </button>
                            <button class="btn btn-outline-danger" @onclick="() => DeleteCollection(c.Id)">✕</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light p-2">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-3">
                            <input type="text" class="form-control form-control-sm" placeholder="🔍 Поиск..." @bind="searchQuery" @bind:event="oninput" @onkeyup="ResetAndLoad" />
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" @bind="filterType" @bind:after="ResetAndLoad">
                                <option value="">Все типы</option>
                                @foreach (var t in Enum.GetValues(typeof(ItemType)))
                                {
                                    <option value="@t">@t</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-2 position-relative">
                            <div class="custom-select-trigger" @onclick="() => isHeaderRarityOpen = !isHeaderRarityOpen">
                                @if (!filterRarity.HasValue)
                                {
                                    <span class="text-muted">Все редкости</span>
                                }
                                else
                                {
                                    <div class="d-flex align-items-center">
                                        <span class="rarity-dot @GetRarityBgClass(filterRarity.Value)"></span>
                                        <span class="fw-bold @GetRarityTextClass(filterRarity.Value)">@filterRarity</span>
                                    </div>
                                }
                                <span class="small ms-1">▼</span>
                            </div>
                            <div class="custom-dropdown-menu @(isHeaderRarityOpen ? "show" : "")">
                                <div class="dropdown-item-custom" @onclick="() => SetHeaderRarity(null)">Все</div>
                                @foreach (var r in Enum.GetValues(typeof(ItemRarity)).Cast<ItemRarity>())
                                {
                                    <div class="dropdown-item-custom" @onclick="() => SetHeaderRarity(r)">
                                        <span class="rarity-dot @GetRarityBgClass(r)"></span>
                                        <span class="@GetRarityTextClass(r)">@r</span>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="col-md-2 position-relative">
                            <div class="custom-select-trigger" @onclick="() => isHeaderCollectionOpen = !isHeaderCollectionOpen">
                                @if (filterCollection == 0)
                                {
                                    <span class="text-muted">Все коллекции</span>
                                }
                                else
                                {
                                    var c = collections.FirstOrDefault(x => x.Id == filterCollection);
                                    <div class="d-flex align-items-center gap-2 text-truncate">
                                        @if (!string.IsNullOrEmpty(c?.ImageUrl))
                                        {
                                            <img src="@c.ImageUrl" class="collection-img-sm" referrerpolicy="no-referrer" />
                                        }
                                        <span>@c?.Name</span>
                                    </div>
                                }
                                <span class="small ms-1">▼</span>
                            </div>
                            <div class="custom-dropdown-menu @(isHeaderCollectionOpen ? "show" : "")">
                                <div class="dropdown-item-custom" @onclick="() => SetHeaderCollection(0)">Все коллекции</div>
                                @foreach (var c in collections)
                                {
                                    <div class="dropdown-item-custom" @onclick="() => SetHeaderCollection(c.Id)">
                                        @if (!string.IsNullOrEmpty(c.ImageUrl))
                                        {
                                            <img src="@c.ImageUrl" class="collection-img-sm" referrerpolicy="no-referrer" />
                                        }
                                        <span>@c.Name</span>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="col-md-3 d-flex gap-1 justify-content-end">
                            <input type="checkbox" class="btn-check" id="btn-check-st" autocomplete="off" @bind="filterStatTrack" @bind:after="ResetAndLoad">
                            <label class="btn btn-sm btn-outline-warning fw-bold" for="btn-check-st" title="StatTrack Only">ST</label>

                            <input type="checkbox" class="btn-check" id="btn-check-pt" autocomplete="off" @bind="filterPattern" @bind:after="ResetAndLoad">
                            <label class="btn btn-sm btn-outline-info fw-bold" for="btn-check-pt" title="Pattern Only">P</label>

                            <div class="text-muted small align-self-center ms-2">@totalItems шт.</div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive flex-grow-1">
                    <table class="table table-hover align-middle table-sm mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th width="50">Фото</th>
                                <th>Название</th>
                                <th>Редкость / Подтип</th>
                                <th class="text-end">Цена (G)</th>
                                <th width="40"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (items == null)
                            {
                                <tr><td colspan="5" class="text-center p-3">Загрузка...</td></tr>
                            }
                            else
                            {
                                foreach (var item in items)
                                {
                                    <tr class="@(selectedItem?.Id == item.Id ? "selected-row" : "")" @onclick="() => SelectItem(item)" style="cursor: pointer;">
                                        <td class="text-center">
                                            @if (!string.IsNullOrEmpty(item.ImageUrl))
                                            {
                                                <img src="@item.ImageUrl" referrerpolicy="no-referrer" style="width: 40px; height: 40px; object-fit: contain;" />
                                            }
                                            else
                                            {
                                                <small class="text-muted">?</small>
                                            }
                                        </td>
                                        <td>
                                            <div class="fw-bold text-truncate" style="max-width: 250px;">
                                                @if (item.IsStatTrack)
                                                {
                                                    <span class="badge bg-warning text-dark me-1" style="font-size: 0.6em;">ST</span>
                                                }
                                                @if (item.IsPattern)
                                                {
                                                    <span class="badge bg-info text-white me-1" style="font-size: 0.6em;">P</span>
                                                }
                                                @item.Name
                                            </div>
                                            <div class="d-flex align-items-center gap-2 small text-muted">
                                                <span>@item.SkinName</span>
                                                @if (item.CollectionId > 1 && item.Collection != null)
                                                {
                                                    <span class="badge bg-light text-dark border d-flex align-items-center gap-1 px-1 py-0">
                                                        @if (!string.IsNullOrEmpty(item.Collection.ImageUrl))
                                                        {
                                                            <img src="@item.Collection.ImageUrl" referrerpolicy="no-referrer" style="width: 12px;" />
                                                        }
                                                        @item.Collection.Name
                                                    </span>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            @if (item.Type == ItemType.Container)
                                            {
                                                <span class="badge @GetContainerDisplayClass(item)">@item.Kind</span>
                                            }
                                            else
                                            {
                                                <span class="badge @GetRarityBadgeClass(item.Rarity)">@item.Rarity</span>
                                            }
                                            <div class="small text-muted mt-1">@item.Type</div>
                                        </td>
                                        <td class="text-end">
                                            <input type="number" step="0.01" class="form-control form-control-sm d-inline-block price-input"
                                                   value="@item.CurrentMarketPrice.ToString("F2").Replace(",", ".")"
                                                   @onchange="@(e => UpdatePrice(item, e.Value))" @onclick:stopPropagation="true" />
                                        </td>
                                        <td>✏️</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <div class="card-footer py-1 d-flex justify-content-between align-items-center">
                    <button class="btn btn-sm btn-secondary" disabled="@(currentPage == 1)" @onclick="PrevPage">←</button>
                    <span class="small">Стр. @currentPage</span>
                    <button class="btn btn-sm btn-secondary" disabled="@(items?.Count < pageSize)" @onclick="NextPage">→</button>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow border-primary" style="position: sticky; top: 90px; max-height: calc(100vh - 110px); overflow-y: auto;">
                <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                    <span>@(selectedItem.Id == 0 ? "Новый предмет" : "Редактирование")</span>
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm text-white"></span>
                    }
                    else
                    {
                        <span class="small">Saved ✓</span>
                    }
                </div>
                <div class="card-body">
                    <EditForm Model="@selectedItem">
                        <div class="text-center mb-2 position-relative">
                            @if (!string.IsNullOrEmpty(selectedItem.ImageUrl))
                            {
                                <img src="@selectedItem.ImageUrl" referrerpolicy="no-referrer" class="img-thumbnail" style="height: 120px; object-fit: contain;" />
                            }
                            <div class="mt-1"><input type="text" class="form-control form-control-sm small text-muted" placeholder="Ссылка на фото" @bind="selectedItem.ImageUrl" @bind:after="AutoSave" /></div>
                        </div>

                        <div class="mb-2"><label class="small text-muted mb-0">Название</label><input type="text" class="form-control form-control-sm fw-bold" @bind="selectedItem.Name" @bind:after="AutoSave" /></div>
                        <div class="mb-2"><label class="small text-muted mb-0">Скин</label><input type="text" class="form-control form-control-sm" @bind="selectedItem.SkinName" @bind:after="AutoSave" /></div>

                        <div class="row g-2 mb-2">
                            <div class="col-4">
                                <label class="small text-muted mb-0">Тип</label>
                                <select @bind="selectedItem.Type" class="form-select form-select-sm" @bind:after="AutoSave">
                                    @foreach (var t in Enum.GetValues(typeof(ItemType)))
                                    {
                                        <option value="@t">@t</option>
                                    }
                                </select>
                            </div>
                            <div class="col-4">
                                <label class="small text-muted mb-0">Подтип</label>
                                <select @bind="selectedItem.Kind" class="form-select form-select-sm" @bind:after="AutoSave">
                                    @foreach (var k in Enum.GetValues(typeof(ItemKind)))
                                    {
                                        <option value="@k">@k</option>
                                    }
                                </select>
                            </div>
                            <div class="col-4 position-relative">
                                <label class="small text-muted mb-0">Редкость</label>
                                <div class="custom-select-trigger" @onclick="() => isFormRarityOpen = !isFormRarityOpen">
                                    <div class="d-flex align-items-center" style="overflow:hidden">
                                        <span class="rarity-dot @GetRarityBgClass(selectedItem.Rarity)"></span>
                                        <span class="text-truncate">@selectedItem.Rarity</span>
                                    </div>
                                    <span class="small ms-1">▼</span>
                                </div>
                                <div class="custom-dropdown-menu @(isFormRarityOpen ? "show" : "")">
                                    @foreach (var r in Enum.GetValues(typeof(ItemRarity)).Cast<ItemRarity>())
                                    {
                                        <div class="dropdown-item-custom" @onclick="() => SetFormRarity(r)">
                                            <span class="rarity-dot @GetRarityBgClass(r)"></span>
                                            <span class="@GetRarityTextClass(r)">@r</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="mb-2 position-relative">
                            <label class="small text-muted mb-0">Коллекция</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" placeholder="Поиск..." @bind="collectionSearchQuery" @bind:event="oninput" @onfocus="() => isCollectionDropdownOpen = true" @onfocusout="CloseCollectionDropdownDelayed" />
                                @if (selectedItem.CollectionId > 1)
                                {
                                    <button class="btn btn-outline-secondary" type="button" @onclick="ClearCollectionSelection">✕</button>
                                }
                            </div>
                            @if (isCollectionDropdownOpen)
                            {
                                <div class="autocomplete-dropdown shadow-sm">
                                    @if (!FilteredCollections.Any())
                                    {
                                        <div class="p-2 text-muted small">Ничего не найдено</div>
                                    }
                                    else
                                    {
                                        @foreach (var col in FilteredCollections)
                                        {
                                            <div class="autocomplete-item d-flex align-items-center gap-2" @onmousedown="() => SelectCollectionFromSearch(col)">
                                                @if (!string.IsNullOrEmpty(col.ImageUrl))
                                                {
                                                    <img src="@col.ImageUrl" referrerpolicy="no-referrer" style="width: 20px;" />
                                                }
                                                <span class="small">@col.Name</span>
                                            </div>
                                        }
                                    }
                                </div>
                            }
                            @if (selectedItem.CollectionId > 1)
                            {
                                var current = collections.FirstOrDefault(c => c.Id == selectedItem.CollectionId);
                                <div class="mt-1 small text-success">Выбрано: <strong>@current?.Name</strong></div>
                            }
                        </div>

                        <div class="card bg-light p-2 mb-2 border-0">
                            <div class="form-check form-switch mb-1">
                                <input type="checkbox" class="form-check-input" id="st" @bind="selectedItem.IsStatTrack" @bind:after="AutoSave" />
                                <label class="form-check-label small" for="st">StatTrack™</label>
                            </div>
                            <div class="form-check form-switch">
                                <input type="checkbox" class="form-check-input" id="pt" @bind="selectedItem.IsPattern" @bind:after="AutoSave" />
                                <label class="form-check-label small" for="pt">Pattern Based</label>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-3">
                            @if (selectedItem.Id == 0)
                            {
                                <button type="button" class="btn btn-success btn-sm" @onclick="CreateItemManually">Создать</button>
                            }
                            else
                            {
                                <button type="button" class="btn btn-outline-danger btn-sm" @onclick="DeleteItem">🗑 Удалить</button>
                            }
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<ItemBase> items;
    private List<GameCollection> collections = new();
    private ItemBase selectedItem = new();
    private int totalItems = 0;

    // Filters
    private string searchQuery = "";
    private ItemType? filterType = null;
    private ItemRarity? filterRarity = null;
    private int filterCollection = 0;
    private bool filterStatTrack = false;
    private bool filterPattern = false;
    private int currentPage = 1;
    private const int pageSize = 50;

    // UI state
    private bool isBusy = false;
    private bool isSaving = false;
    private string currentAction = "";
    private string statusMessage = "";
    private bool showCollections = false;
    private bool isHeaderRarityOpen = false;
    private bool isHeaderCollectionOpen = false;
    private bool isFormRarityOpen = false;

    // Collection Manager & Autocomplete
    private string newColName = "";
    private string newColImage = "";
    private bool newColIsRemoved = false;
    private GameCollection? editingCol;
    private string wikiUrl = "";
    private int wikiCollectionId = 0;
    private string collectionSearchQuery = "";
    private bool isCollectionDropdownOpen = false;

    private IEnumerable<GameCollection> FilteredCollections =>
        string.IsNullOrWhiteSpace(collectionSearchQuery) ? collections.Take(10) : collections.Where(c => c.Name.Contains(collectionSearchQuery, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        collections = await ItemService.GetCollectionsAsync();
        CreateNewItemModel();
        await LoadData();
    }

    private async Task LoadData()
    {
        // ⚠️ Ensure ItemService.GetItemsFilteredAsync accepts bool? for ST/Pattern
        var res = await ItemService.GetItemsFilteredAsync(
            (currentPage - 1) * pageSize, pageSize, searchQuery, filterType, filterRarity, filterCollection,
            filterStatTrack ? true : null, filterPattern ? true : null
        );
        items = res.Items;
        totalItems = res.TotalCount;
        StateHasChanged();
    }

    // === Visual Filter Helpers ===
    private void SetHeaderRarity(ItemRarity? r) { filterRarity = r; isHeaderRarityOpen = false; ResetAndLoad(); }
    private void SetHeaderCollection(int id) { filterCollection = id; isHeaderCollectionOpen = false; ResetAndLoad(); }
    private void SetFormRarity(ItemRarity r) { selectedItem.Rarity = r; isFormRarityOpen = false; AutoSave(); }

    // === Selection & CRUD ===
    private void SelectItem(ItemBase item) { selectedItem = item; var col = collections.FirstOrDefault(c => c.Id == item.CollectionId); collectionSearchQuery = col != null && col.Id > 1 ? col.Name : ""; }
    private void CreateNewItemModel() { selectedItem = new ItemBase { CollectionId = 1, Type = ItemType.Guns, Kind = ItemKind.None, Rarity = ItemRarity.Common }; collectionSearchQuery = ""; }
    private void CreateNewItem() { CreateNewItemModel(); isSaving = false; }
    private async Task AutoSave() { if (selectedItem.Id == 0) return; isSaving = true; StateHasChanged(); try { var newCol = collections.FirstOrDefault(c => c.Id == selectedItem.CollectionId); if (newCol != null) selectedItem.Collection = newCol; await ItemService.UpdateItemAsync(selectedItem); } catch (Exception ex) { statusMessage = "Ошибка: " + ex.Message; } await Task.Delay(300); isSaving = false; StateHasChanged(); }
    private async Task CreateItemManually() { await ItemService.AddItemAsync(selectedItem); await LoadData(); }
    private async Task DeleteItem() { if (selectedItem.Id == 0) return; await ItemService.DeleteItemAsync(selectedItem.Id); CreateNewItemModel(); await LoadData(); }
    private async Task UpdatePrice(ItemBase item, object val) { if (decimal.TryParse(val?.ToString()?.Replace(".", ","), out decimal p)) { item.CurrentMarketPrice = p; await ItemService.UpdateItemAsync(item); } }

    // === Autocomplete & Collections ===
    private async Task SelectCollectionFromSearch(GameCollection col) { selectedItem.CollectionId = col.Id; selectedItem.Collection = col; collectionSearchQuery = col.Name; isCollectionDropdownOpen = false; await AutoSave(); }
    private async Task ClearCollectionSelection() { selectedItem.CollectionId = 1; var defaultCol = collections.FirstOrDefault(c => c.Id == 1); if (defaultCol != null) selectedItem.Collection = defaultCol; collectionSearchQuery = ""; await AutoSave(); }
    private async Task CloseCollectionDropdownDelayed() { await Task.Delay(200); isCollectionDropdownOpen = false; }
    private void ToggleCollections() => showCollections = !showCollections;
    private void EditCollection(GameCollection c) { editingCol = c; newColName = c.Name; newColImage = c.ImageUrl ?? ""; newColIsRemoved = c.IsRemoved; }
    private void CancelEditCollection() { editingCol = null; newColName = ""; newColImage = ""; newColIsRemoved = false; }
    private async Task SaveCollection() { if (string.IsNullOrWhiteSpace(newColName)) return; var c = editingCol ?? new GameCollection(); c.Name = newColName; c.ImageUrl = newColImage; c.IsRemoved = newColIsRemoved; await ItemService.SaveCollectionAsync(c); collections = await ItemService.GetCollectionsAsync(); CancelEditCollection(); }
    private async Task DeleteCollection(int id) { try { await ItemService.DeleteCollectionAsync(id); collections = await ItemService.GetCollectionsAsync(); } catch (Exception ex) { statusMessage = ex.Message; } }

    // === Parser ===
    private async Task ParseWiki() { if (string.IsNullOrWhiteSpace(wikiUrl) || wikiCollectionId == 0) return; var targetCollection = collections.FirstOrDefault(c => c.Id == wikiCollectionId); if (targetCollection == null) return; isBusy = true; currentAction = "wiki"; statusMessage = $"Парсим Вики..."; try { statusMessage = await WikiService.ParseCollectionFromWikiUrl(wikiUrl, targetCollection.Name); await LoadData(); collections = await ItemService.GetCollectionsAsync(); } catch (Exception ex) { statusMessage = "Ошибка: " + ex.Message; } isBusy = false; currentAction = ""; }
    private async Task FixImages() { isBusy = true; currentAction = "images"; statusMessage = "Загружаем картинки..."; try { statusMessage = await ParserService.UpdateImagesFromApiAsync(); await LoadData(); } catch (Exception ex) { statusMessage = "Ошибка: " + ex.Message; } isBusy = false; currentAction = ""; }
    private async Task DebugApi() { isBusy = true; currentAction = "debug"; statusMessage = "API..."; try { statusMessage = await ParserService.DebugDownloadApiDataAsync(); } catch (Exception ex) { statusMessage = "Ошибка: " + ex.Message; } isBusy = false; currentAction = ""; }
    private async Task RunImport() { isBusy = true; currentAction = "import"; try { statusMessage = await ParserService.ImportAllSkinsAsync(); await LoadData(); } catch (Exception ex) { statusMessage = ex.Message; } isBusy = false; }
    private async Task RunParser() { isBusy = true; currentAction = "parse"; try { statusMessage = await ParserService.UpdateAllPricesAsync(); await LoadData(); } catch (Exception ex) { statusMessage = ex.Message; } isBusy = false; }
    private async Task ResetAndLoad() { currentPage = 1; await LoadData(); }
    private async Task NextPage() { currentPage++; await LoadData(); }
    private async Task PrevPage() { if (currentPage > 1) { currentPage--; await LoadData(); } }

    // === Color Helpers ===
    private string GetContainerDisplayClass(ItemBase item)
    {
        if (item.Kind == ItemKind.Box || item.Kind == ItemKind.Crate || item.Kind == ItemKind.Other)
            return GetRarityBadgeClass(item.Rarity);
        return "rarity-nameless";
    }

    private string GetRarityBadgeClass(ItemRarity r) => r switch { ItemRarity.Common => "rarity-common", ItemRarity.Uncommon => "rarity-uncommon", ItemRarity.Rare => "rarity-rare", ItemRarity.Epic => "rarity-epic", ItemRarity.Legendary => "rarity-legendary", ItemRarity.Arcane => "rarity-arcane", ItemRarity.Nameless => "rarity-nameless", _ => "bg-light" };
    private string GetRarityTextClass(ItemRarity r) => r switch { ItemRarity.Common => "text-common", ItemRarity.Uncommon => "text-uncommon", ItemRarity.Rare => "text-rare", ItemRarity.Epic => "text-epic", ItemRarity.Legendary => "text-legendary", ItemRarity.Arcane => "text-arcane", ItemRarity.Nameless => "text-nameless", _ => "text-dark" };
    private string GetRarityBgClass(ItemRarity r) => r switch { ItemRarity.Common => "bg-common", ItemRarity.Uncommon => "bg-uncommon", ItemRarity.Rare => "bg-rare", ItemRarity.Epic => "bg-epic", ItemRarity.Legendary => "bg-legendary", ItemRarity.Arcane => "bg-arcane", ItemRarity.Nameless => "bg-nameless", _ => "bg-light" };
}