@using StandoffPortfolioTracker.AdminPanel.Services
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Threading
@inject ToastService ToastService
@inject GlobalNotificationService GlobalNotifier
@inject AuthenticationStateProvider AuthStateProvider
@implements IDisposable

@* Всегда рендерим контейнер, но управляем классами внутри *@
<div class="toast-custom-container position-fixed top-0 end-0 p-3">
    <div class="toast-card p-3 mb-3 @AnimationClass @LevelClass">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <i class="@IconCss fs-4"></i>
                <div>
                    @* Заголовок опционально, можно убрать *@
                    <strong class="d-block text-dark" style="font-size: 0.9rem;">@LevelTitle</strong>
                    <span class="text-secondary" style="font-size: 0.95rem;">@Message</span>
                </div>
            </div>
            <button type="button" class="btn-close ms-2" @onclick="HideManually"></button>
        </div>

        @* Полоса таймера (показываем только если toast активен) *@
        @if (IsVisible)
        {
            <div class="toast-progress">
                @* 5s - время показа, совпадает с логикой C# *@
                <div class="toast-progress-bar" style="animation-duration: 5000ms;"></div>
            </div>
        }
    </div>
</div>

@code {
    private bool IsVisible; // Логический флаг
    private string AnimationClass => IsVisible ? "show" : "";
    private string Message = string.Empty;
    private ToastLevel Level;
    private string myUserId = "";

    // Для отмены предыдущего таймера, если пришло новое уведомление
    private CancellationTokenSource? _cts;

    protected override async Task OnInitializedAsync()
    {
        ToastService.OnShow += ShowToast;
        ToastService.OnHide += HideToast;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        myUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";

        if (!string.IsNullOrEmpty(myUserId))
        {
            GlobalNotifier.OnNotificationReceived += HandleGlobalNotification;
        }
    }

    private void HandleGlobalNotification(string targetId, string msg, ToastLevel level)
    {
        if (targetId.Equals(myUserId, StringComparison.OrdinalIgnoreCase))
        {
            InvokeAsync(() =>
            {
                ShowToast(msg, level);
                StateHasChanged();
            });
        }
    }

    private void ShowToast(string message, ToastLevel level)
    {
        InvokeAsync(async () =>
        {
            // Если уже есть активный таймер скрытия - отменяем его
            _cts?.Cancel();
            _cts = new CancellationTokenSource();
            var token = _cts.Token;

            Message = message;
            Level = level;
            IsVisible = true;
            StateHasChanged();

            try
            {
                // Ждем 5 секунд перед авто-скрытием
                await Task.Delay(5000, token);

                // Если задача не была отменена (не пришло новое уведомление)
                if (!token.IsCancellationRequested)
                {
                    HideToast();
                }
            }
            catch (TaskCanceledException)
            {
                // Игнорируем отмену, так как это штатная ситуация при быстрой смене уведомлений
            }
        });
    }

    private void HideToast()
    {
        InvokeAsync(async () =>
        {
            IsVisible = false;
            StateHasChanged();
            // Ждем завершения CSS анимации (0.4s), прежде чем (опционально) очистить данные
            // Но в данном дизайне элемент остается в DOM просто прозрачным, это нормально.
            await Task.Delay(400);
        });
    }

    private void HideManually()
    {
        _cts?.Cancel(); // Останавливаем таймер автоскрытия
        HideToast();
    }

    private string LevelClass => Level switch
    {
        ToastLevel.Info => "toast-info",
        ToastLevel.Success => "toast-success",
        ToastLevel.Warning => "toast-warning",
        ToastLevel.Error => "toast-error",
        _ => "toast-info"
    };

    private string LevelTitle => Level switch
    {
        ToastLevel.Info => "Информация",
        ToastLevel.Success => "Успешно",
        ToastLevel.Warning => "Внимание",
        ToastLevel.Error => "Ошибка",
        _ => "Уведомление"
    };

    private string IconCss => Level switch
    {
        ToastLevel.Info => "bi bi-info-circle-fill",
        ToastLevel.Success => "bi bi-check-circle-fill",
        ToastLevel.Warning => "bi bi-exclamation-triangle-fill",
        ToastLevel.Error => "bi bi-x-circle-fill",
        _ => "bi bi-info-circle-fill"
    };

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
        ToastService.OnShow -= ShowToast;
        ToastService.OnHide -= HideToast;
        GlobalNotifier.OnNotificationReceived -= HandleGlobalNotification;
    }
}